# 雑記帳

- [このリポジトリの使い方](articles/0192bc26-0274-7afd-884e-2b1c281803c2/README.md)
- [Windows Terminalでtmuxを起動するワークアラウンド](articles/0192bc2f-0917-7ea9-a216-050a39e24dc5/README.md)
- [Vimの正規表現の先読み・後読み](articles/0192bc81-e319-7600-95b6-4b1decd06e27/README.md)
- [Scribusを経由して印刷仕様のPDFを出力する](articles/0192bc82-be64-76fe-8d1a-cf40d8377fad/README.md)
- [mintty.exeでWSLを起動する](articles/0192bc83-270f-7de8-9497-3bbc28d5affa/README.md)
- [MSYS2にいつも入れてるもの](articles/0192bc83-5780-76f8-a69d-4cf519b25b4f/README.md)
- [JScriptをバッチファイルに埋め込む（Shebangもどき）](articles/0192bc83-a5de-7ad6-9632-21f469ff6e5a/README.md)
- [WSL2のNode.jsにPlaywrightでChrome入れたけど動かん](articles/0192bc85-588a-7e31-9e2f-6364e42152b1/README.md)
- [Invoke-WebRequestのリダイレクトをトレースしたい（wip）](articles/0192bc85-79d4-7bfd-99c3-45282a4fb244/README.md)
- [ワーキングディレクトリ内のファイル名がある正規表現にマッチするファイルから、ある正規表現にマッチする行を抽出する on WSL](articles/0192bc85-ccc7-778e-8615-fb5c0e424eba/README.md)
- [シンボリックリンクを含むGitリポジトリ](articles/0192bc86-b1bb-7a96-b096-ec7e994ce895/README.md)
- [PDF切り出しに使うTeXのテンプレート](articles/0192bc87-2614-7d9a-9d53-ab3ba166e71b/README.md)
- [カレントディレクトリ以下のPNG画像をJPGに変換する](articles/0192bc87-6e0d-7670-8897-90c2e79490ae/README.md)
- [PSoC 4ハードウェア設計上の注意事項](articles/0192bc87-e358-7964-8446-a721b0b89fcf/README.md)
- [ES3相当のJavaScriptでUUID風文字列を生成する](articles/0192bc88-03ef-7d7f-8c08-6c0d12074c54/README.md)
- [PDFの指定したページをトリミングして出力](articles/0192bc89-1b1d-7c66-b6ad-9cc47c17acc2/README.md)
- [WSLのディスクサイズを削減](articles/0192bc8a-4a12-77fc-964d-f225677966f8/README.md)
- [MSYS2環境を現在のターミナルで開く](articles/0192bc8c-6edd-7651-9e5c-5791658a2064/README.md)
- [MarkdownのテーブルをHTMLに置換](articles/0192bc8e-04de-7648-ade2-e0ccaf7d2033/README.md)
- [WindowsのセットアップをMSアカウントなしで行う](articles/0192bc8e-8d00-7033-9b50-61f3bbfe0647/README.md)
- [現在のPowerShellセッションにMSYS2のパスを追加](articles/0192bc8e-ff23-7bb9-97c5-075aeaacd9f0/README.md)
- [ChatGPTにプロジェクトのファイル全部食わせる](articles/0192bc8f-8faf-7263-b196-60026e00296e/README.md)
- [追跡中のすべてのC言語ファイルにフォーマッタをかける](articles/0192bc90-fd9a-7d6a-aa08-69ffbf1b77db/README.md)
- [WSL2にデスクトップを生やす](articles/0192bc91-5a09-729c-ad7d-fb412cdaadd6/README.md)
- [VirtualBoxの右上に出てくる通知センターを消す](articles/0192bc91-ba73-7ede-b781-43c03d683761/README.md)
- [VirtualBoxのディスクイメージの履歴をクリアする](articles/0192bc92-24e5-7906-983b-c4e2fbbfdf27/README.md)
- [MSYS2でddrescueのビルド](articles/0192bc92-6cbe-717a-a64b-e4558161e869/README.md)
- [tmux](articles/0192bc92-b5df-7541-a355-dc1ee54c4be2/README.md)
- [GNU Screen 4.9.1のビルド](articles/0192bc93-21f7-78d1-adcf-32e5b10a9268/README.md)
- [C言語の規格書](articles/0192bc93-fea7-738e-8373-9d5d64a9e45c/README.md)
- [MSYS2シェル内でvimを開くとき](articles/0192bc94-3f7c-7af9-a4f3-e913e49c66fd/README.md)
- [PythonスクリプトでGUIのファイル選択ウィンドウを出す](articles/0192bc94-7ec4-7485-857c-e7740ef2f251/README.md)
- [Ghostscriptの`inkcov`と`ink_cov`](articles/0192bc94-cecb-7136-946e-b166c175a9a5/README.md)
- [JapanColor2001Coated.icc](articles/0192bc95-5738-7898-91eb-52f419a9a534/README.md)
- [qpdf](articles/0192bc95-8b91-7727-8e89-ec30b9c57400/README.md)
- [PlatformIO+Arduino-Picoの更新](articles/0192bc95-c61c-744d-ac0f-76d28bc30d3b/README.md)
- [プライベートなnpmパッケージ](articles/0192bc96-0021-7e81-956f-0489d3d877f2/README.md)
- [メモリ上のELFバイナリを実行するPythonコード](articles/0192bc96-356e-7cde-83e0-2639cf783e3a/README.md)
- [Realtekの汎用ASIOドライバー](articles/0192bca2-e6a5-75ff-87e7-36446aafa536/README.md)
- [WindowsにおけるPythonのshebang（？）](articles/0192d0e9-8a12-77fa-884f-0f05abb1505b/README.md)
- [HTMLの前処理について雑感](articles/0192e054-20e7-7a85-86e8-0f42192227d6/README.md)
- [MSYS2のポータブル環境](articles/0192e10e-9d82-7ef4-8e4b-4c1f7359b3e7/README.md)
- [MSYS2 UCRT64でgdome2をビルドする](articles/0192e2dd-ff19-70dd-9a75-038df515996c/README.md)
- [CUERipperメモ](articles/019333d9-b6e8-770a-94c4-f57f586152ba/README.md)
- [PDFから「しおり」を抽出](articles/01933dc7-1b4a-7d58-9bb9-e473c4b877f7/README.md)
- [PDFをPNGに変換](articles/01935161-66d4-7c5b-9fac-472547dcb5e4/README.md)
- [白背景を詰める](articles/01935308-3b79-7444-8aeb-993a16fa72f4/README.md)
- [基本的にDocker内で使っているツール類](articles/01938f77-d329-755c-8dd0-24fc4492e621/README.md)
- [`*.ai` → `*.pdf`](articles/0193949c-0606-7614-8cee-5b821c9a6e56/README.md)
- [CSS `rgb()`の小数点数を特定要素に設定する](articles/0193dd27-ddcb-7d77-84e8-565fa818cafe/README.md)
- [コマンドプロンプトの起動時スクリプト](articles/019439e6-6b18-7dd9-add3-7582c1253921/README.md)
- [漢字かな交じり文の読みを調べる（Windows＋Excel）](articles/0194a7a3-dd04-7957-9a0f-8cda83172878/README.md)
- [SVGの`text`要素のアウトライン化と選択・検索を両立させる](articles/0194b5a6-20b9-7e06-ac1d-5412b4342236/README.md)
- [ディスクのフルバックアップイメージをマウントする](articles/0194c92a-d133-7f46-a3c6-191bbbc756f1/README.md)
- [AppImageを手動でインストールする（Ubuntu 24.04）](articles/0194d66f-55fa-7755-93b3-7b488b50edaa/README.md)
- [RDPメモ](articles/0194ed9c-6542-7516-b04b-c25dccd11704/README.md)
- [`text-box`メモ](articles/01951267-68df-7629-8afc-4572753e5735/README.md)
- [トラックポイントキャップを買い換える](articles/01951e68-af72-78bc-8b57-faa9d8219340/README.md)
- [Native Accessのアップデートを阻止する](articles/01952945-f85d-7592-b79c-d6b37ce7fd3a/README.md)
- [Vivliostyle CLIでフォルダ内のMarkdownを1ファイルにまとめて組版するスニペット](articles/0195ea9c-bb8d-7eb0-a9a0-bb9d9df22905/README.md)
- [Vivliostyle×devcontainerメモ](articles/01969029-5b82-7fc3-a23b-2055c0205ae0/README.md)
- [ChromiumとGhostscriptで表現できる色](articles/0196aef3-fee5-7cf1-bc9b-ba25187678de/README.md)
- [woff2.dockerfile](articles/0196c8ad-dd12-72bc-b9c7-dec35c735fd9/README.md)
- [Emscriptenのdevcontainer環境](articles/0196c8af-1ad7-71fa-a98e-b95012af991d/README.md)
- [GhostscriptをWASMにしたい](articles/0196e6d1-edd0-7940-ab91-1f2930eb8f7a/README.md)
- [PDF内のビットマップ画像を別の画像に置換するそこそこまともな方法](articles/0197a636-f1e1-76ae-a625-c813a2b80a3d/README.md)
- [ミッドマウントタイプのUSB Type-C レセプタクルについて](articles/01988924-00d6-7623-bb90-86a09dc42fde/README.md)
- [だいたい狙った時間で指定したファイルを配信するローカルサーバ](articles/0198bfcb-cbef-7e17-8c11-4ce3bc66c47a/README.md)
- [ラップトップにプリインストールされたOEM版Windows 11をKVM上にインストールし直して利用する](articles/0198cacd-dcc9-7017-97a8-6fc964adb687/README.md)
- [OEM版WindowsをLinuxに置き換えたあとにそのライセンスをKVM等の上で使うことに問題はあるのか](articles/0198ccbf-0be3-78bc-907c-8d4b8736f893/README.md)
- [GitHub上のPythonパッケージをインストールする](articles/0198cf48-ef65-7a71-9d3b-10be054e876f/README.md)
- [Ardourのインストール時警告（frequency scaling）に対応する](articles/01995510-f66f-7199-8af1-826b203d4f98/README.md)
- [ポエム](articles/01997f2d-7b25-7613-8ab6-f6d7aa254364/README.md)
- [WindowsでCodex CLIのMCPにPlaywrightを追加する](articles/0199838e-d973-7bf4-8fcb-bd8df3660c65/README.md)
- [ふつうのPCにSPIを生やす](articles/0199b078-c5f8-7d90-b63a-390c41cbb142/README.md)
- [可変抵抗によるLED光量調整](articles/0199b2bd-3393-791d-bedd-9858cc706526/README.md)
- [FFmpegでmp4からgifに変換](articles/0199b308-a0a2-7d44-86b1-dd2327d4f433/README.md)
- [Ubuntu 24.04作業ログ](articles/0199b484-c4c0-79bc-9570-7791f59940d9/README.md)
- [環境変数の取り扱いの指針](articles/0199c69e-5b30-70e5-8788-15733124b791/README.md)
- [WSL＋Dockerディスク食いすぎ](articles/0199c74b-3b67-79c4-9b9d-82a950aa4d73/README.md)
- [GLM-MN3350](articles/0199d804-fa2f-7925-82e1-003224f2d920/README.md)
- [CLIでUSBストレージの安全な取り外し](articles/0199d80a-98e9-72fb-94aa-f24b5fe2ff78/README.md)
- [再起動後にUEFIに入る](articles/0199d814-d1a6-7b4e-b283-44e72571f725/README.md)
- [Z390-A PRO (MS-7B98)におけるWoL有効化](articles/0199d851-4ce7-724f-a0c9-6df368692ac3/README.md)
- [マシンのグローバルIPアドレスを定期的に特定のGistにアップロードする](articles/0199e067-737c-7025-ad6f-6e2e546fc451/README.md)
- [SSH／RDPからでもカメラやマイクに触りたい](articles/0199f09e-6287-7636-b981-e8e8baa2c800/README.md)
- [退避ファイルの拡張子はorgよりorigがよい](articles/0199f1a3-18bc-7e0f-872d-d8ac4587db31/README.md)
- [ThinkPad X1 Carbon Gen 12利用ログ](articles/019a13c7-2a12-7453-b753-6114042fb4e8/README.md)
- [WireGuard内の端末からのすべてのWeb通信を、WireGuardサーバー経由にする](articles/019a237d-d8a2-7ced-9b6e-ab9823c95b3e/README.md)

---

## このリポジトリの使い方

いつか役に立つかもしれないけど、技術ブログなんて大層なものを運用するほどではない気がする。こういうシンプルなやつでいい。

### 新規記事を作成

- タイトルは`h2`
- 末尾に改行を付ける

```
$ make new
```

### `./README.md`を作成

```
$ make README.md
```

## Windows Terminalでtmuxを起動するワークアラウンド

Windows Terminal内で[`C:/msys64/msys2_shell.cmd -defterm -here -no-start -ucrt64`](https://www.msys2.org/docs/terminals/)等のコマンドで起動したMSYS2シェルではtmuxを起動できない。scriptコマンドを経由することで問題を回避できる。

```console
$ tmux
open terminal failed: not a terminal

$ script --quiet --command tmux /dev/null

$ cat << EOS > /usr/bin/tmux-wt
#!/bin/bash
script --quiet --command tmux /dev/null
EOS
```

https://github.com/microsoft/terminal/issues/5132#issuecomment-1009022843

<!-- あやしい
なお`script.exe`をフルパスで指定すれば、PowerShellからでも起動できる。

```console
> C:\msys64\usr\bin\script.exe -q -c tmux /dev/null
```
-->

## Vimの正規表現の先読み・後読み

（後読み）「後ろにダブルクオートが続くダブルクオート」`/"(?=")/`と等価なVimの正規表現は`\v""@=`

（先読み）「直前に`/^M[0-9]-/`がある`[0-9]+`」`/(?<=^M[0-9]-)[0-9]+/`と等価なVimの正規表現は`\v(^M[0-9]-)@<=[0-9]+`

## Scribusを経由して印刷仕様のPDFを出力する

https://www.klaasnotfound.com/2016/06/05/creating-cmyk-prepress-pdfs-with-inkscape-and-scribus/

まあScribusのPDF出力バックエンドもGhostscriptだとは思うんだけども

## mintty.exeでWSLを起動する

`C:\msys64\usr\bin\mintty.exe C:\Windows\System32\wsl.exe --cd "~"`へのショートカットを作成する。Git Bashでもいけるかも。

```
> $wshShell=New-Object -ComObject "WScript.Shell";$wslPath="C:\Windows\System32\wsl.exe";$minttyPath="C:\msys64\usr\bin\mintty.exe";$lnk=$wshShell.CreateShortcut("$($PWD.Path)\wsl.exe.lnk");$lnk.TargetPath=$minttyPath;$lnk.Arguments="$wslPath --cd ""~""";$lnk.WorkingDirectory=$PWD.Path;$lnk.IconLocation="$wslPath, 0";$lnk.Save();
```

```javascript
var wshShell = new ActiveXObject("WScript.Shell");
var curDir = wshShell.CurrentDirectory;
var wslPath = "C:\\Windows\\System32\\wsl.exe";

var lnk = wshShell.CreateShortcut(curDir + "\\wsl.exe.lnk");
lnk.TargetPath = "C:\\msys64\\usr\\bin\\mintty.exe";
lnk.Arguments = wslPath + " --cd \"~\"";
lnk.WorkingDirectory = curDir;
lnk.IconLocation = wslPath + ", 0"
lnk.Save();
```

なんでこんなことをするかというと、MSYS2よりはWSLのほうが"ほぼLinux"として扱いやすいが、Windows Terminalはsixelに対応してないので面白くなかったりキーボードショートカットがおせっかいだったりして好きじゃないから。

フォント設定などもろもろ`.minttyrc`はMSYS2の`$HOME`に置いておく。

バッチファイルのほうがいいかも。この場合`.minttyrc`はWindows側の`%USERPROFILE%`に置いておく。

```
C:\msys64\usr\bin\mintty.exe --title wsl --icon C:\Windows\System32\wsl.exe,0 C:\Windows\System32\wsl.exe --cd "~"
```

応用のPowerShell。HOMEを設定しておかないと（Windows側の）Vimなど一部が正しく設定を読まない。

```
SET HOME=%USERPROFILE%
C:\msys64\usr\bin\mintty.exe --icon "C:\Program Files\PowerShell\7\pwsh.exe,0" "C:\Program Files\PowerShell\7\pwsh.exe" -WorkingDirectory %USERPROFILE%
```

## MSYS2にいつも入れてるもの

CMakeとMakeとGCCあればだいたいどうにかなるでしょ。

- [`mingw-w64-ucrt-x86_64-toolchain`](https://packages.msys2.org/groups/mingw-w64-ucrt-x86_64-toolchain)
- [`mingw-w64-ucrt-x86_64-cmake`](https://packages.msys2.org/package/mingw-w64-ucrt-x86_64-cmake)

## JScriptをバッチファイルに埋め込む（Shebangもどき）

詠み人知らず。

- https://miya2000.hatenadiary.org/entry/20090823/p0
- https://qiita.com/snipsnipsnip/items/50e4ca88e3ce3f8cffda

前提として、バッチファイルに構文エラーがあっても実行されない場合には問題にならない。

### JScript

```js
@if(0)==(0) ECHO OFF
CScript //Nologo //E:JScript "%~f0" %*
EXIT /B %ERRORLEVEL%
@end

WScript.StdOut.WriteLine("foo");
```

あるいは1行で

```js
@if(0)==(0) ECHO OFF && CScript //Nologo //E:JScript "%~f0" %* && EXIT /B %ERRORLEVEL% @end

WScript.StdOut.WriteLine("foo");
```

- バッチファイル側
  - `if`文にエコーを封じる@がついたもの
  - `(0)==(0)`が解釈され、trueなので`echo off`以降が実行される
  - 拡張子が`.bat`なのでエンジン指定は必須
  - `exit`で実行が止まるので、以降に構文エラー(=JScript)があっても問題にならない
- JScript側
  - `@if()`文……JScriptの[特殊文法](https://blog.delphinus.dev/2010/09/conditional-compilation-in-jscript.html)
  - `0`が解釈され、falseなので`@if(0)`～`@end`は無視される

### Chakra

```js
<!-- : ^
/*
@cscript /nologo /e:{1b7cd997-e5ff-4932-a7a6-2a9e636da385} "%~f0" %*
@exit /b %errorlevel%
*/

"use strict"
WScript.StdOut.WriteLine(WScript.Arguments(0));
try{WScript.Quit(99);}catch(e){}
```

- バッチファイル側
  - 1行目は `:` によってラベル定義なので問題なし
  - `^` によって制御文字CRLFを打ち消して、次の行の `/*` も1行目と同時に解釈される
  - `exit` まで実行。上述の通り
- Chakra
  - `<!--` をコメントとして扱うので、1行目はコメント
    - [HTML-likeコメント](https://jsprimer.net/basic/comments/)
  - 2~4行目は通常のコメント

## WSL2のNode.jsにPlaywrightでChrome入れたけど動かん

Vivliostyleのプレビューで必要だった。

Chromeを手で起動して、足りないと言われたものを`apt search`で探してかたっぱしから入れた。まあ起動はするけどたくさんエラーが出てるし、WSL2側にChromiumをインストールしたら解決する気がする。

```shell-session
$ /home/mukai/.cache/ms-playwright/chromium-1091/chrome-linux/chrome

$ sudo apt install -y x11-apps
$ sudo apt install -y libnss3
$ sudo apt install -y libatk1.0-0
$ sudo apt install -y libatk-bridge2.0-0
$ sudo apt install -y libxkbcommon0
$ sudo apt install -y libxcomposite1
$ sudo apt install -y libxdamage1
$ sudo apt install -y libxrandr2
$ sudo apt install -y libgbm1
$ sudo apt install -y libasound2
```

## Invoke-WebRequestのリダイレクトをトレースしたい（wip）

元はといえば（JScriptでも使える）`XMLHttpRequest`がリダイレクトを無効にしたりトレースしたりする機能がないのが悪い。

https://scrapbox.io/nwtgck/fetch()%E3%81%A7%E3%82%82XMLHttpRequest%E3%81%A7%E3%82%82%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E3%81%A7%E3%83%AA%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88%E3%82%92%E8%BF%BD%E8%B7%A1%E3%81%97%E3%81%A6XHR%E3%81%A0%E3%81%A8%E3%83%AA%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88%E3%81%95%E3%81%9B%E3%81%AA%E3%81%84%E6%96%B9%E6%B3%95%E3%81%AF%E3%81%AA%E3%81%84

```ps1
try { $res = Invoke-WebRequest -Method Head -Uri $uri -MaximumRedirection 0 } catch { $res = $_.Exception.Response }
```

`-MaximumRedirection 0`とすればリダイレクトしたときに`catch`に流れて、例外から`Response`を得られる。成功すればもちろんふつうに取得できる。これをdo-whileループにしたらいけるだろうと思う。

## ワーキングディレクトリ内のファイル名がある正規表現にマッチするファイルから、ある正規表現にマッチする行を抽出する on WSL

`clip.exe`はsjisなので文字コード変換が必要

https://zenn.dev/kumavale/scraps/2271c61cbd19ef

```
find . -regex './[0-9]-[0-9].txt' | xargs -I{} grep '^■■' {} | iconv -t sjis | clip.exe
```

## シンボリックリンクを含むGitリポジトリ

例：https://github.com/U-1F992/nthaka

`example/lib/nthaka`がリポジトリのルート（`../..`）を指している。

Windowsではこんな感じで作る。

```
> cd example
> sudo cmd /c mklink /D .\lib\nthaka ..\..
```

クローンする時も管理者権限が必要。

```
> sudo git clone -c core.symlink=true https://github.com/U-1F992/nthaka.git
```

## PDF切り出しに使うTeXのテンプレート

まれによく使う。

```tex
\documentclass{standalone}
\usepackage{graphicx}
\begin{document}

% GIMPにインポートして各座標を調べておく。300dpiはあったほうがいい。単位はbp。
% PDFの座標は左下が0,0であることに要注意。
\includegraphics[page=1, viewport=左下x 左下y 右上x 右上y, clip]{input.pdf}

\end{document}
```

## カレントディレクトリ以下のPNG画像をJPGに変換する

ファイル名を切り取るやつ、ほんと覚えられない……

```
for file in $(find . -name "*.png" -type f); do convert "$file" "${file%.png}.jpg"; rm "$file"; done
```

PNGの圧縮を調節したかったので結局こっちを使った。8並列optipng

```
find . -name "*.png" -type f -print0 | xargs -0 -P8 -n1 optipng -o7
```

## PSoC 4ハードウェア設計上の注意事項

https://community.infineon.com/t5/%E3%83%8A%E3%83%AC%E3%83%83%E3%82%B8%E3%83%99%E3%83%BC%E3%82%B9%E3%82%A2%E3%83%BC%E3%83%86%E3%82%A3%E3%82%AF%E3%83%AB-KBA/AN88619-PSoC-4%E3%83%8F%E3%83%BC%E3%83%89%E3%82%A6%E3%82%A7%E3%82%A2%E8%A8%AD%E8%A8%88%E4%B8%8A%E3%81%AE%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A0%85-Community-Translated-JA/ta-p/250231

## ES3相当のJavaScriptでUUID風文字列を生成する

```js
/**
 * RFC4122 version 4 compliant UUID generator
 *
 * Based on: https://stackoverflow.com/a/8809472 (Public Domain / MIT)
 *
 * @returns {string}
 */
function generateUUID() {
  var d = new Date().getTime(); // Timestamp
  var d2 = // Time in microseconds since page-load or 0 if unsupported
    typeof performance !== "undefined" && performance.now
      ? performance.now() * 1000
      : 0;
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
    var r = Math.random() * 16; // random number between 0 and 16
    if (d > 0) {
      // Use timestamp until depleted
      r = (d + r) % 16 | 0;
      d = Math.floor(d / 16);
    } else {
      // Use microseconds since page-load if supported
      r = (d2 + r) % 16 | 0;
      d2 = Math.floor(d2 / 16);
    }
    return (c === "x" ? r : (r & 0x3) | 0x8).toString(16);
  });
}

WScript.Echo(generateUUID());
```

## PDFの指定したページをトリミングして出力

メモ：こっちのほうが楽かも

```python
import fitz


def in2pt(in_: float) -> float:
    return in_ * 72


LEFT_PAGE = (
    in2pt(1.857),
    in2pt(1.85),
    in2pt(1.857) + in2pt(5.83),
    in2pt(1.85) + in2pt(8.27),
)
RIGHT_PAGE = (
    in2pt(8.867),
    in2pt(1.85),
    in2pt(8.867) + in2pt(5.83),
    in2pt(1.85) + in2pt(8.27),
)

pdf = fitz.open("../../Downloads/cover0325.pdf")
dst = fitz.open()

for page, cropbox in (
    (0, LEFT_PAGE),
    (1, LEFT_PAGE),
    # (5, RIGHT_PAGE),
    (7, LEFT_PAGE),
    (7, RIGHT_PAGE),
    # (10, LEFT_PAGE),
):
    pdf[page].set_cropbox(fitz.Rect(*cropbox))
    dst.insert_pdf(pdf, page, page)

dst.save("out.pdf")
```

座標指定は左下原点のbp

#### pdfcroppages.py

```py
import argparse
import os
import pathlib
import subprocess
import tempfile


def parse_pages(raw: str):
    pages: list[int] = []
    parts = raw.split(",")
    for part in parts:
        if "-" in part:
            start, end = map(int, part.split("-"))
            pages.extend(range(start, end + 1))
        else:
            pages.append(int(part))
    return pages


def generate_cropping_tex(
    page: int, viewport: tuple[float, float, float, float], posix_rel_path: str
):
    return f"""\\documentclass{{standalone}}
\\usepackage{{graphicx}}
\\begin{{document}}
\\includegraphics[page={page}, viewport={" ".join([str(coord) for coord in viewport])}, clip]{{{posix_rel_path}}}
\\end{{document}}
"""


def run_pdflatex(input: pathlib.Path):
    _ = subprocess.run(
        ["pdflatex", "-output-directory", str(input.parent), str(input)],
        check=True,
        capture_output=True,
    )
    assert input.with_suffix(".aux").exists()
    assert input.with_suffix(".log").exists()
    assert input.with_suffix(".pdf").exists()


def run_pdfunite(input: list[pathlib.Path], output: pathlib.Path):
    _ = subprocess.run(
        [
            "pdfunite",
            *[str(_) for _ in input],
            str(output),
        ],
        check=True,
        capture_output=True,
    )
    assert output.exists()


def main():
    parser = argparse.ArgumentParser(
        description="Crop a PDF file using a specified box"
    )
    parser.add_argument("input", type=str, help="Path to the input PDF file")
    parser.add_argument("pages", type=str, help="Comma-separated list of pages to crop")
    parser.add_argument("lx", type=float, help="X-coord of the bottom-left corner")
    parser.add_argument("ly", type=float, help="Y-coord of the bottom-left corner")
    parser.add_argument("rx", type=float, help="X-coord of the top-right corner")
    parser.add_argument("ry", type=float, help="Y-coord of the top-right corner")
    parser.add_argument("output", type=str, help="Path to the output PDF file")
    args = parser.parse_args()

    INPUT = pathlib.Path(args.input).resolve()
    OUTPUT = pathlib.Path(args.output).resolve()
    PAGES = parse_pages(args.pages)

    pdfs: list[pathlib.Path] = []

    for page in PAGES:
        temp = tempfile.NamedTemporaryFile(delete=False, suffix=".tex")
        try:
            temp_path = pathlib.Path(temp.name).resolve()
            input_posix_rel_path = INPUT.relative_to(
                temp_path.parent, walk_up=True
            ).as_posix()

            with open(temp.name, "w", encoding="utf-8") as f:
                f.write(
                    generate_cropping_tex(
                        page,
                        (args.lx, args.ly, args.rx, args.ry),
                        input_posix_rel_path,
                    )
                )

            run_pdflatex(temp_path)
            pdfs.append(temp_path.with_suffix(".pdf"))

            for suffix in [".aux", ".log"]:
                os.remove(str(temp_path.with_suffix(suffix)))

        finally:
            temp.close()  # Automatically removed

    try:
        # FIXME: pdfunite crashes with absolute input paths.
        cwd = pathlib.Path.cwd()
        run_pdfunite([pdf.relative_to(cwd, walk_up=True) for pdf in pdfs], OUTPUT)

    finally:
        for pdf in pdfs:
            os.remove(str(pdf))


if __name__ == "__main__":
    main()
```

## WSLのディスクサイズを削減

よく中身を見て使うこと！

https://qiita.com/siruku6/items/c91a40d460095013540d

`Optimize-VHD`はHyper-Vを有効にしないと（＝Pro版でないと）使用できないようだ。

```
ECHO y | docker container prune
ECHO y | docker image prune
ECHO y | docker volume prune
ECHO y | docker builder prune
ECHO y | docker system prune

wsl --shutdown
(
ECHO select vdisk file="C:\Users\mukai\AppData\Local\Packages\CanonicalGroupLimited.Ubuntu_79rhkp1fndgsc\LocalState\ext4.vhdx"
ECHO attach vdisk readonly
ECHO compact vdisk
ECHO detach vdisk
ECHO exit
) | diskpart

PAUSE
```

## MSYS2環境を現在のターミナルで開く

毎回忘れて[ここ](https://www.msys2.org/docs/terminals/)見ているなあ。`-full-path`でPATHの引継ぎの有無を変更できる。

```
C:/msys64/msys2_shell.cmd -defterm -here -no-start -ucrt64 -full-path
```

## MarkdownのテーブルをHTMLに置換

WIP

行選択：`^\| +([^ ]+) +\| +([^ ]+) +\| +([^ ]+) +\|$`

## WindowsのセットアップをMSアカウントなしで行う

https://news.yahoo.co.jp/articles/f7150bdb2419ad79e8bfa1f9593074b667fa1e3c?page=2

ローカルフォルダ名をアカウント名（メールアドレスの一部らしい？）にするのを本当にやめてくれ

1. <kbd>Shift</kbd>+<kbd>F10</kbd>でコマンドプロンプトを起動
2. `oobe\BypassNRO.cmd`を実行し、再起動を待機する
3. インターネット接続なしで進める
4. 「名前を入力します」で指定する名前がホームフォルダ名になる。

### ネットワークの設定を削除（誤って繋いでしまった時のリカバリ）

```
> netsh wlan show profile
> netsh wlan delete profile name="AP_NAME"
> shutdown -r
```

インターネットに接続しないまま、回復ドライブも作成しておく（購入時のスナップショットとして）。32GB以上の～と記載されていたが32GBで作成できた。

`%USERPROFILE%\OneDrive`にデスクトップやドキュメントを配置されるのもやめてほしい。オフラインのまま、OneDriveの同期設定を解除しアンインストールしておく。

1. （不要？）タスクバーのアイコン＞「ヘルプと設定」＞「設定」＞「アカウント」＞「このPCのリンク解除」
2. タスクバーのアイコン＞「ヘルプと設定」＞「OneDriveを閉じる」＞「OneDriveを終了する」
3. 「プログラムの追加と削除」からOneDriveをアンインストール

```
TASKKILL /F /IM OneDrive.exe /T

REM このコマンドとアンインストールは違うらしい。
REM 「プログラムの追加と削除」からアンインストールしたら下記のレジストリ操作をしなくてもエクスプローラーから消えた

REM 32bit
REM %SystemRoot%\System32\OneDriveSetup.exe /uninstall

REM 64bit
%SystemRoot%\SysWOW64\OneDriveSetup.exe /uninstall

RMDIR /Q /S "%USERPROFILE%\OneDrive"
RMDIR /Q /S "%LOCALAPPDATA%\Microsoft\OneDrive"
RMDIR /Q /S "%ProgramData%\Microsoft OneDrive"
RMDIR /Q /S "C:\OneDriveTemp"

REM 以下はレジストリを触るので調べながらやったほうがよい

reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\OneDrive" /v PreventNetworkTrafficPreUserSignIn /t REG_DWORD /d 1 /f

REM エクスプローラーのエントリ
REM HKEY_LOCAL_MACHINE/SOFTWARE/Microsoft/Windows/CurrentVersion/Explorer/MyComputer/NameSpace で紐づけられている
reg delete "HKEY_CLASSES_ROOT\CLSID\{018D5C66-4533-4307-9B53-224DE2ED1FE6}" /f
reg delete "HKEY_CLASSES_ROOT\Wow6432Node\CLSID\{018D5C66-4533-4307-9B53-224DE2ED1FE6}" /f
```

再起動後、ここで初めてインターネットに接続する。まずはWindows Update。

OfficeをインストールするにはMicrosoftアカウントによるサインインが必須になる。これもかなりいやな仕様だが……
仕方なくここでMicrosoftアカウントに切り替える

「設定」＞「アカウント」＞「ユーザーの情報」＞「アカウントの設定」＞「Microsoftアカウントでのサインインに切り替える」

OfficeをインストールしたらOneDriveが復活した、いらんねんそれは。同じ手順で削除していく

## 現在のPowerShellセッションにMSYS2のパスを追加

```
$env:Path += ";C:\msys64\ucrt64\bin"
```

## ChatGPTにプロジェクトのファイル全部食わせる

```
$ python -c "import subprocess;[print(chr(96)*3+filename+chr(10)+open(filename,encoding='utf-8').read()+chr(10)+chr(96)*3+chr(10)) for filename in subprocess.run(['git','ls-files'],capture_output=True,text=True,check=True).stdout.strip().split(chr(10))]"
```

`chr(96)`は`` ` ``、`chr(10)`は`\n`。エスケープのことを考えるのが面倒くさいため。

```python
import subprocess

[
    print(
        chr(96) * 3
        + filename
        + chr(10)
        + open(filename, encoding='utf-8').read()
        + chr(10)
        + chr(96) * 3
        + chr(10)
    )
    for filename in subprocess.run(
        ["git", "ls-files"], capture_output=True, text=True, check=True
    )
    .stdout.strip()
    .split(chr(10))
]
```

シェルワンライナーでもできるな

```
$ for file in $(git ls-files); do echo "#### $file"; echo ""; echo "\`\`\`"; cat "$file"; echo ""; echo "\`\`\`"; echo ""; done
```

## 追跡中のすべてのC言語ファイルにフォーマッタをかける

- `git ls-files`はフィルタできる
- `clang-format`のスタイル定義は`--style=file:~`で指定
- `-i`でインライン置換

```
$ git ls-files "*.c" "*.h" | xargs -I{} clang-format --style=file:.clang-format -i {}
```

## WSL2にデスクトップを生やす

https://github.com/microsoft/WSL/discussions/9350#discussioncomment-7492570

```
sudo apt-mark hold acpid acpi-support
sudo apt update && sudo apt -y install xrdp
sudo cp /etc/xrdp/xrdp.ini /etc/xrdp/xrdp.ini.bak
sudo sed -i 's/3389/3390/g' /etc/xrdp/xrdp.ini
sudo sed -i 's/max_bpp=32/#max_bpp=32\nmax_bpp=128/g' /etc/xrdp/xrdp.ini
sudo sed -i 's/xserverbpp=24/#xserverbpp=24\nxserverbpp=128/g' /etc/xrdp/xrdp.ini
touch ~/.xsessionrc
```

```
export GNOME_SHELL_SESSION_MODE=ubuntu
export XDG_CURRENT_DESKTOP=ubuntu:GNOME
export XDG_DATA_DIRS=/usr/share/ubuntu:/usr/local/share:/usr/share:/var/lib/snapd/desktop
export WAYLAND_DISPLAY=
export XDG_CONFIG_DIRS=/etc/xdg/xdg-ubuntu:/etc/xdg
```

```
sudo apt install -y ubuntu-desktop-minimal # or ubuntu-desktop
sudo systemctl restart xrdp
```

## VirtualBoxの右上に出てくる通知センターを消す

https://www.reddit.com/r/virtualbox/comments/y5lr8x/virtualbox_70_disable_notification_center/

すでに設定をいじっていたらそれを消して、`SuppressMessages`を追加する

```.VirtualBox/VirtualBox.xml.patch
13d12
<       <ExtraDataItem name="GUI/NotificationCenter/Alignment" value="Bottom"/>
16a16
>       <ExtraDataItem name="GUI/SuppressMessages" value="confirmGoingFullscreen,remindAboutMouseIntegration,remindAboutAutoCapture"/>

```

`<ExtraDataItem name="GUI/NotificationCenter/Order" value=""/>`もあるらしい

## VirtualBoxのVRAMを256MBまで増やす

GUIでは128MBまでしか設定できない。

https://askubuntu.com/questions/587083/virtualbox-how-to-increase-video-memory

```
> VBoxManage modifyvm "Name of VM" --vram 256
```

ただし、3Dアクセラレーションを利用する場合はホストのVRAMがパススルーされるので、VRAMを増やしてもおいしくないらしい。

## VirtualBoxのディスクイメージの履歴をクリアする

削除したISOがいつまでも表示されてうっとおしい。

https://forums.virtualbox.org/viewtopic.php?t=78320

```
> .\vboxmanage.exe setextradata global "GUI/RecentListCD"
```

`vboxmanage`等のコマンドの使い方わからん。

## MSYS2でddrescueのビルド

https://www.gnu.org/software/ddrescue/

現時点ではv1.28まで出ている。http://ftpmirror.gnu.org/ddrescue/

- `lzip`
- `base-devel`
- `gcc`

`mingw-*`ではない。あくまでMSYS2上で動かすものなので。

```
$ wget http://ftpmirror.gnu.org/ddrescue/ddrescue-1.28.tar.lz
$ tar xvf ddrescue-1.28.tar.lz
$ cd ddrescue-1.28
$ ./configure
$ make
$ make install
$ ddrescue --version
```

## tmux

ぼちぼち使い方を覚えようの会

- 左右に分割 <kbd>Ctrl</kbd>+<kbd>b</kbd>, <kbd>%</kbd> `tmux split-window -h`
- 上下に分割 <kbd>Ctrl</kbd>+<kbd>b</kbd>, <kbd>"</kbd> `tmux split-window -v`

## GNU Screen 4.9.1のビルド

https://qiita.com/jp_yen/items/443f29945a154555745c

#### screen.c.patch

```diff
1116a1117
> #ifndef __MSYS__
1118a1120
> #endif
1152a1155
> #ifndef __MSYS__
1154a1158
> #endif
```

## C言語の規格書

https://stackoverflow.com/questions/17014835/where-can-one-find-the-c89-c90-standards-in-pdf-format

## MSYS2シェル内でvimを開くとき

MSYS2にもVimを入れているけど、こっちのVimはLSPと相性が悪い（LSPの中にはMSYS2形式のパスを食わないものがいる・MSYS2にもNodeが必要・など）

Windows用VimをMSYS2から起動することはできるが、HOME環境変数を参照するため、Vimを直接起動したときとは違うvimrcを参照してしまう。この挙動はしゃらくさくて、MSYS2で開くと`~/.vimrc`Windowsでは`%USERPROFILE%\_vimrc`を開いてくる

ので、HOMEを無効にしつつWindows用vimを開きたい。

```
$ env -u HOME /c/Program\ Files/Vim/vim91/vim.exe

$ alias vim="env -u HOME /c/Program\ Files/Vim/vim91/vim.exe"
```

## PythonスクリプトでGUIのファイル選択ウィンドウを出す

基本はコマンドライン引数や設定ファイル越しに渡すべきであんまり筋のよいやり方ではないと思うけど、アプリケーションに組み込まれたスクリプトエンジンなどでどうしても必要な時がある。

https://docs.python.org/3/library/dialog.html#module-tkinter.filedialog

## Ghostscriptの`inkcov`と`ink_cov`

https://ghostscript.readthedocs.io/en/latest/Devices.html#ink-coverage-output

「全体をC50で塗りつぶしたとき、`inkcov`は100%、`ink_cov`は50%を返す」

```
gs -dSAFER -dNOPAUSE -dBATCH -o- -sDEVICE=inkcov Y.pdf
gs -dSAFER -dNOPAUSE -dBATCH -o- -sDEVICE=ink_cov Y.pdf
```

## JapanColor2001Coated.icc

https://www.adobe.com/support/downloads/iccprofiles/iccprofiles_win.html

https://wiki.scribus.net/canvas/Getting_and_installing_ICC_profiles の`Getting and installing additional ICC profiles`に書いてあった

## qpdf

~~~
qpdf --decrypt input.pdf output.pdf
~~~

https://github.com/qpdf/qpdf

## PlatformIO+Arduino-Picoの更新

https://arduino-pico.readthedocs.io/en/latest/platformio.html#deprecation-warnings

```
> pio pkg update --global --platform https://github.com/maxgerhardt/platform-raspberrypi.git
```

## プライベートなnpmパッケージ

https://blog.pinkumohikan.com/entry/set-unlicensed-to-license-field-when-private-product

```
"license": "UNLICENSED",
"private": "true"
```

## メモリ上のELFバイナリを実行するPythonコード

```python
import ctypes


_libc = ctypes.CDLL("libc.so.6", use_errno=True)

_libc.memfd_create.argtypes = [ctypes.c_char_p, ctypes.c_uint]
_libc.memfd_create.restype = ctypes.c_int


def memfd_create(name: str, flags: int):
    """
    `int memfd_create(const char *name, unsigned int flags);`
    """
    fd = _libc.memfd_create(name.encode("utf-8"), flags)
    if fd == -1:
        err = ctypes.get_errno()
        raise OSError(err, os.strerror(err))
    return fd


_libc.fexecve.argtypes = [
    ctypes.c_int,
    ctypes.POINTER(ctypes.c_char_p),
    ctypes.POINTER(ctypes.c_char_p),
]
_libc.fexecve.restype = ctypes.c_int


def fexecve(fd: int, argv: typing.Collection[str], envp: typing.Collection[str]):
    """
    `int fexecve(int fd, char *const argv[], char *const envp[]);`
    """
    argc = (ctypes.c_char_p * (len(argv) + 1))(
        *[arg.encode("utf-8") for arg in argv] + [None]
    )
    envc = (ctypes.c_char_p * (len(envp) + 1))(
        *[env.encode("utf-8") for env in envp] + [None]
    )

    if _libc.fexecve(fd, argc, envc) == -1:
        err = ctypes.get_errno()
        raise OSError(err, os.strerror(err))


def execute(elf_data: bytes):
    fd = memfd_create("elf_memfd", 0)
    os.write(fd, elf_data)
    try:
        fexecve(fd, ["/proc/self/exe"], os.environ)
    except OSError as e:
        print(f"fexecve failed: {e}")
```

## Realtekの汎用ASIOドライバー

あってしかるべきとは思っていたけど、調べてみたらやっぱりあるらしい。ASIO4ALLよりはマシか？

- https://www.baumannmusic.com/2021/the-official-asio-driver-for-realtek-hd-audio-dell-hp-lenovo-asus/

ここからダウンロードする。DellだがThinkPadにもインストールできた。ほんまかいな。

- https://www.dell.com/support/home/ja-jp/drivers/driversdetails?driverid=7776f

```
$ sha256sum Realtek-High-Definition-Audio-Driver_7776F_WIN_6.0.1.7737_A04_02.EXE
c5051533b798a2ff4da58e746b651243e08f2bf1a1a5bdbca50c2e3b4432c9d9 *Realtek-High-Definition-Audio-Driver_7776F_WIN_6.0.1.7737_A04_02.EXE
```

「INSTALL」ではなく「EXTRACT」を選択。フォルダを作成して収めるような親切なことはしてくれないので、ぶちまけたくなければ新規フォルダを作成して選択すること。

`{展開先}\RealtekHDAudio\ASIO\Install.exe`を実行して、指示に従いインストールする。

## WindowsにおけるPythonのshebang（？）

- https://qiita.com/snipsnipsnip/items/50e4ca88e3ce3f8cffda

ちなみに`py`ランチャーは`#!/usr/bin/python`をいい感じにしてくれるらしい。

- https://docs.python.org/ja/3/using/windows.html#shebang-lines

ここで話題にするのは、バッチファイルにPythonを埋め込みたいという話。

```
@py -x "%~f0" "%*" & exit /b %errorlevel%

import time

print("Hello")
time.sleep(10000)
```

`py(thon) -x`オプションがキモ。1行目を無視してくれる。

```
> py --help | Select-String -CaseSensitive "^-x"

-x     : skip first line of source, allowing use of non-Unix forms of #!cmd
```

引数のクォーテーション周りの挙動が怪しい気もする？とりあえず全部つけておけば問題ないだろうと思っている。

## HTMLの前処理について雑感

### 正規表現ベースの処理

かんたんにルールを差し込める。sedなら一定の移植性もある。VivliostyleならNode.jsでも十分合理的。

Markdown程度の、どのようなHTMLが出力されるか予測できる範囲なら安定性もさほど問題ないはず。

DOMにのっとっておらず、容易にvalidでなくなりうる。

正直なところ抵抗がある。

### DOMベースの処理

「正しい」方法。実装はプログラミングそのもの。

Webブラウザ以外にDOMを十全に操作する方法がない

- Node.js+JSDOM？
  - 追加の依存が　と思ったけど実はVivliostyle CLIはフォークしたJSDOMに依存しているので意外とアリかもしれない
- Node.js+Playwright？
  - 文書にscriptを埋め込むことになり、すべてのスクリプトがVivliostyleからでも正常に実行できるとは限らないので、Vivliostyleで直接組版できなくなる
- Node.jsからシングルバイナリに？
  - なしではないと思うがよく知らない
- Python？
  - 書くのはいいけど特にWindowsでの移植性が著しく低い、セットアップが手間。
  - ほぼ確実にBeautifulSoupに依存するのでvenvの世話も必要
  - とはいえPythonくらい入れとかんかいとは思う。pyランチャーもあり悪くはない
- Pythonからシングルバイナリに？
  - 実際には署名周りでほぼ無理
- C言語で書く？
  - しんどすぎ

## MSYS2のポータブル環境

`shell.cmd`を参照。

## MSYS2 UCRT64でgdome2をビルドする

[gdome2](http://gdome2.cs.unibo.it/)

- http://gdome2.cs.unibo.it/
- https://www.gnu.org/software/gettext/manual/html_node/config_002eguess.html
- https://packages.debian.org/bookworm/libgdome2-0

```
PS > mkdir gdome2
PS > cd .\gdome2\
PS > Invoke-WebRequest -Uri https://github.com/msys2/msys2-installer/releases/download/2024-07-27/msys2-base-x86_64-20240727.sfx.exe -OutFile msys2-base-x86_64-20240727.sfx.exe
PS > .\msys2-base-x86_64-20240727.sfx.exe -y "-o$PWD\"
PS > .\msys64\msys2_shell.cmd -defterm -here -no-start -ucrt64
```

#### build-gdome2.sh

インストール直後に実行した場合`pacman --sync --refresh --sysupgrade --noconfirm`でシステム更新が行われてシェルごと強制終了されるので、再度シェルを起動して実行する。

```bash
#!/bin/bash -eu

pacman --sync --refresh --sysupgrade --noconfirm

pacman --sync --noconfirm \
    base-devel \
    mingw-w64-ucrt-x86_64-autotools \
    mingw-w64-ucrt-x86_64-glib2 \
    mingw-w64-ucrt-x86_64-libxml2 \
    mingw-w64-ucrt-x86_64-toolchain

curl --location --remote-name http://gdome2.cs.unibo.it/tarball/gdome2-0.8.1.tar.gz
tar xvf gdome2-0.8.1.tar.gz gdome2-0.8.1/
cd gdome2-0.8.1/

curl \
    --location --output config.sub 'https://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.sub;hb=HEAD' \
    --location --output config.guess 'https://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.guess;hb=HEAD'
 
curl \
    --location --remote-name https://sources.debian.org/data/main/g/gdome2/0.8.1%2Bdebian-9/debian/patches/01glibconfig.patch \
    --location --remote-name https://sources.debian.org/data/main/g/gdome2/0.8.1%2Bdebian-9/debian/patches/02fix_manpage.patch \
    --location --remote-name https://sources.debian.org/data/main/g/gdome2/0.8.1%2Bdebian-9/debian/patches/03no_glib_1.patch \
    --location --remote-name https://sources.debian.org/data/main/g/gdome2/0.8.1%2Bdebian-9/debian/patches/04bufptr_ftbfs.patch \
    --location --remote-name https://sources.debian.org/data/main/g/gdome2/0.8.1%2Bdebian-9/debian/patches/05gcc10_ftbfs.patch \
    --location --remote-name https://sources.debian.org/data/main/g/gdome2/0.8.1%2Bdebian-9/debian/patches/06libxml2.patch \
    --location --remote-name https://sources.debian.org/data/main/g/gdome2/0.8.1%2Bdebian-9/debian/patches/07test-bench-fputs.patch
for patch in *.patch
do
    patch --strip=1 --binary < "$patch"
done

CFLAGS=-Wno-implicit-int ./configure
CFLAGS=-Wno-implicit-int mingw32-make --jobs=$(nproc)
CFLAGS=-Wno-implicit-int mingw32-make install
```

## CUERipperメモ

http://cue.tools/wiki/Main_Page

2.2.6

- lossless
- image
- flac
- libFLAC
  - Verify: True
  - MD5: True
- C2ErrorMode: Mode296
  - Autoでは`Exception: Error reading CD: IoctlFailed`が発生（PIONEER BD-RW BDR-UD03 1.14）
  - AutoはMode294->Mode296の順番で試行するが、一部ディスクドライブではMode294に対応していないようだ https://hydrogenaud.io/index.php/topic,122176.0.html
- 667（おまかせ）
- Mode: 8
- Paranoid

## PDFから「しおり」を抽出

```
$ pdftk book.pdf dump_data | grep -E 'BookmarkTitle' | python3 -c "import sys, html; [print(html.unescape(line.strip())) for line in sys.stdin]" | grep -E '第[0-9]+章'
```

日本語だとエンコードされてしまうから、Pythonを挟むのが肝

## PDFをPNGに変換

- 背景透過なら`-sDEVICE=pngalpha`
- 全ページなら`-dFirstPage`/`-dLastPage`を削除

```
$ gs \
    -dBATCH \
    -dNOPAUSE \
    -dSAFER \
    -sDEVICE=png16m \
    -r300 \
    -dFirstPage=128 \
    -dLastPage=128 \
    -sOutputFile=page_%03d.png \
    input.pdf
```

## 白背景を詰める

trimのアルゴリズムの都合、全体が背景色以外で囲われている場合、その枠が削除されてしまう。

https://qiita.com/yoya/items/62879e6e03d5a70eed09

```
$ magick input.png -bordercolor white -border 1x1 -trim +repage output.png
```

## 基本的にDocker内で使っているツール類

GUIが必要な時は`--env "DISPLAY=${DISPLAY:-:0.0} --volume /mnt/wslg/.X11-unix/:/tmp/.X11-unix`（WSL）

- https://qiita.com/U-1F992/items/c75ffa7373a49d216862

### Ghostscript

```
FROM ubuntu:24.04 AS builder
RUN apt-get update && apt-get --yes install \
        gcc \
        make \
        wget \
    && rm -rf /var/lib/apt/lists/* \
    && wget https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs10051/ghostscript-10.05.1.tar.gz \
    && tar xvf ghostscript-10.05.1.tar.gz \
    && cd ghostscript-10.05.1 \
    && ./configure --prefix=/usr/local \
    && make -j$(nproc) \
    && make install

FROM ubuntu:24.04
COPY --from=builder /usr/local/. /usr/local/

ENTRYPOINT [ "gs" ]
```

```
docker build -f ghostscript.dockerfile -t ghostscript:10.05.1 .
```

```
$ docker run \
    --entrypoint /usr/bin/gs \
    --interactive \
    --mount type=bind,source=$(pwd),target=/workdir \
    --rm \
    --tty \
    --user $(id -u):$(id -g) \
    --workdir /workdir \
    ghostscript:10.05.1
```

`registry.gitlab.com/islandoftex/images/texlive:TL<year>-historic`にも入っているので、他のPDF周りのツールを使うときはこちらのほうが便利なこともある。

### ImageMagick

```
$ docker run \
    --entrypoint /usr/local/bin/magick \
    --interactive \
    --mount type=bind,source=$(pwd),target=/workdir \
    --rm \
    --tty \
    --user $(id -u):$(id -g) \
    --workdir /workdir \
    dpokidov/imagemagick:7.1.1-39
```

## `*.ai` → `*.pdf`

アウトライン化されていたら多分大丈夫

```
$ gs \
    -dBATCH \
    -dNOPAUSE \
    -dSAFER \
    -sDEVICE=pdfwrite \
    -dCompatibilityLevel=1.4 \
    -dPDFSETTINGS=/prepress \
    -sOutputFile=output.pdf \
    input.ai
```

## CSS `rgb()`の小数点数を特定要素に設定する

Chromiumにおいて、[`rgb()`](https://developer.mozilla.org/ja/docs/Web/CSS/color_value/rgb)関数は小数点数も受け付けるし、PDF出力にもちゃんと反映されるけど、特定要素のスタイルとして設定する場合には<code>elem.setAttribute("style", &#96;${elem.getAttribute("style")}; background-color: rgb(0 0.1 0.2);&#96;)</code>としなければ丸められてしまう。

[村上さん](https://github.com/vivliostyle/vivliostyle.js/issues/1432#issuecomment-2552691859)によれば、丸める挙動は好ましくはないけどバグとは言えないらしい。

> The precision with which sRGB component values are retained, and thus the number of significant figures in the serialized value, is not defined in this specification, but must at least be sufficient to round-trip eight bit values. Values must be rounded towards +∞, not truncated. ――https://drafts.csswg.org/css-color-4/#css-serialization-of-srgb

```
> python main.py
elem_style_setProperty
 0 0 0 rg
---
elem_style_backgroundColor
 0 0 0 rg
---
elem_style[backgroundColor]
 0 0 0 rg
---
elem_getAttribute_setAttribute
 0 0.000400 0.000800 rg
---
```

<details>
<summary>main.py</summary>

```py
import os
import pathlib
import subprocess

from playwright.sync_api import sync_playwright


def generate_pdf(html_content: str, script: str, output: pathlib.Path):
    with (
        sync_playwright() as playwright,
        playwright.chromium.launch(headless=False) as browser,
        browser.new_context() as context,
        context.new_page() as page,
    ):
        page.set_content(html_content)
        page.evaluate(script)
        # input("press enter")
        page.pdf(path=output, print_background=True)


def extract_rgb_fill_from_pdf(pdf_path: pathlib.Path) -> str:
    return "\n".join(
        [
            line
            for line in subprocess.run(
                [
                    "gswin64c",
                    "-dPDFDEBUG",
                    "-dBATCH",
                    "-dNOPAUSE",
                    "-sDEVICE=nullpage",
                    str(pdf_path),
                ],
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                text=True,
            ).stderr.splitlines()
            if " rg" in line
        ]
    )


def main():
    cwd = pathlib.Path.cwd()

    html_content = """
<html>
  <body>
    <div
      id="elem"
      style="display: inline-block; width: 100px; height: 100px"
    ></div>
  </body>
</html>
"""

    for title, script in (
        (
            "elem_style_setProperty",
            'document.getElementById("elem").style.setProperty("background-color", "rgb(0 0.1 0.2)");',
        ),
        (
            "elem_style_backgroundColor",
            'document.getElementById("elem").style.backgroundColor = "rgb(0 0.1 0.2)";',
        ),
        (
            "elem_style[backgroundColor]",
            'document.getElementById("elem").style["backgroundColor"] = "rgb(0 0.1 0.2)";',
        ),
        (
            "elem_getAttribute_setAttribute",
            'const elem = document.getElementById("elem"); elem.setAttribute("style", `${elem.getAttribute("style")}; background-color: rgb(0 0.1 0.2);`);',
        ),
    ):
        print(title)
        output_pdf = cwd.joinpath(f"{title}.pdf")
        try:
            generate_pdf(
                html_content,
                script,
                output_pdf,
            )
            print(extract_rgb_fill_from_pdf(output_pdf))
        finally:
            if output_pdf.exists():
                os.remove(output_pdf)
        print("---")


if __name__ == "__main__":
    main()
```

</details>

## コマンドプロンプトの起動時スクリプト

- https://github.com/Schniz/fnm?tab=readme-ov-file#windows-command-prompt-aka-batch-aka-wincmd
- https://superuser.com/questions/144347/is-there-windows-equivalent-to-the-bashrc-file-in-linux/144348#144348
- https://ss64.com/nt/cmd.html

```
> reg add "HKEY_CURRENT_USER\Software\Microsoft\Command Processor" /v AutoRun /t REG_SZ /d "%USERPROFILE%\autorun.cmd" /f
```

なお初期値は設定なし


## 漢字かな交じり文の読みを調べる（Windows＋Excel）

- https://learn.microsoft.com/en-us/office/vba/api/excel.application.getphonetic

```ts
import fs from "node:fs";

const winax = await (async () => {
  try {
    return (await import("winax")).default;
  } catch {
    return null;
  }
})();

function withCache(fn: (input: string) => string, cacheFile: string) {
  return (input: string) => {
    const cache = (() => {
      try {
        const parsed = JSON.parse(
          fs.readFileSync(cacheFile, {
            encoding: "utf-8",
          }),
        );
        return parsed && typeof parsed === "object" ? parsed : {};
      } catch {
        return {};
      }
    })() as Record<string, any>;
    if (input in cache) {
      return cache[input];
    }
    cache[input] = fn(input);
    fs.writeFileSync(cacheFile, JSON.stringify(cache), {
      encoding: "utf-8",
    });
    return cache[input];
  };
}

function excelGetPhonetic(input: string) {
  if (winax === null) {
    return input;
  }
  try {
    const excel = new winax.Object("Excel.Application");
    try {
      return excel.GetPhonetic(input) as string;
    } catch {
      return input;
    } finally {
      excel.Quit();
      winax.release(excel);
    }
  } catch {
    return input;
  }
}

console.log(withCache(excelGetPhonetic, "cache.json")("寿限無"));
```

## SVGの`text`要素のアウトライン化と選択・検索を両立させる

OSはWindows、WebブラウザはGoogle Chrome 132.0.6834.160、SVG編集の説明はInkscape 1.4 (86a8ad7, 2024-10-11)を前提としています。

SVGをWebブラウザで開くとき、特に禁止しない限り`text`要素のテキストは選択および検索が可能です。

<figure><figcaption><code>text</code>要素を含むSVG</figcaption><img src="text.svg"></figure>

<figure><figcaption>Webブラウザでテキストを選択</figcaption><img src="text-select.png"></figure>

SVGをWebブラウザで表示すると、特に制限を設けない限り、text要素のテキストは選択や検索が可能です。

しかし、指定されたフォントが利用できない場合、正しく表示されないことがあります。特殊なフォントを使用する部分やデザイン性を重視する箇所では、アウトライン化することで意図したデザインを維持できます。

1. ［レイヤー＞レイヤーとオブジェクト］
2. 出現したパネルで対象のテキストオブジェクトを選択
3. ［パス＞オブジェクトをパスへ］

<figure><figcaption><code>text</code>要素をパスに変換したSVG</figcaption><img src="path.svg"></figure>

ただし、単純にアウトライン化するとテキストは選択できなくなります。

素朴な発想として、アウトライン化したパスに不可視のテキストを重ねることで、見える内容は固定しつつテキストを選択可能にできるはずです。パスと元になった`text`要素はグループにまとめておくのがよいでしょう。

1. ［オブジェクト＞グループ化］
2. 「レイヤーとオブジェクト」パネルで、グループ内に移動したテキストオブジェクトを選択
3. ［（右クリック）＞複製］
4. 上にあるほうを選択して［パス＞オブジェクトをパスへ］（上にあるものが勝つ）

`text`要素を不可視にする方法はいくつか考えられますが、それぞれに制限があります。

まず、`display:none`（「レイヤーとオブジェクト」パネルで目のアイコンをクリック）では、`text`要素を削除してアウトライン化した場合と同様にテキストの選択が無効になります。

<figure>
<figcaption><code>display:none</code></figcaption>
<img src="outline-display-none.svg">
</figure>

続いて、`display`は既定値のまま`opacity: 0`（「レイヤーとオブジェクト」パネルで不透明度を0に設定）にする場合は、選択は可能ですが選択範囲が表示されなくなります。

<figure>
<figcaption><code>opacity: 0</code></figcaption>
<img src="outline-opacity-0.svg">
</figure>

試しに50%程度に設定すると、選択範囲のハイライトの不透明度もオブジェクトの不透明度に従うことが分かります。

<figure>
<figcaption><code>opacity: 50</code></figcaption>
<img src="outline-opacity-50.svg">
</figure>

<figure>
<figcaption>冒頭の画像より明らかに薄い</figcaption>
<img src="outline-opacity-50-select.png">
</figure>

`fill-opacity: 0`であれば、`text`要素を不可視にしつつ選択範囲のハイライトを維持できました。InkscapeのUIからはこの設定ができないため、［編集＞XMLエディタ］を開き、`text`要素の`style`に`fill-opacity: 0`を手動で加えてください。

<figure>
<figcaption><code>fill-opacity: 0</code></figcaption>
<img src="outline-fill-opacity-0.svg">
</figure>

DevToolsで`path`要素を削除すれば、確かに`text`要素は透明になっていることが分かります。

<figure>
<figcaption>透明な文字も検索にはヒットする</figcaption>
<img src="outline-fill-opacity-0-search.png">
</figure>

## ディスクのフルバックアップイメージをマウントする

```
$ mkdir -p /path/to/mount
$ kpartx -av /path/to/hdd.img
$ mount -o ro /dev/mapper/loop0pX /path/to/mount
```

### アンマウント手順

```
$ umount /path/to/mount
$ kpartx -d /path/to/hdd.img
$ rm -rf /path/to/mount
```

## AppImageを手動でインストールする（Ubuntu 24.04）

```
$ mkdir ~/.local/bin/arduino-ide && cd ~/.local/bin/arduino-ide/
$ mv ~/Downloads/arduino-ide_2.3.6_Linux_64bit.AppImage .
$ chmod +x arduino-ide_2.3.6_Linux_64bit.AppImage
$ ./arduino-ide_2.3.6_Linux_64bit.AppImage --appimage-extract
$ chmod +x ~/.local/bin/arduino-ide/squashfs-root/arduino-ide.desktop
$ ln -s ~/.local/bin/arduino-ide/squashfs-root/arduino-ide.desktop ~/.local/share/applications/arduino-ide.desktop
$ cat ~/.local/share/applications/arduino-ide.desktop 
[Desktop Entry]
Name=Arduino IDE
Exec=AppRun --no-sandbox %U
Terminal=false
Type=Application
Icon=arduino-ide
StartupWMClass=Arduino IDE
X-AppImage-Version=2.3.6
Comment=Arduino IDE
Categories=Development;
$ nano ~/.local/share/applications/arduino-ide.desktop 
$ cat ~/.local/share/applications/arduino-ide.desktop 
[Desktop Entry]
Name=Arduino IDE
Exec=/home/mukai/.local/bin/arduino-ide/arduino-ide_2.3.6_Linux_64bit.AppImage --no-sandbox %U
Terminal=false
Type=Application
Icon=/home/mukai/.local/bin/arduino-ide/squashfs-root/arduino-ide.png
StartupWMClass=Arduino IDE
X-AppImage-Version=2.3.6
Comment=Arduino IDE
Categories=Development;
```

- `*.desktop`には実行権限が必要
- `*.desktop`が正しい`Exec`/`Icon`を指しているか確認する。
  - `~/`を解釈しないので注意
  - `Exec`はパスが通っていればコマンド名でいい。通っていなければ絶対パスで指定
  - `Icon`は絶対パスで指定

### Arduino IDE

展開済み`squashfs-root`内の実行ファイルを実行すればよいと思うのだが、これはAppImage内部の特定の手順で実行することを前提としているようだ。

```
$ /home/mukai/.local/bin/arduino-ide/squashfs-root/AppRun --no-sandbox
/home/mukai/.local/bin/arduino-ide/squashfs-root/AppRun: 行 45: /arduino-ide: そのようなファイルやディレクトリはありません
```

これなら起動する。

```
$ APPDIR="/home/mukai/.local/bin/arduino-ide/squashfs-root" /home/mukai/.local/bin/arduino-ide/squashfs-root/AppRun --no-sandbox
```

`*.desktop`で環境変数を指定して起動することはできないらしい。また、`APPDIR`以外にも内部環境変数を利用するのかもしれない。おとなしく`*.AppImage`を直接実行するように編集した。

## RDPメモ

- https://github.com/stascorp/rdpwrap
- https://github.com/sebaxakerhtc/rdpwrap.ini
- https://qiita.com/nak435/items/800dbda782f4fe9c7df1

```
PS > Set-Location Download
PS > Invoke-WebRequest -Uri https://github.com/stascorp/rdpwrap/releases/download/v1.6.2/RDPWrap-v1.6.2.zip -OutFile RDPWrap-v1.6.2.zip
PS > Expand-Archive -Path RDPWrap-v1.6.2.zip -DestinationPath ..\RDPWrap-v1.6.2
PS > Remove-Item .\RDPWrap-v1.6.2.zip
PS > Set-Location ..\RDPWrap-v1.6.2
PS > New-Item -Type Directory rdpwrap.ini.backup
PS > Invoke-WebRequest -Uri https://raw.githubusercontent.com/sebaxakerhtc/rdpwrap.ini/7c699d5bc5adde603e4d12b68b24a2d234b68eb5/rdpwrap.ini -OutFile rdpwrap.ini.backup/rdpwrap.ini.7c699d5bc5adde603e4d12b68b24a2d234b68eb5
PS > sudo .\install.bat
...
OK

[+] Successfully installed.
______________________________________________________________

You can check RDP functionality with RDPCheck program.
Also you can configure advanced settings with RDPConf program.

続行するには何かキーを押してください . . .
PS > sudo .\update.bat
RDP Wrapper Library v1.6.2
Installer v2.5
Copyright (C) Stas'M Corp. 2017

[*] Checking for updates...
[*] Current update date: 2018.10.10
[*] Latest update date:  2018.10.10
[*] Everything is up to date.

続行するには何かキーを押してください . . .
PS > sudo net stop termservice
Remote Desktop Services サービスを停止中です.
Remote Desktop Services サービスは正常に停止されました。

PS > Copy-Item 'C:\Program Files\RDP Wrapper\rdpwrap.ini' .\rdpwrap.ini.backup\
PS > sudo pwsh -Command "Copy-Item .\rdpwrap.ini.backup\rdpwrap.ini.7c699d5bc5adde603e4d12b68b24a2d234b68eb5 'C:\Program Files\RDP Wrapper\rdpwrap.ini'"
PS > sudo net start termservice
Remote Desktop Services サービスを開始します.
Remote Desktop Services サービスは正常に開始されました。

PS > .\RDPConf.exe
```

`Listener state: Listening`を確認

```
PS > (Invoke-WebRequest -Uri 'https://api64.ipify.org').Content
```

## `text-box`メモ

```json
  "scripts": {
    "install:browser":"node -e \"process.env.PLAYWRIGHT_BROWSERS_PATH='.playwright';const {spawnSync}=require('child_process');const opts={shell:true,stdio:'inherit'};spawnSync('npx',['playwright','install-deps'],opts);spawnSync('npx',['playwright','install'],opts)\"",
    "vivliostyle":"node -e \"const {spawnSync}=require('child_process');const opts={shell:true,stdio:'inherit'};const fs=require('fs');const path=require('path');spawnSync('npx',['vivliostyle',...process.argv.slice(1),'--executable-browser',(function find(dir){return fs.readdirSync(dir,{withFileTypes:true}).flatMap(entry=>{const fullPath=path.join(dir,entry.name);return entry.isDirectory()?find(fullPath):path.basename(entry.name, path.extname(entry.name)).toLowerCase()==='chrome'&&(process.platform==='win32'?process.env.PATHEXT.split(path.delimiter).map(ext=>ext.toUpperCase()).includes(path.extname(fullPath).toUpperCase()):(fs.statSync(fullPath).mode&0o111)!==0)?[fullPath]:[];});})('.playwright')[0]],opts)\""
  },
```

`package-lock.json`をいじって`npm ci`でも良いかも。

<table>
<tr><td></td><td></td><th colspan="3">直前</th></tr>
<tr><td></td><td></td><th><code>p</code></th><th><code>p</code>以外</th><th>なし</th></tr>
<tr><th rowspan="3">直後</th><th><code>p</code></th><td><code>none</code></td><td><code>trim-start</code></td><td><code>trim-start</code></td></tr>
<tr><th><code>p</code>以外</th><td><code>trim-end</code></td><td><code>trim-both</code></td><td><code>trim-both</code></td></tr>
<tr><th>なし</th><td><code>trim-end</code></td><td><code>trim-both</code></td><td><code>trim-both</code></td></tr>
</table>

こんな感じか……？

```css
p {
    margin: 0;
    text-align: justify;
    text-indent: 1em;
    text-spacing: auto;
    widows: 1;
    orphans: 1;
}

p:first-child:has(+ p), /* コンテナの先頭かつ直後がpである */
:not(p) + p:has(+ p) {  /* 直前にp以外を持ち、かつ直後がpである */
    color: red;
    text-box: trim-start cap alphabetic;
}

p + p:has(+ :not(p)), /* 直前がpであり、かつ直後がp以外である */
p + p:last-child {    /* 直前がpであり、かつコンテナの最後の要素である */
    color: green;
    text-box: trim-end cap alphabetic;
}

:not(p) + p:has(+ :not(p)),/* 前後がpではない */
:not(p) + p:last-child {   /* 直前がpではなく、かつコンテナの最後である */
    color: aqua;
    text-box: trim-both cap alphabetic;
}
```

## トラックポイントキャップを買い換える

https://www.lenovo.com/jp/ja/dc/accessories-and-software/keyboards-and-mice/trackpoint-caps/

3種類ある

- Low Profile
- ロープロファイル
- スーパーロープロファイル

1つ目と2つ目の違いは？

どれに該当するかは以下で検索

https://support.lenovo.com/jp/ja/accessorieslookup

| 品番 | プロファイル |
| --- | --- |
| 20KG | スーパーロープロファイル |
| 20QE | ロープロファイル |
| 21KC | ロープロファイル |

参照：https://support.lenovo.com/jp/ja/solutions/um006391-accessories-and-options-compatibility-matrix-ocm

## Native Accessのアップデートを阻止する

Native Access 3.7.0ならWineで起動できそうだ。

- https://appdb.winehq.org/objectManager.php?sClass=application&iId=19265

<details>

<!-- timestamp: 20231125121751 -->

- おおむね書いてある通りの操作で実行できた（Ubuntu 24.04 / wine-9.21 (Staging)）。手間取って以下の試行錯誤をした。
  - （順番通りに行えばおそらく不要）`~/.local/share/applications/Native\ Access.desktop`の末尾に`MimeType=x-scheme-handler/native-access`を追記した
  - （順番通りに行えばおそらく不要）`update-desktop-database ~/.local/share/applications/`を実行した
  - `xdg-mime query default x-scheme-handler/native-access`で正しく登録されているかわかる
  - `NTKDaemon`はアプリケーションではなくサービスだから、exeを直接実行するのではなく、`$ WINEPREFIX=~/.wineprefixes/Native-Access_2_3.7.0 wine net start NTKDaemonService`で開始するはず。[参考](https://support.native-instruments.com/hc/ja/articles/5706203334161-Native-Access-%E3%81%8C%E8%B5%B7%E5%8B%95%E6%99%82%E3%81%AB-Installing-Dependencies-%E3%81%A7%E3%83%95%E3%83%AA%E3%83%BC%E3%82%BA%E3%81%97%E3%81%A6%E3%81%97%E3%81%BE%E3%81%86)
- 執筆時点の最新版である3.17.0は、3.7.0のコメントにある通りwinetricksでvcrun2022をインストールすれば起動した。
  - 別途ダウンロード方式のライブラリを追加する際に「Could not add library」と表示され追加できないため断念した。
- Kontakt 8 Playerはインストールできないようだ。デバッグログを見たら何かわかるか？
  - この症状 https://www.reddit.com/r/winehq/comments/1hyev6y/im_trying_to_install_native_instruments_kontakt_8/
- 7も厳しいかも。Native Accessでlocate済みのライブラリを読み込まない（yabridge 5.1.1）。よそでは動作しているらしいので要検証

</details>

ということで勝手にバージョンが上がってほしくない。当て勘で関連ファイルを漁ってみたところ、この`updaterCacheDirName`ディレクトリが臭う。

```
$ cat ~/.wineprefixes/Native-Access_2_3.7.0/drive_c/Program\ Files/Native\ Instruments/Native\ Access/resources/app-update.yml 
provider: generic
channel: latest
url: https://na-update.native-instruments.com
updaterCacheDirName: nativeaccess2-updater
```

旧バージョンを起動しているとウィンドウ右上にアップデートを促すメッセージが出現する。

![アップデートを促すメッセージ](image-000.png)

この状態で、`updaterCacheDirName`を探してみる。

```
$ find ~/.wineprefixes/Native-Access_2_3.7.0/drive_c/ -name nativeaccess2-updater
/home/mukai/.wineprefixes/Native-Access_2_3.7.0/drive_c/users/mukai/AppData/Local/nativeaccess2-updater

$ tree ~/.wineprefixes/Native-Access_2_3.7.0/drive_c/users/mukai/AppData/Local/nativeaccess2-updater
/home/mukai/.wineprefixes/Native-Access_2_3.7.0/drive_c/users/mukai/AppData/Local/nativeaccess2-updater
└── pending
    ├── Native-Access.exe
    └── update-info.json

2 directories, 2 files
```

消してみる。

```
$ rm -rf ~/.wineprefixes/Native-Access_2_3.7.0/drive_c/users/mukai/AppData/Local/nativeaccess2-updater
```

Native Accessを［x］で終了して再度起動すると、目論見通りアップデートされずに保たれているようだ。

![バージョンは3.7.0](image-001.png)

書き込み・削除禁止にしておけばよいはず。

```
$ mkdir -p ~/.wineprefixes/Native-Access_2_3.7.0/drive_c/users/mukai/AppData/Local/nativeaccess2-updater
$ sudo chattr +i ~/.wineprefixes/Native-Access_2_3.7.0/drive_c/users/mukai/AppData/Local/nativeaccess2-updater
```

さすがにディレクトリを変えたりするほど器用ではないらしい。

## Vivliostyle CLIでフォルダ内のMarkdownを1ファイルにまとめて組版するスニペット

ファイルをまたぐと改ページされてしまうが、節ごとにファイルを分割したい時もある。最近だと、ファイルは短いほどAIの補助を受けやすそうだ。

watch.jsから`entry`をインポートする際、副作用で1回結合処理が走る。watch.jsをエントリポイントにすると監視を開始する。バックグラウンド実行は`Start-Job`なり`nohup`なりでうまくやる。

ESMなら`process.argv[1] === url.fileURLToPath(import.meta.url)`で同じことができるらしい。

<figure>
<figcaption>watch.js</figcaption>

```js
// @ts-check

/*
 * ```
 * > $job=Start-Job { node watch.js }
 * > npx vivliostyle preview
 * ...
 * > Remove-Job $job -Force
 * ```
 *
 * ```
 * $ node watch.js &
 * $ WATCH_PID=$!
 * $ npx vivliostyle preview
 * ...
 * $ kill $WATCH_PID
 * ```
 */

const fs = require("node:fs");
const path = require("node:path");

const manuscripts = {
  "01-foo": [
    "01-bar.md",
    "02-baz.md",
  ],
  "02-qux": ["01-quux.md"],
};

exports.entry = Object.keys(manuscripts).map((dir) => `${dir}.md`);

/**
 * @param {string[]} lines
 */
function trimEmptyTopAndBottom(lines) {
  const start = lines.findIndex((line) => line.trim() !== "");
  const end =
    lines.length - [...lines].reverse().findIndex((line) => line.trim() !== "");
  return start === -1 ? [] : lines.slice(start, end);
}

/**
 * @param {string[]} filenames
 */
function concatFiles(filenames) {
  return filenames
    .reduce((/** @type {string[]} */ blocks, filename) => {
      const content = fs.readFileSync(filename, "utf-8");
      const lines = content.split(/\r?\n/);
      const trimmedLines = trimEmptyTopAndBottom(lines);
      return trimmedLines.length === 0
        ? blocks
        : blocks.concat(blocks.length > 0 ? [""] : [], trimmedLines);
    }, [])
    .concat([""])
    .join("\n");
}

// Debounce per file to avoid duplicate "change" events, especially in editors like VS Code.
const DEBOUNCE_MS = 100;
const debounceTimers = new Map();

for (const [dirname, filenames] of Object.entries(manuscripts)) {
  const filepaths = filenames.map((filename) =>
    path.posix.join(dirname, filename)
  );
  fs.writeFileSync(`${dirname}.md`, concatFiles(filepaths), {
    encoding: "utf-8",
  });

  if (require.main === module) {
    for (const filepath of filepaths) {
      fs.watch(filepath, (eventType) => {
        if (eventType !== "change") {
          return;
        }

        if (debounceTimers.has(filepath)) {
          clearTimeout(debounceTimers.get(filepath));
        }
        debounceTimers.set(
          filepath,
          setTimeout(() => {
            debounceTimers.delete(filepath);
            console.log(`[${new Date().toISOString()}] Rebuild ${dirname}.md`);
            fs.writeFileSync(`${dirname}.md`, concatFiles(filepaths), {
              encoding: "utf-8",
            });
          }, DEBOUNCE_MS)
        );
      });
    }
  }
}
```

</figure>
<figure>
<figcaption>vivliostyle.config.js</figcaption>

```js
// @ts-check

const { entry } = require("./watch.js");

/** @type {import('@vivliostyle/cli').VivliostyleConfigSchema} */
const vivliostyleConfig = {
  title: "title",
  author: "author",
  language: "ja",
  theme: "./css",
  image: "ghcr.io/vivliostyle/cli:8.19.0",
  entry,
  output: ["./output.pdf"],
  workspaceDir: ".vivliostyle",
};

module.exports = vivliostyleConfig;
```

</figure>

## Vivliostyle×devcontainerメモ

- https://code.visualstudio.com/docs/devcontainers/containers
- WindowsではWSL経由で良い感じになるので何もしなくてよい
- MacではXQuartzが必要。インストールして再ログインするだけ

#### .devcontainer/Dockerfile

```
FROM ghcr.io/vivliostyle/cli:8.20.0
# RUN apt-get update && apt-get --yes --no-install-recommends install \
#         foo \
#     && rm -rf /var/lib/apt/lists/*
ENTRYPOINT ["/usr/bin/bash"]
```

#### .devcontainer/devcontainer.json

```json
{
  "build": {
    "dockerfile": "./Dockerfile",
    "context": "."
  },
  "customizations": {
    "vscode": {
      "extensions": ["esbenp.prettier-vscode"]
    }
  }
}
```

## ChromiumとGhostscriptで表現できる色

5桁の固定小数点で表しているようだ。大した精度ではないな……。

ChromiumでそうなのかGhostscriptでそうなのかはよくわからない。

```javascript
// @ts-check

import child_process from "node:child_process";
import fs from "node:fs";
import os from "node:os";
import { fileURLToPath } from "node:url";
import {
  Worker,
  isMainThread,
  parentPort,
  workerData,
} from "node:worker_threads";

import { Decimal } from "decimal.js";
import { chromium } from "playwright";

if (isMainThread) {
  // ---- Main thread ----

  /**
   * @param {number} bits
   * @param {{ precision?: number }} opts
   */
  function* steps(bits, opts = {}) {
    const precision = opts.precision || 50;
    const D = Decimal.clone({ precision });
    const max = new D(2).pow(bits).minus(1);
    for (let i = new D(0); i.lessThanOrEqualTo(max); i = i.plus(1)) {
      yield i.div(max).toFixed(precision);
    }
  }

  const cpuCount = os.cpus().length;
  const allSteps = Array.from(steps(16, { precision: 50 }));
  /** @type {string[][]} */
  const chunks = Array.from({ length: cpuCount }, () => []);
  allSteps.forEach((step, i) => chunks[i % cpuCount].push(step));

  /** @type {[Set<string>, Set<string>, Set<string>]} */
  const actualSteps = [new Set(), new Set(), new Set()];

  await Promise.all(
    chunks.map(
      (chunk) =>
        /** @type {Promise<void>} */ (
          new Promise((resolve, reject) => {
            const worker = new Worker(fileURLToPath(import.meta.url), {
              workerData: chunk,
            });
            worker.on("message", (partial) => {
              for (let i = 0; i < 3; i++) {
                for (const v of partial[i]) {
                  actualSteps[i].add(v);
                }
              }
              resolve();
            });
            worker.on("error", reject);
            worker.on("exit", (code) => {
              if (code !== 0)
                reject(new Error(`Worker exited with code ${code}`));
            });
          })
        )
    )
  );

  fs.writeFileSync(
    "output.json",
    JSON.stringify(
      actualSteps.map((s) => Array.from(s).sort()),
      null,
      2
    )
  );
} else {
  // ---- Worker thread ----

  /** @type {string[]} */
  const steps = workerData;
  /** @type {[Set<string>, Set<string>, Set<string>]} */
  const partialSteps = [new Set(), new Set(), new Set()];

  const browser = await chromium.launch();
  try {
    for (const c of steps) {
      const page = await browser.newPage();
      await page.setContent(
        `<html><body style="background-color: color(srgb ${c} ${c} ${c})"></body></html>`,
        { waitUntil: "load" }
      );
      const pdf = await page.pdf({
        width: "10px",
        height: "10px",
        printBackground: true,
      });
      new TextDecoder()
        .decode(
          child_process.spawnSync(
            "gswin64c",
            ["-dBATCH", "-dNOPAUSE", "-dPDFDEBUG", "-sDEVICE=nullpage", "-"],
            { input: pdf }
          ).stderr
        )
        .split("\n")
        .map((line) => line.trim())
        .filter((line) => line.endsWith("rg") || line.endsWith("RG"))
        .forEach((line) => {
          const [r, g, b] = line.split(" ").slice(0, 3);
          partialSteps[0].add(r);
          partialSteps[1].add(g);
          partialSteps[2].add(b);
        });
      await page.close();
    }
  } finally {
    await browser.close();
  }

  parentPort?.postMessage(partialSteps.map((s) => Array.from(s)));
}
```

```jsonc
[
  [
    "0",
    "0.000100",
    "0.000200",
    "0.000300",
    "0.000400",
    "0.000500",
    "0.000600",
    "0.000700",
    "0.000800",
    "0.000900",
    "0.001000",
    "0.001100",
    // ...
    "0.999600",
    "0.999700",
    "0.999800",
    "0.999900",
    "1"
  ]
  // ...
]
```

```
> json[0].length
10001
> JSON.stringify(json[0])===JSON.stringify(json[1])
true
> JSON.stringify(json[1])===JSON.stringify(json[2])
true
```

## woff2.dockerfile

```
FROM ubuntu:24.04

RUN apt-get update \
    && apt-get install --yes \
        cmake \
        g++ \
        git \
        pkg-config \
    && rm -rf /var/lib/apt/lists/* \
    \
    && git init woff2 \
    && cd woff2/ \
    && git remote add origin https://github.com/google/woff2.git \
    && git fetch --depth 1 origin 0f4d304faa1c62994536dc73510305c7357da8d4 \
    && git checkout FETCH_HEAD \
    && git submodule update --init --recursive \
    \
    # https://github.com/google/brotli/tree/533843e3546cd24c8344eaa899c6b0b681c8d222
    && cd brotli \
    && mkdir out \
    && cd out \
    && cmake -DCMAKE_BUILD_TYPE=Release .. \
    && cmake --build . --config Release --target install \
    && cd ../.. \
    \
    # https://github.com/google/woff2/tree/0f4d304faa1c62994536dc73510305c7357da8d4
    && mkdir out-static \
    && cd out-static \
    && cmake -DBUILD_SHARED_LIBS=OFF .. \
    && make \
    && make install
```

## Emscriptenのdevcontainer環境

Dockerfileと補完とフォーマットの設定

#### .devcontainer/emscripten.dockerfile

```
FROM emscripten/emsdk:4.0.8
RUN apt-get update && apt-get --yes --no-install-recommends install \
        clang-format \
    && rm -rf /var/lib/apt/lists/*
```

#### .devcontainer/devcontainer.json

```json
{
    "build": {
        "dockerfile": "./Dockerfile",
        "context": "."
    },
    "customizations": {
        "vscode": {
            "extensions": [
                "ms-vscode.cpptools-extension-pack",
                "xaver.clang-format"
            ]
        }
    }
}
```

### .vscode/c_cpp_properties.json

```json
{
    "configurations": [
        {
            "name": "CMake",
            "compileCommands": "${config:cmake.buildDirectory}/compile_commands.json",
            "configurationProvider": "ms-vscode.cmake-tools",
            "includePath": ["/emsdk/upstream/emscripten/system/include/**"]
        }
    ],
    "version": 4
}
```

### .vscode/settings.json

```json
{
    "[c]": {
        "editor.formatOnSave": true,
        "editor.defaultFormatter": "xaver.clang-format"
    },
    "[cpp]": {
        "editor.formatOnSave": true,
        "editor.defaultFormatter": "xaver.clang-format"
    },
    "files.associations": {
        "emscripten.h": "c"
    }
}
```

## GhostscriptをWASMにしたい

```
$ docker run --rm --interactive --tty --mount type=bind,source="$(pwd)",target=/workdir --entrypoint /bin/bash --workdir /workdir emscripten/emsdk:4.0.8
```

### ps-wasm

<details>
<summary><a href="https://raw.githubusercontent.com/ochachacha/ps-wasm/2dfe3f2feaf4435e476abb13936272419ab12bec/README.md">README.md</a></summary>

> Note on cross-compilation:
> 
> Cross-compiling ghostscript was the nontrivial part of this project.
> 
> After obtaining the source code from the [source repository](https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs926/ghostscript-9.26.tar.gz), one needs to copy files in the "code_patch" folder into their respective places.
> 
> One also needs to have the EMScripten environment set up; see [here](https://webassembly.org/getting-started/developers-guide/) for a tutorial.
> 
> Then one can run the following command for setting up configure:
> 
> `emconfigure ./configure --disable-threading --disable-cups --disable-dbus --disable-gtk --with-drivers=PS CC=emcc CCAUX=gcc --with-arch_h=~/ghostscript-9.26/arch/wasm.h`
> 
> Followed by the following "make" command:
> 
> `emmake make XE=".html" GS_LDFLAGS="-s ALLOW_MEMORY_GROWTH=1 -s EXIT_RUNTIME=1"`
> 
> And one needs to copy everything from the "bin" folder to the extension folder.
> 
> To include debugging information, instead use the following command, and look for results in "debugbin" (make sure you also copy the map files into the extension folder):
> 
> `emmake make debug XE=".html" GS_LDFLAGS="-s ALLOW_MEMORY_GROWTH=1 -s EXIT_RUNTIME=1 -s ASSERTIONS=2 -g4"`

</details>

#### ダウンロード

```
# wget https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs926/ghostscript-9.26.tar.gz
# tar xvf ghostscript-9.26.tar.gz
# wget https://github.com/ochachacha/ps-wasm/archive/2dfe3f2feaf4435e476abb13936272419ab12bec.zip
# unzip 2dfe3f2feaf4435e476abb13936272419ab12bec.zip
# mv ps-wasm-2dfe3f2feaf4435e476abb13936272419ab12bec ps-wasm
```

#### 差分の検証

`code_patch/arch/wasm.h`はそのまま使えそう。

```
# ls ghostscript-9.26/arch/
arch_autoconf.h.in  osx-x86-x86_64-ppc-gcc.h  windows-arm-msvc.h  windows-x64-msvc.h  windows-x86-msvc.h
```

windows-x64から編集したらしいが、結果的にwindows-x86の設定と同じもののようだ。

```
# diff --unified ghostscript-9.26/arch/windows-x86-msvc.h ps-wasm/code_patch/arch/wasm.h
```

```diff
--- ghostscript-9.26/arch/windows-x86-msvc.h    2018-11-20 10:08:19.000000000 +0000
+++ ps-wasm/code_patch/arch/wasm.h      2023-05-03 03:53:58.000000000 +0000
@@ -13,7 +13,7 @@
    CA 94945, U.S.A., +1(415)492-9861, for further information.
 */
 /* Parameters derived from machine and compiler architecture. */
-/* This file was generated mechanically by genarch.c, for a 32bit */
+/* This file was generated mechanically by genarch.c, for a 64bit */
 /* Microsoft Windows machine, compiling with MSVC. */

         /* ---------------- Scalar alignments ---------------- */
@@ -56,3 +56,4 @@
 #define ARCH_FLOATS_ARE_IEEE 1
 #define ARCH_ARITH_RSHIFT 2
 #define ARCH_DIV_NEG_POS_TRUNCATES 1
+
```

```
# diff --unified ghostscript-9.26/arch/windows-x64-msvc.h ps-wasm/code_patch/arch/wasm.h
```

```diff
--- ghostscript-9.26/arch/windows-x64-msvc.h    2018-11-20 10:08:19.000000000 +0000
+++ ps-wasm/code_patch/arch/wasm.h      2023-05-03 03:53:58.000000000 +0000
@@ -21,7 +21,7 @@
 #define ARCH_ALIGN_SHORT_MOD 2
 #define ARCH_ALIGN_INT_MOD 4
 #define ARCH_ALIGN_LONG_MOD 4
-#define ARCH_ALIGN_PTR_MOD 8
+#define ARCH_ALIGN_PTR_MOD 4
 #define ARCH_ALIGN_FLOAT_MOD 4
 #define ARCH_ALIGN_DOUBLE_MOD 8

@@ -36,7 +36,7 @@
 #define ARCH_SIZEOF_GX_COLOR_INDEX 8
 #endif

-#define ARCH_SIZEOF_PTR 8
+#define ARCH_SIZEOF_PTR 4
 #define ARCH_SIZEOF_FLOAT 4
 #define ARCH_SIZEOF_DOUBLE 8
 #define ARCH_FLOAT_MANTISSA_BITS 24
```

`code_patch/base/gxfapi.h`の意図はなんだ？これは不要かも。

```
# diff --unified ghostscript-9.26/base/gxfapi.h ps-wasm/code_patch/base/gxfapi.h
```

```diff
--- ghostscript-9.26/base/gxfapi.h      2018-11-20 10:08:19.000000000 +0000
+++ ps-wasm/code_patch/base/gxfapi.h     2023-05-03 03:53:58.000000000 +0000
@@ -407,7 +407,7 @@
                                 basefont->FontType == ft_encrypted2 ||\
                                 basefont->FontType == ft_CID_encrypted)

-typedef int (*gs_fapi_get_server_param_callback) (gs_fapi_server *I,
+typedef void (*gs_fapi_get_server_param_callback) (gs_fapi_server *I, // this signature was wrong
                                                   const char *subtype,
                                                   char **server_param,
                                                   int *server_param_size);
```

`code_patch/base/unix-gcc.mak`は`pipe.dev`を削除しているようだ。これは妥当そう。

```
# diff --unified ghostscript-9.26/base/unix-gcc.mak ps-wasm/code_patch/base/unix-gcc.mak
```

```diff
--- ghostscript-9.26/base/unix-gcc.mak  2018-11-20 10:08:19.000000000 +0000
+++ ps-wasm/code_patch/base/unix-gcc.mak        2023-05-03 03:53:58.000000000 +0000
@@ -515,9 +515,9 @@

 XPS_FEATURE_DEVS=$(XPSOBJDIR)/pl.dev $(XPSOBJDIR)/xps.dev

-FEATURE_DEVS=$(GLD)pipe.dev $(GLD)gsnogc.dev $(GLD)htxlib.dev $(GLD)psl3lib.dev $(GLD)psl2lib.dev \
+FEATURE_DEVS=$(GLD)gsnogc.dev $(GLD)htxlib.dev $(GLD)psl3lib.dev $(GLD)psl2lib.dev \
              $(GLD)dps2lib.dev $(GLD)path1lib.dev $(GLD)patlib.dev $(GLD)psl2cs.dev $(GLD)rld.dev $(GLD)gxfapiu$(UFST_BRIDGE).dev\
-             $(GLD)ttflib.dev  $(GLD)cielib.dev $(GLD)pipe.dev $(GLD)htxlib.dev $(GLD)sdct.dev $(GLD)libpng.dev\
+             $(GLD)ttflib.dev  $(GLD)cielib.dev $(GLD)htxlib.dev $(GLD)sdct.dev $(GLD)libpng.dev\
             $(GLD)seprlib.dev $(GLD)translib.dev $(GLD)cidlib.dev $(GLD)psf0lib.dev $(GLD)psf1lib.dev\
              $(GLD)psf2lib.dev $(GLD)lzwd.dev $(GLD)sicclib.dev \
              $(GLD)sjbig2.dev $(GLD)sjpx.dev $(GLD)ramfs.dev \
@@ -527,9 +527,9 @@


 #FEATURE_DEVS=$(PSD)psl3.dev $(PSD)pdf.dev
-#FEATURE_DEVS=$(PSD)psl3.dev $(PSD)pdf.dev $(PSD)dpsnext.dev $(PSD)ttfont.dev $(GLD)pipe.dev
+#FEATURE_DEVS=$(PSD)psl3.dev $(PSD)pdf.dev $(PSD)dpsnext.dev $(PSD)ttfont.dev
 # The following is strictly for testing.
-FEATURE_DEVS_ALL=$(PSD)psl3.dev $(PSD)pdf.dev $(PSD)dpsnext.dev $(PSD)ttfont.dev $(PSD)double.dev $(PSD)trapping.dev $(PSD)stocht.dev $(GLD)pipe.dev $(GLD)gsnogc.dev $(GLD)htxlib.dev $(PSD)jbig2.dev $(PSD)jpx.dev  $(GLD)ramfs.dev
+FEATURE_DEVS_ALL=$(PSD)psl3.dev $(PSD)pdf.dev $(PSD)dpsnext.dev $(PSD)ttfont.dev $(PSD)double.dev $(PSD)trapping.dev $(PSD)stocht.dev $(GLD)gsnogc.dev $(GLD)htxlib.dev $(PSD)jbig2.dev $(PSD)jpx.dev  $(GLD)ramfs.dev
 #FEATURE_DEVS=$(FEATURE_DEVS_ALL)

 # The list of resources to be included in the %rom% file system.
```

`code_patch/Makefile.in`も、`pipe.dev`を削除しているようだ。

```
# diff --unified ghostscript-9.26/Makefile.in ps-wasm/code_patch/Makefile.in
```

```diff
--- ghostscript-9.26/Makefile.in        2018-11-20 10:08:19.000000000 +0000
+++ ps-wasm/code_patch/Makefile.in      2023-05-03 03:53:58.000000000 +0000
@@ -545,18 +545,18 @@

 XPS_FEATURE_DEVS=$(XPSOBJDIR)/pl.dev $(XPSOBJDIR)/xps.dev

-FEATURE_DEVS=$(GLD)pipe.dev $(GLD)gsnogc.dev $(GLD)htxlib.dev $(GLD)psl3lib.dev $(GLD)psl2lib.dev \
+FEATURE_DEVS=$(GLD)gsnogc.dev $(GLD)htxlib.dev $(GLD)psl3lib.dev $(GLD)psl2lib.dev \
              $(GLD)dps2lib.dev $(GLD)path1lib.dev $(GLD)patlib.dev $(GLD)psl2cs.dev $(GLD)rld.dev $(GLD)gxfapiu$(UFST_BRIDGE).dev\
-             $(GLD)ttflib.dev  $(GLD)cielib.dev $(GLD)pipe.dev $(GLD)htxlib.dev $(GLD)sdct.dev $(GLD)libpng.dev\
+             $(GLD)ttflib.dev  $(GLD)cielib.dev $(GLD)htxlib.dev $(GLD)sdct.dev $(GLD)libpng.dev\
             $(GLD)seprlib.dev $(GLD)translib.dev $(GLD)cidlib.dev $(GLD)psf0lib.dev $(GLD)psf1lib.dev\
              $(GLD)psf2lib.dev $(GLD)lzwd.dev $(GLD)sicclib.dev \
              $(GLD)sjbig2.dev $(GLD)sjpx.dev $(GLD)ramfs.dev \
              $(GLD)pwgd.dev

 #FEATURE_DEVS=$(PSD)psl3.dev $(PSD)pdf.dev
-#FEATURE_DEVS=$(PSD)psl3.dev $(PSD)pdf.dev $(PSD)dpsnext.dev $(PSD)ttfont.dev $(GLD)pipe.dev
+#FEATURE_DEVS=$(PSD)psl3.dev $(PSD)pdf.dev $(PSD)dpsnext.dev $(PSD)ttfont.dev
 # The following is strictly for testing.
-FEATURE_DEVS_ALL=$(PSD)psl3.dev $(PSD)pdf.dev $(PSD)dpsnext.dev $(PSD)ttfont.dev $(PSD)double.dev $(PSD)trapping.dev $(PSD)stocht.dev $(GLD)pipe.dev $(GLD)gsnogc.dev $(GLD)htxlib.dev @JBIG2DEVS@ @JPXDEVS@ @UTF8DEVS@ $(GLD)ramfs.dev
+FEATURE_DEVS_ALL=$(PSD)psl3.dev $(PSD)pdf.dev $(PSD)dpsnext.dev $(PSD)ttfont.dev $(PSD)double.dev $(PSD)trapping.dev $(PSD)stocht.dev $(GLD)gsnogc.dev $(GLD)htxlib.dev @JBIG2DEVS@ @JPXDEVS@ @UTF8DEVS@ $(GLD)ramfs.dev
 #FEATURE_DEVS=$(FEATURE_DEVS_ALL)

 # The list of resources to be included in the %rom% file system.
```

#### ビルド

まずは指示通りやってみる。

```
# cp --recursive --no-target-directory ps-wasm/code_patch ghostscript-9.26
# cd ghostscript-9.26
# emconfigure ./configure --disable-threading --disable-cups --disable-dbus --disable-gtk --with-drivers=PS CC=emcc CCAUX=gcc --with-arch_h=arch/wasm.h
# emmake make --jobs=$(nproc) XE=".html" GS_LDFLAGS="-s ALLOW_MEMORY_GROWTH=1 -s EXIT_RUNTIME=1"
# ls bin/
gs.html  gs.js  gs.wasm
```

もちろんちゃんとビルドできる。

ひとつずつ剥がしていく。まず`emconfigure`を使用する場合はCCの指定は不要。

```
# emconfigure python3 -c "import os; print(os.environ['CC'])"
configure: python3 -c 'import os; print(os.environ['"'"'CC'"'"'])'
/emsdk/upstream/emscripten/emcc
```

`--with-drivers`・`--disable-threading`は不要なのでは？実際外してもビルド可能だ。

`--disable-cups`は？ https://ghostscript.readthedocs.io/en/latest/thirdparty.html の「CUPS (AGPL Release Only) - CUPS raster format output」のことだと思うが。ビルドできているようだ。

じゃあ`--disable-dbus --disable-gtk`も勝手に無効になってくれたりしないか？なるようだ。ビルド、実行ともに問題ない。

`CCAUX`は勝手にGCCになるのでは？そうではないらしい。

```
root@46b7e3a7c55a:/workdir/ghostscript-9.26# cat Makefile | grep CCAUX
CCAUX=/emsdk/upstream/emscripten/emcc
CCAUXLD=$(CCAUX)
CCAUX_=$(CCAUX) $(CCFLAGSAUX)
CCAUX_NO_WARN=$(CCAUX_)
```

`CCAUX`の指定は必須のようだ。

```
root@46b7e3a7c55a:/workdir/ghostscript-9.26# emmake make --jobs=$(nproc) XE=".html" GS_LDFLAGS="-s ALLOW_MEMORY_GROWTH=1 -s EXIT_RUNTIME=1"

...

/emsdk/upstream/emscripten/emcc  -DHAVE_MKSTEMP  -DHAVE_FSEEKO    -DHAVE_SETLOCALE   -DHAVE_BSWAP32 -DHAVE_BYTESWAP_H -DHAVE_STRERROR    -DHAVE_PREAD_PWRITE=1 -DGS_RECURSIVE_MUTEXATTR=PTHREAD_MUTEX_RECURSIVE -O2 -Wall -Wstrict-prototypes -Wundef -Wmissing-declarations -Wmissing-prototypes -Wwrite-strings -fno-strict-aliasing -Werror=declaration-after-statement -fno-builtin -fno-common -Werror=return-type -DHAVE_STDINT_H=1 -DHAVE_DIRENT_H=1 -DHAVE_SYS_DIR_H=1 -DHAVE_SYS_TIME_H=1 -DHAVE_SYS_TIMES_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_LIBDL=1 -DGX_COLOR_INDEX_TYPE="unsigned long long" -D__USE_UNIX98=1 -DGS_MEMPTR_ALIGNMENT=8   -DHAVE_RESTRICT=1 -fno-strict-aliasing -DHAVE_POPEN_PROTO=1    -I./ijs   -o ./obj/ijs_server.o -c ./ijs/ijs_server.c
./obj/aux/echogs: 1: Syntax error: word unexpected (expecting "then")
make: *** [base/ijs.mak:79: obj/ijs.o] Error 2
make: *** Waiting for unfinished jobs....
2 warnings generated.
1 warning generated.
emmake: error: 'make --jobs=14 XE=.html 'GS_LDFLAGS=-s ALLOW_MEMORY_GROWTH=1 -s EXIT_RUNTIME=1'' failed (returned 2)
```

最終的に残ったコマンドは以下の通り。

```
# emconfigure ./configure CCAUX=gcc --with-arch_h=arch/wasm.h
# emmake make --jobs=$(nproc) XE=".html" GS_LDFLAGS="-s ALLOW_MEMORY_GROWTH=1 -s EXIT_RUNTIME=1"
```

続いてconfigureのこの部分を解消したい。でもlibjpeg（`jpeg/`）とかプロジェクトルートにあるので、無視してよいのでは？

```
 Support for external codecs:
  ZLIB support:                       no
  Pixar log-format algorithm:         no
  JPEG support:                       no
  Old JPEG support:                   no
  JPEG 8/12 bit dual mode:            no
  ISO JBIG support:                   no
  LZMA2 support:                      no
```

一見archは不要そうだが`gs.wasm`が生成されない……

`MODULARIZE`したい

https://emscripten.org/docs/tools_reference/settings_reference.html#modularize

```
# emmake make --jobs=$(nproc) XE=".js" GS_LDFLAGS="-s ALLOW_MEMORY_GROWTH=1 -s MODULARIZE=1 -s EXPORT_ES6=1 -s FORCE_FILESYSTEM=1 -s INVOKE_RUN=0 -s EXPORTED_RUNTIME_METHODS=['FS','callMain']"
```

```js
// @ts-check

import fs from "node:fs";

import Module from "./gs.js";

/**
 * @param {{args:string[];stdin:Uint8Array;inputFiles:{filePath:string;content:Uint8Array;}[];outputFilePaths:string[]}} param0
 */
async function ghostscript({ args, stdin, inputFiles, outputFilePaths }) {
  /** @type {{src:"stdout"|"stderr";charCode:number;}[]} */
  const outputStreams = [];
  let stdinOffset = 0;

  const module = await Module({
    preRun(mod) {
      // https://emscripten.org/docs/api_reference/Filesystem-API.html#FS.init
      mod.FS.init(
        /** @type {()=>number|null} */
        () => (stdinOffset < stdin.length ? stdin[stdinOffset++] : null),
        /** @type {(charCode:number)=>void} */
        (charCode) => {
          if (charCode !== null)
            outputStreams.push({ src: "stdout", charCode });
        },
        /** @type {(charCode:number)=>void} */
        (charCode) => {
          if (charCode !== null)
            outputStreams.push({ src: "stderr", charCode });
        }
      );
    },
  });

  for (const { filePath, content } of inputFiles) {
    module.FS.writeFile(filePath, content);
  }

  // https://github.com/emscripten-core/emscripten/pull/14865
  const exitCode = module.callMain(args);

  /** @type {{[filePath:string]:Uint8Array}} */
  const outputFiles = {};
  for (const filePath of outputFilePaths) {
    outputFiles[filePath] = module.FS.readFile(filePath);
  }

  return { exitCode, outputStreams, outputFiles };
}

const ret = await ghostscript({
  args: [
    "-dBATCH",
    "-dNOPAUSE",
    "-dSAFER",
    "-sDEVICE=png16m",
    "-r300",
    "-sOutputFile=/output.png",
    "/input.pdf",
  ],
  stdin: new Uint8Array([]),
  inputFiles: [
    { filePath: "/input.pdf", content: fs.readFileSync("input.pdf") },
  ],
  outputFilePaths: ["/output.png"],
});

fs.writeFileSync("output.png", ret.outputFiles["/output.png"]);

const log = new TextDecoder().decode(
  new Uint8Array(ret.outputStreams.map(({ charCode }) => charCode))
);
console.log(log);
```

## PDF内のビットマップ画像を別の画像に置換するそこそこまともな方法

### Python

- https://stackoverflow.com/questions/34937871/how-can-i-replace-image-in-pdf-programmatically-using-command-line-ideally

```python
import typing
import pymupdf

class PDFImage(typing.NamedTuple):
    """
    https://pymupdf.readthedocs.io/ja/latest/document.html#Document.get_page_images
    """
    xref: int
    smask: int
    width: int
    height: int
    bpc: int
    colorspace: str
    alt_colorspace: str
    name: str
    filter:str
    referencer: int

doc = pymupdf.open("output.pdf")
page = doc[0]
img_list = list(map(lambda x: PDFImage(*x), page.get_images(full=True)))

print(img_list)
# [PDFImage(xref=4, smask=0, width=128, height=128, bpc=8, colorspace='ICCBased', alt_colorspace='', name='X4', filter='FlateDecode', referencer=6)]


new_image = pymupdf.Pixmap("m100_cmyk.tiff")
page.replace_image(4, pixmap=new_image)

doc.save("output_.pdf", garbage=3, deflate=True)
```

```
$ gs -dSAFER -dNOPAUSE -dBATCH -o- -sDEVICE=ink_cov output_.pdf
GPL Ghostscript 10.05.0 (2025-03-12)
Copyright (C) 2025 Artifex Software, Inc.  All rights reserved.
This software is supplied under the GNU AGPLv3 and comes with NO WARRANTY:
see the file COPYING for details.
Processing pages 1 through 1.
Page 1
 0.00000  1.56637  0.00000  0.00000 CMYK OK
```

### JavaScript

```javascript
// @ts-check

import fs from "node:fs";
import * as mupdf from "mupdf";

const doc = mupdf.PDFDocument.openDocument("output.pdf").asPDF();
if (doc === null) {
  throw new Error();
}
const pdfDoc = /** @type {mupdf.PDFDocument} */ (doc);
const page = pdfDoc.loadPage(0);
for (const { key, value, parent } of getPageImages(page)) {
  const image = doc.loadImage(value);

  // const png = image.toPixmap().asPNG();
  // fs.writeFileSync("old.png", png);

  const newImageBuffer = fs.readFileSync("m100_cmyk.tiff");
  const newImageObj = new mupdf.Image(newImageBuffer);
  const newImage = doc.addImage(newImageObj);

  parent.put(key, newImage);
}
const buf = pdfDoc.saveToBuffer();
fs.writeFileSync("new.pdf", buf.asUint8Array());

/**
 * @param {mupdf.PDFPage} page
 *
 * サンプルの関数では`mupdf.Image`を得ることができるが、`mupdf.Image`からは画像を置き換えるためのxrefを取り出せない。 https://mupdfjs.readthedocs.io/en/latest/deprecated.html#extracting-document-images-and-text
 *
 * ```
 * export function getPageImages(page) {
 *   const images = [];
 *   page.toStructuredText("preserve-images").walk({
 *     onImageBlock(bbox, matrix, image) {
 *       images.push({ bbox, matrix, image });
 *     },
 *   });
 *   return images;
 * }
 * ```
 */
export function getPageImages(page) {
  /**
   * @param {mupdf.PDFObject} xobjects
   * @returns {{ key: string | number; value: mupdf.PDFObject; parent: mupdf.PDFObject }[]}
   */
  function getImages(xobjects) {
    const ret = [];
    xobjects.forEach((value, key) => {
      const indirectObj = value;
      const isIndirect = value.isIndirect();
      if (isIndirect) {
        value = value.resolve();
      }

      const subtype = value.get("Subtype");
      if (!subtype.isName()) {
        return;
      }
      const name = subtype.asName();
      if (name === "Image") {
        if (isIndirect) {
          // We need indirect object of image for `PDFDocument.prototype.loadImage`
          // > Load an Image from a PDFObject (typically an indirect reference to an image resource).
          // https://mupdf.readthedocs.io/en/latest/reference/javascript/types/PDFDocument.html#PDFDocument.prototype.loadImage
          ret.push({ key, value: indirectObj, parent: xobjects });
        } else {
          // FIXME: ここに到達することがあるのか不明。対処がこれで正しいかも不明。
          console.warn('name === "Image" && !isIndirect');

          // > Add obj to the PDF as a numbered object, and return an indirect reference to it.
          // https://mupdf.readthedocs.io/en/latest/reference/javascript/types/PDFDocument.html#PDFDocument.prototype.addObject
          ret.push({
            key,
            value: xobjects._doc.addObject(value),
            parent: xobjects,
          });
        }
      } else if (name === "Form") {
        ret.push(...getImages(value.get("Resources").get("XObject")));
      }
    });
    return ret;
  }

  let pageObj = page.getObject();
  if (pageObj.isIndirect()) {
    pageObj = pageObj.resolve();
  }
  return getImages(pageObj.get("Resources").get("XObject"));
}
```

<details>
<summary>素材</summary>

```
$ magick -size 128x128 canvas:black black.png
$ magick -size 128x128 canvas:"cmyk(0,100%,0,0)" -colorspace CMYK m100_cmyk.tiff
```

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Masked Image PDF Test</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .circle {
      width: 128px;
      height: 128px;
      border-radius: 50%;
      overflow: hidden;
    }
    .circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
  </style>
</head>
<body>
  <div class="circle">
    <img src="black.png" alt="Black square image">
  </div>
</body>
</html>
```

</details>

## ミッドマウントタイプのUSB Type-C レセプタクルについて

JLCPCB Assembly Parts Libで[Molex 2169900001](https://www.molex.com/en-us/products/part-detail/2169900001)を検索したら、[G-Switch GT-USB-7014D](https://jlcpcb.com/partdetail/GSwitch-GT_USB7014D/C2843969)なら在庫があると言わんばかりに紹介された。

![](img-0.png)

[G-Switch](https://www.lcsc.com/brand-detail/12389.html)は中国の会社らしい。最低限LCSCのAuthorisedメーカーではある。比較的安価だし、JLCPCBのPCBAで使いやすい。とはいえLCSC以外から入手しづらいので、「2169900001のフットプリントを使っておいてGT-USB-7014Dを指定する」のような使い方ができるとよさそう。

- [2169900001 Symbol, Footprint & 3D Model by Molex | SnapMagic Search (formerly SnapEDA)](https://www.snapeda.com/parts/2169900001/Molex/view-part/)
- `mkdir GT-USB-7014D && cd GT-USB-7014D && easyeda2kicad --full --lcsc_id=C2843969 --output ./GT-USB-7014D`

寸法資料上の数値はほとんど同じで、フットプリントを重ねてもほとんど違いはなかった。

![](img-1.png)

## だいたい狙った時間で指定したファイルを配信するローカルサーバ

```py
import http.server
import math
import time
from urllib.parse import urlparse, parse_qs

PORT = 8080
FONT_ROUTE = "/NotoSansJP-VariableFont_wght.ttf"
FONT_PATH = "Noto_Sans_JP/NotoSansJP-VariableFont_wght.ttf"
CHUNK = 32  # bytes
SECONDS_PARAM = "s"  # 受信完了までの目標秒数

with open(FONT_PATH, "rb") as f:
    FONT_DATA = f.read()

FONT_SIZE = len(FONT_DATA)


class SlowHandler(http.server.BaseHTTPRequestHandler):
    def do_GET(self):
        url = urlparse(self.path)
        if url.path != FONT_ROUTE:
            self.send_error(404)
            return

        q = parse_qs(url.query)
        s = None
        raw = q.get(SECONDS_PARAM, [None])[0]
        if raw is not None:
            try:
                s = float(raw)
            except ValueError:
                s = None

        self.send_response(200)
        self.send_header("Content-Type", "font/ttf")
        self.send_header("Content-Length", str(FONT_SIZE))
        self.send_header("Cache-Control", "no-store")
        self.send_header("Access-Control-Allow-Origin", "*")
        self.end_headers()

        if not s or s <= 0:
            try:
                self.wfile.write(FONT_DATA)
            except BrokenPipeError:
                pass
            return

        chunks = max(1, math.ceil(FONT_SIZE / CHUNK))

        start = time.perf_counter()
        try:
            offset = 0
            idx = 0
            while offset < FONT_SIZE:
                self.wfile.write(FONT_DATA[offset : offset + CHUNK])
                self.wfile.flush()

                idx += 1
                offset += CHUNK

                # 理想スケジュール：i個目のチャンク送信直後の時刻 = (s * i) / chunks
                target = (s * idx) / chunks
                now = time.perf_counter() - start
                sleep_for = target - now
                if sleep_for > 0:
                    time.sleep(sleep_for)

        except BrokenPipeError:
            pass


http.server.ThreadingHTTPServer(("0.0.0.0", PORT), SlowHandler).serve_forever()
```

```html
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      @page {
        size: A5;
      }
      @font-face {
        font-family: "Noto Sans JP";
        src: url("http://localhost:8080/NotoSansJP-VariableFont_wght.ttf?s=10");
        font-display: swap;
        font-weight: 100 900;
        font-style: normal;
      }
      p {
        font-family: "Noto Sans JP", serif;
      }
    </style>
  </head>
  <body>
    <p>
      フォントのダウンロードが非常に遅いので、しばらく明朝で表示されます。
    </p>
  </body>
</html>
```

Vivliostyleにおける`font-display: swap`の挙動が気になったので作ったけど、先にフォント全体を読み込むのでスワップは起こらないことがわかって不要だった。


## ラップトップにプリインストールされたOEM版Windows 11をKVM上にインストールし直して利用する

Linuxで作業するのも慣れてきたけど、Windowsが必要なこともまれにある……。

- ThinkPad X1 Carbon (7th Gen, 2019)
  - メモリ：16GB、プロセッサー：Intel Core i7-8665U
- ホスト：Ubuntu 24.04
- ゲスト：Windows 11 24H2

ホストにvirt-managerとvirtiofsdをインストールする。後ほどファイル共有で使用する。

virt-managerのインストールはUbuntuのコミュニティドキュメントに含まれている。[KVM/Installation - Community Help Wiki](https://help.ubuntu.com/community/KVM/Installation)（最終更新日：2020年3月23日）

Windows 11のインストールメディアのISOイメージは[Microsoftのページ](https://www.microsoft.com/ja-jp/software-download/windows11)からダウンロードできる。もとのPCで回復メディアを作ってもいいのかな。ハードウェア構成が変わるのであえてそうする必要はなさそう。

Stable virtio-win ISOを用意しておく。virtio-winのダウンロード先はたらい回し式になっている。

- https://github.com/virtio-win/kvm-guest-drivers-windows Fedoraのページ見てね
  - https://docs.fedoraproject.org/en-US/quick-docs/creating-windows-virtual-machines-using-virtio-drivers/index.html virtio-win-pkg-scriptsのページ見てね
    - https://github.com/virtio-win/virtio-win-pkg-scripts/blob/master/README.md

virt-managerで新規VMを作成する。

- ［ローカルのインストールメディア (ISOイメージまたはCD-ROMドライブ)］＞［次へ］
- ［ISOまたはCDROMインストールメディアの選択］にダウンロード済みのWindows 11ディスクイメージを指定＞［次へ］
- ［メモリとCPUの設定］＞［次へ］
  - ホストの50%程度のリソースに留めないとホストのパフォーマンスが低下し総合的に性能向上しない、としばしば聞く
  - 今回は8192MiB／4個を指定した
- ［仮想マシン用にディスクイメージを作成する］＞［次へ］
  - 実機のケースだが、あまりに少ないとWindows Updateに失敗しているのを見たことがある
  - 今回は128GB割り当てた
- ［インストールの前に設定をカスタマイズする］のチェックを必ず入れる＞［完了］

### ライセンス情報をダンプ

OEM版のWindowsは次の情報でライセンス認証されている。

<dl>
<dt>SLIC（Software Licensing Description Table）</dt><dd>Windows Vista / 7時代に使われていたACPIテーブル。OEMライセンス自動認証用の情報が含まれており、インストールメディアと照合される仕組みになっている。</dd>
<dt>MSDM（Microsoft Data Management Table）</dt><dd>Windows 8以降に導入されたACPIテーブルで、OEMプリインストール版のWindowsのプロダクトキーを格納している。</dd>
<dt>SMBIOS（System Management BIOS）</dt><dd>ハードウェア構成情報を提供する仕組み。Type 0にはBIOS/UEFI のベンダ名、バージョン、リリース日など、Type 1にはメーカー名、製品名、バージョン、シリアル番号、UUID などが格納されている。</dd>
</dl>

これらを以下のようにダンプして使用する（[参考1](https://gist.github.com/Informatic/49bd034d43e054bd1d8d4fec38c305ec)、[参考2](https://gist.github.com/Informatic/49bd034d43e054bd1d8d4fec38c305ec?permalink_comment_id=4936740#gistcomment-4936740)）。SLICは存在しない場合があり、その場合はダンプせずに無視して構わない。

```
# cat /sys/firmware/acpi/tables/SLIC > slic.bin
# cat /sys/firmware/acpi/tables/MSDM > msdm.bin
# dmidecode -t 0 -u | awk '/^\t\t[0-9A-F][0-9A-F]( |$)/' | xxd -r -p > smbios_type_0.bin
# dmidecode -t 1 -u | awk '/^\t\t[0-9A-F][0-9A-F]( |$)/' | xxd -r -p > smbios_type_1.bin
```

AppArmorによって、libvirtからこれらのファイルを参照できない場合がある（Ubuntu 24.04）。なんかエラー出てるけど自分で触った部分ではないので放っておく。

```
$ sudo cp /etc/apparmor.d/abstractions/libvirt-qemu /etc/apparmor.d/abstractions/libvirt-qemu.org
$ sudo nano /etc/apparmor.d/abstractions/libvirt-qemu
$ tail -n 5 /etc/apparmor.d/abstractions/libvirt-qemu
  # Support for this override will be removed in a future release
  ### DEPRECATED ###
  include if exists <local/abstractions/libvirt-qemu>

/home/mukai/** r,
$ sudo apparmor_parser -r /etc/apparmor.d/abstractions/libvirt-qemu
AppArmor parser error for /etc/apparmor.d/abstractions/libvirt-qemu in profile /etc/apparmor.d/abstractions/openssl at line 13: syntax error, unexpected TOK_MODE, expecting TOK_OPEN
```

「概要」からXMLを編集する。名前空間の設定が重要。変更後は［適用］をクリックする。

```xml
<domain type='kvm' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'>
  <!-- ... -->
  <qemu:commandline>
    <qemu:arg value="-acpitable"/>
    <qemu:arg value="file=/home/mukai/win11/slic.bin"/>
    <qemu:arg value="-acpitable"/>
    <qemu:arg value="file=/home/mukai/win11/msdm.bin"/>
    <qemu:arg value="-smbios"/>
    <qemu:arg value="file=/home/mukai/win11/smbios_type_0.bin"/>
    <qemu:arg value="-smbios"/>
    <qemu:arg value="file=/home/mukai/win11/smbios_type_1.bin"/>
  </qemu:commandline>
</domain>
```

### CPUトポロジーの手動設定

Windowsにはソケット数の制限があり（[参考1](https://qiita.com/rxg03350/items/e76a6a858f6b9ac267b3#3161-cpu%E6%95%B0%E3%81%AE%E8%A8%AD%E5%AE%9A%E5%A4%89%E6%9B%B4)、[参考2](https://learn.microsoft.com/en-us/answers/questions/4032319/what-is-the-maximum-number-of-cpu-and-cores-suppor)）、virt-managerの初期構成では指示したコア数をすべて別ソケットに割り当てる（例：4コア割当→4ソケット各1コア）。そのため、CPUトポロジーを明示してやらないと性能が出ない。この制限の具体的な数値について、公式な情報が見つからない。コミュニティ回答によると、Windows 10にならって次の通りだろうとのこと。

- Maximum CPU sockets:
  - Home - 1
  - Pro - 2
  - Education - 2
  - Pro for Workstations - 4
  - Enterprise - 2
- Maximum CPU cores:
  - Home - 64
  - Pro - 128
  - Education - 128
  - Pro for Workstations - 256
  - Enterprise - 256

通常のPCは1ソケットであり、変な構成のシミュレーションでなければ、4個割当なら1ソケット4コアに直せばよい。

### ディスクの設定

SATAディスクにVirtIOを使用することでI/O速度が改善する。

「SATA ディスク 1」のディスクバスを「SCSI」に変更する。［ハードウェアを追加 > コントローラー］を選択、「種類」を「SCSI」に、「モデル」を「VirtIO SCSI」に設定して［完了］をクリック。

ディスクバスには「VirtIO」という選択肢もある。「SCSI」との違いは次の通りで、「VirtIO」指定は旧方式と読み取れる。

<ul>
<li>
<a href="https://forum.proxmox.com/threads/virtio-vs-scsi.52893/post-245981">VirtIO vs SCSI | Proxmox Support Forum</a>
<blockquote>
<p>What I can tell is that the scsi virtio is better maintained and virtio-blk is the older one.</p>
</blockquote>
</li>
<li>
<a href="https://blog.zgock-lab.net/2019/01/26/gvtg2/">openSUSE Tumbleweed上のKVM仮想マシンでIntel iGPUを共有する(GVT-g)その２ - それすらもコアの果て</a>
<blockquote>
<p>今回はvirtioを使用するため、ディスクの設定をデフォルトのSATAから変更します</p>
<p>詳細オプションから「SCSI」を選択します</p>
<p>ここで「virtio」を選択可能ですが、現在はレガシーな手法とされており、VirtIO SCSIコントローラを使用して制御するのが推奨されています</p>
<p>（中略）</p>
<p>「ハードウェアを追加」からVirtIO SCSIコントローラを追加します</p>
<p>ここで明示的に追加しないと、libvirtがlsilogicエミュレーションのコントローラを勝手に追加しますのでかならず明示的に追加してください</p>
</blockquote>
</li>
</ul>

### virtio-win用にCD-ROMデバイスを追加

virtio-winのインストールのため、Windowsインストールメディア用のほかにCD-ROMデバイスがもう1つ必要。［ハードウェアを追加 > ストレージ］を選択、SATA CD-ROMデバイスを追加して、ISOを選択する。

### NIC

「デバイスのモデル」を「virtio」に変更する。

「リンクの状態：アクティブ」のチェックを外す。インストール時にインターネットに接続されているとWindows Updateを自動適用し、再起動の回数が増える。今回の構成だとこの再起動が不安定なようで、「Windowsが正しく読み込まれませんでした」という画面に落ちて正しくインストールが完了できないようだ（複数回発生、毎回同じフェーズで失敗しているかは不明）。

ただし執筆時点のWindows 11 Home/Proはインストール時にインターネット接続が必要ということになっているようで、途中で進行不能になる。インストール中に後述のハックが必要。

### ファイル共有の準備

メモ：[SPICE > Download > Guest > Windows binaries](https://www.spice-space.org/download.html#windows-binaries)で配布されているSpice WebDAVは使い方がわからなかった。性能的にもvirtiofsのほうが有用そう。

- https://blog.sergeantbiggs.net/posts/file-sharing-with-qemu-and-virt-manager/
- https://donbulinux.hatenablog.jp/entry/2024/07/12/150851

virtiofsを動作させる要件として、［メモリー］に移動し［Enable shared memory］を有効化。［ハードウェアを追加 > ファイルシステム］「Driver」は「virtiofs」に設定し、共有したいホスト上のパスを指定。`/home/mukai/Public`など。「ターゲットパス」はパスではないので要注意。Windowsゲストではドライブ名として使用される。「share」とでもしておけばよろしい。

> The target path is a bit of a misnomer. It’s not actually a path, just an identifier that we use as a mount point in our guest file system.

### VM上のWindowsとホストのCPU内蔵グラフィックを共有したい

今回はIntel Core i7-8665U（第8世代）。11世代以降は別途調べ直し

- [Intel GVT-g - ArchWiki](https://wiki.archlinux.org/title/Intel_GVT-g)
  - [Ubuntu+KVM+GVT-gで仮想GPUを仮想環境に割り当てる #Ubuntu - Qiita](https://qiita.com/edidi-n/items/ad8f2d6fab84d958f2e7)
  - [openSUSE Tumbleweed上のKVM仮想マシンでIntel iGPUを共有する(GVT-g)その１ - それすらもコアの果て](https://blog.zgock-lab.net/2019/01/23/gvtg/)
  - [openSUSE Tumbleweed上のKVM仮想マシンでIntel iGPUを共有する(GVT-g)その２ - それすらもコアの果て](https://blog.zgock-lab.net/2019/01/26/gvtg2/)
  - [KVM環境でIntel iGPUグラフィックを仮想マシンにパススルー(というか共有)する - naba_san’s diary](https://naba-san.hatenablog.com/entry/2022/09/19/005709)
  - [libvirt で GPU の仮想化を有効にしてみる - delete from hateblo.jp where 1=1;](https://deletefrom.hateblo.jp/entry/2023/09/26/024129)

### カーネルパラメータの設定

```
$ sudo nano /etc/default/grub

# GRUB_CMDLINE_LINUXに追記
GRUB_CMDLINE_LINUX="intel_iommu=on i915.enable_gvt=1 i915.enable_guc=0"

# 反映
$ sudo update-grub
```

<dl>
<dt><code>intel_iommu=on</code></dt><dd>IOMMUの有効化。安全に実デバイスをVMへ割り当てるための機構。</dd>
<dt><code>i915.enable_gvt=1</code></dt><dd>GVT-gホスト対応を有効化。i915はモジュール名。</dd>
<dt><code>i915.enable_guc=0</code></dt><dd>GuC＝スケジューラ/サブミッション（＋一部電源管理）をGPU内のマイコンで処理。HuC＝エンコード系のメディア処理をオフロードして省電力・低負荷化。GVT-gでは無効にしたほうが安定するらしい。</dd>
</dl>

### モジュールをロード

```
# 存在チェック
$ sudo modprobe --dry-run --verbose kvmgt vfio-iommu-type1 mdev

$ echo "kvmgt" | sudo tee /etc/modules-load.d/kvmgt.conf
$ echo "vfio-iommu-type1" | sudo tee /etc/modules-load.d/vfio-iommu-type1.conf
$ echo "mdev" | sudo tee /etc/modules-load.d/mdev.conf
```

ここで一度再起動。

mdevctlを使えば仮想GPUの自動確保もやってもらえる。

```
$ sudo apt --yes install mdevctl
$ mdevctl types
0000:00:02.0
  i915-GVTg_V5_4
    Available instances: 1
    Device API: vfio-pci
    Name: GVTg_V5_4
    Description: low_gm_size: 128MB, high_gm_size: 512MB, fence: 4, resolution: 1920x1200, weight: 4
  i915-GVTg_V5_8
    Available instances: 2
    Device API: vfio-pci
    Name: GVTg_V5_8
    Description: low_gm_size: 64MB, high_gm_size: 384MB, fence: 4, resolution: 1024x768, weight: 2
$ sudo mdevctl define --auto --uuid $(uuidgen) --parent 0000:00:02.0 --type i915-GVTg_V5_8
```

~~`--auto`がそれ~~

```
  -a, --auto
          Automatically start device on parent availability
```

mdevctl 1.3.0の自動起動の設定では`/usr/sbin/mdevctl`を参照しているが（[参考](https://github.com/mdevctl/mdevctl/blob/48e26971b0a21464e0432dcdc36f3cd10a1629c8/60-mdevctl.rules)）、Ubuntu 24.04では`/usr/bin/mdevctl`にインストールされるので自動起動が失敗している。[報告済み](https://bugs.launchpad.net/ubuntu/+source/mdevctl/+bug/2121264)

```
$ which mdevctl
/usr/bin/mdevctl
$ journalctl -u systemd-udevd -b | grep mdevctl
 8月 23 08:00:36 mukai-ThinkPad-X1-Carbon-7th mdevctl[509]: /bin/sh: 1: /usr/sbin/mdevctl: not found
```

仕方ないのでとりあえずシンボリックリンクを追加

```
$ sudo ln -s /usr/bin/mdevctl /usr/sbin/mdevctl
```

再起動して`mdevctl list`で起動していることを確認。

カツカツな設定（weight:4/fence:4）にすると失敗する。ここで`golden_hw_state failed with error -2`は実際にはエラーではないらしい（[参考](https://github.com/intel/gvt-linux/issues/212)）

```
mukai@mukai-ThinkPad-X1-Carbon-7th:~$ sudo dmesg | grep -i gvt
[    0.000000] Command line: BOOT_IMAGE=/boot/vmlinuz-6.14.0-27-generic root=UUID=e21f1775-eca7-40bf-9752-96720ff71178 ro intel_iommu=on i915.enable_gvt=1 i915.enable_guc=0 quiet splash vt.handoff=7
[    0.058214] Kernel command line: BOOT_IMAGE=/boot/vmlinuz-6.14.0-27-generic root=UUID=e21f1775-eca7-40bf-9752-96720ff71178 ro intel_iommu=on i915.enable_gvt=1 i915.enable_guc=0 quiet splash vt.handoff=7
[    5.412043] i915 0000:00:02.0: Direct firmware load for i915/gvt/vid_0x8086_did_0x3ea0_rid_0x02.golden_hw_state failed with error -2
[   77.118191] gvt: fail to alloc low gm space from host
[   77.118382] gvt: failed to create intel vgpu: -28
```

割り当てられたIDは次のコマンドで確認できる。

```
$ mdevctl list -d
ae6411d7-151d-485d-98e7-fa377c478da0 0000:00:02.0 i915-GVTg_V5_8 auto

$ sudo mdevctl start --uuid ae6411d7-151d-485d-98e7-fa377c478da0
$ sudo systemctl restart libvirtd
```

### virt-managerでの指定

［ハードウェアを追加 > MDEVホストデバイス］を選択、先ほどのUUIDのデバイスを選択して［完了］をクリック。

```xml
<hostdev mode="subsystem" type="mdev" managed="yes" model="vfio-pci" display="off" ramfb="off">
  <source>
    <address uuid="ae6411d7-151d-485d-98e7-fa377c478da0"/>
  </source>
</hostdev>
```

［概要］のXMLタブを開く。名前空間の設定が重要（ライセンス情報の参照時に追加した）。

```xml
<domain type='kvm' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'>
  <!-- ... -->
  <qemu:override>
    <qemu:device alias="hostdev0">
      <qemu:frontend>
        <qemu:property name="x-igd-opregion" type="bool" value="true"/>
      </qemu:frontend>
    </qemu:device>
  </qemu:override>
</domain>
```

UEFI（OVMF）のゲストではDMA-BUFディスプレイが表示されない。「[extract the OpROM](http://120.25.59.132:3000/vbios_gvt_uefi.rom) from the kernel patch ([source](https://www.reddit.com/r/VFIO/comments/av736o/creating_a_clover_bios_nonuefi_install_for_qemu/ehdz6mf/)) and feed it to QEMU as an override.」してやる必要がある（[参考](https://wiki.archlinux.org/title/Intel_GVT-g)）。

<details>
<summary>ビルドしてやりたかったが起動しなかった</summary>

`i915ovmf.rom`をビルドする。2月11日以降のArch Linuxの変更でビルドできなくなっているので、それ以前のコンテナでビルドする。

```
$ docker run -it --rm archlinux:base-devel-20250209.0.306557 bash

# pacman -Sy --noconfirm git sudo python acpica
# useradd -m builder
# passwd -d builder
# echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
# su - builder
$ git clone https://aur.archlinux.org/i915ovmf.git
$ cd i915ovmf
$ makepkg -s --noconfirm
$ mkdir output
$ bsdtar -xvf i915ovmf-*.pkg.tar.zst -C output
x .BUILDINFO
x .MTREE
x .PKGINFO
x var/
x var/lib/
x var/lib/libvirt/
x var/lib/libvirt/qemu/
x var/lib/libvirt/qemu/drivers/
x var/lib/libvirt/qemu/drivers/i915ovmf.rom
```

別ターミナルから

```
$ docker ps
$ docker cp <コンテナID>:/home/builder/i915ovmf/output ./i915ovmf
$ sudo mkdir -p /var/lib/libvirt/qemu/drivers
$ sudo cp ./i915ovmf/var/lib/libvirt/qemu/drivers/i915ovmf.rom /var/lib/libvirt/qemu/drivers/
```

</details>

http://120.25.59.132:3000/vbios_gvt_uefi.rom からダウンロードして適当な場所に置く。`sha256:33e540db0838fd49236087d2cda21f4eaa38672f6b2ac56f45351799858de085`

```xml
<!-- ... -->
  <qemu:override>
    <qemu:device alias="hostdev0">
      <qemu:frontend>
        <!-- ... -->
        <qemu:property name="romfile" type="string" value="/home/mukai/win11/vbios_gvt_uefi.rom"/>
        <!-- ... -->
      </qemu:frontend>
    </qemu:device>
  </qemu:override>
<!-- ... -->
```

RAMFBディスプレイを有効化

```xml
<!-- ... -->
  <qemu:override>
    <qemu:device alias="hostdev0">
      <qemu:frontend>
        <!-- ... -->
        <qemu:property name="driver" type="string" value="vfio-pci-nohotplug"/>
        <qemu:property name="ramfb" type="bool" value="true"/>
        <!-- ... -->
      </qemu:frontend>
    </qemu:device>
  </qemu:override>
<!-- ... -->
```

「Output using SPICE with MESA EGL」に従う。注意書きが少ないから。

- XML上で先程のmdevデバイスのdisplayを`on`に変更
- ［ディスプレイ Spice］に移動して［リッスンタイプ］を［なし］、［Open GL］のチェックを入れる
- ［ビデオ QXL］に移動して［モデル］を［None］に変更

---

最終的なインストール前のXMLは次の通り。

```xml
<domain xmlns:qemu="http://libvirt.org/schemas/domain/qemu/1.0" type="kvm">
  <name>win11</name>
  <uuid>3ec8e879-7140-42cb-9024-8af9504056e9</uuid>
  <metadata>
    <libosinfo:libosinfo xmlns:libosinfo="http://libosinfo.org/xmlns/libvirt/domain/1.0">
      <libosinfo:os id="http://microsoft.com/win/11"/>
    </libosinfo:libosinfo>
  </metadata>
  <memory>8388608</memory>
  <currentMemory>8388608</currentMemory>
  <vcpu current="4">4</vcpu>
  <os firmware="efi">
    <type arch="x86_64" machine="q35">hvm</type>
    <boot dev="hd"/>
  </os>
  <features>
    <acpi/>
    <apic/>
    <hyperv>
      <relaxed state="on"/>
      <vapic state="on"/>
      <spinlocks state="on" retries="8191"/>
    </hyperv>
    <vmport state="off"/>
  </features>
  <cpu mode="host-passthrough">
    <topology sockets="1" cores="4" threads="1"/>
  </cpu>
  <clock offset="localtime">
    <timer name="rtc" tickpolicy="catchup"/>
    <timer name="pit" tickpolicy="delay"/>
    <timer name="hpet" present="no"/>
    <timer name="hypervclock" present="yes"/>
  </clock>
  <pm>
    <suspend-to-mem enabled="no"/>
    <suspend-to-disk enabled="no"/>
  </pm>
  <devices>
    <emulator>/usr/bin/qemu-system-x86_64</emulator>
    <disk type="file" device="disk">
      <driver name="qemu" type="qcow2" discard="unmap"/>
      <source file="/var/lib/libvirt/images/win11.qcow2"/>
      <target dev="sda" bus="scsi"/>
    </disk>
    <disk type="file" device="cdrom">
      <driver name="qemu" type="raw"/>
      <source file="/home/mukai/win11/Win11_24H2_Japanese_x64.iso"/>
      <target dev="sdb" bus="sata"/>
      <readonly/>
    </disk>
    <controller type="usb" model="qemu-xhci" ports="15"/>
    <controller type="pci" model="pcie-root"/>
    <controller type="pci" model="pcie-root-port"/>
    <controller type="pci" model="pcie-root-port"/>
    <controller type="pci" model="pcie-root-port"/>
    <controller type="pci" model="pcie-root-port"/>
    <controller type="pci" model="pcie-root-port"/>
    <controller type="pci" model="pcie-root-port"/>
    <controller type="pci" model="pcie-root-port"/>
    <controller type="pci" model="pcie-root-port"/>
    <controller type="pci" model="pcie-root-port"/>
    <controller type="pci" model="pcie-root-port"/>
    <controller type="pci" model="pcie-root-port"/>
    <controller type="pci" model="pcie-root-port"/>
    <controller type="pci" model="pcie-root-port"/>
    <controller type="pci" model="pcie-root-port"/>
    <interface type="network">
      <source network="default"/>
      <mac address="52:54:00:38:29:da"/>
      <model type="virtio"/>
      <link state="down"/>
    </interface>
    <console type="pty"/>
    <channel type="spicevmc">
      <target type="virtio" name="com.redhat.spice.0"/>
    </channel>
    <input type="tablet" bus="usb"/>
    <tpm model="tpm-crb">
      <backend type="emulator"/>
    </tpm>
    <graphics type="spice">
      <image compression="off"/>
      <gl enable="yes" rendernode="/dev/dri/by-path/pci-0000:00:02.0-render"/>
      <listen type="none"/>
    </graphics>
    <sound model="ich9"/>
    <video>
      <model type="none"/>
    </video>
    <redirdev bus="usb" type="spicevmc"/>
    <redirdev bus="usb" type="spicevmc"/>
    <controller type="scsi" model="virtio-scsi"/>
    <disk type="file" device="cdrom">
      <driver name="qemu" type="raw"/>
      <source file="/home/mukai/win11/virtio-win-0.1.271.iso"/>
      <target dev="sdc" bus="sata"/>
      <readonly/>
    </disk>
    <filesystem type="mount">
      <source dir="/home/mukai/Public"/>
      <target dir="share"/>
      <driver type="virtiofs"/>
    </filesystem>
    <hostdev mode="subsystem" type="mdev" managed="yes" model="vfio-pci" display="on" ramfb="off">
      <source>
        <address uuid="ae6411d7-151d-485d-98e7-fa377c478da0"/>
      </source>
    </hostdev>
  </devices>
  <qemu:commandline>
    <qemu:arg value="-acpitable"/>
    <qemu:arg value="file=/home/mukai/win11/slic.bin"/>
    <qemu:arg value="-acpitable"/>
    <qemu:arg value="file=/home/mukai/win11/msdm.bin"/>
    <qemu:arg value="-smbios"/>
    <qemu:arg value="file=/home/mukai/win11/smbios_type_0.bin"/>
    <qemu:arg value="-smbios"/>
    <qemu:arg value="file=/home/mukai/win11/smbios_type_1.bin"/>
  </qemu:commandline>
  <memoryBacking>
    <source type="memfd"/>
    <access mode="shared"/>
  </memoryBacking>
  <qemu:override>
    <qemu:device alias="hostdev0">
      <qemu:frontend>
        <qemu:property name="x-igd-opregion" type="bool" value="true"/>
        <qemu:property name="romfile" type="string" value="/home/mukai/win11/vbios_gvt_uefi.rom"/>
        <qemu:property name="driver" type="string" value="vfio-pci-nohotplug"/>
        <qemu:property name="ramfb" type="bool" value="true"/>
      </qemu:frontend>
    </qemu:device>
  </qemu:override>
</domain>
```

［インストールの開始］をクリックすると仮想マシンが起動する。「Press any key to boot from CD or DVD...」と表示されたらすばやく何らかのキーを入力してインストール画面に入る。

「vioscsi」ドライバをインストールするまでディスクを見つけられない。virtio-winのディスクからインストールする。

途中まで進めるとネットワークに繋げと要求されて進行不能になるが、ここまでNICのリンクを切っている上ドライバーもインストールしていない。`Shift+F10`・`start ms-cxh:localonly`で回避（[参考](https://x.com/witherornot1337/status/1906050664741937328)）。ここで、ユーザー名がホームディレクトリ名になり、パスワードは空でも通る。インストールが完了したらそのままシャットダウンしスナップショットを作成しておくとよい。

ディスクドライブ1のWindowsのインストールディスクを割当解除し、追加した2つめのディスクドライブを削除、1つめのディスクドライブにvirtio-winのディスクを割り当て直す。

マシンを再起動して、virtio-winディスクに含まれているvirtio-win-guest-tools.exeをインストールする。virtioドライバー一式がインストールされ、ゲストエージェントもインストールされる。シャットダウンしてスナップショットを作成。

virtio-winのディスクを取り外す（ディスクドライブは残しISOの割当を除去）。NICのリンクを有効化して再起動。Windows Updateを適用する。Windows Updateに要求される再起動を終えたらもう一度Windows Updateを確認してアップデートがないことを確認したらシャットダウン（ここでも「更新プログラムを構成しています」と出たら再度起動してシャットダウン。更新の半端なところで止めるのはなんだかよくなさそう）。スナップショットを作成。Windows Updateのダウンロード・インストール進行中に何度か画面がチカチカして（グラフィックドライバがインストールされている？）`dxdiag`やタスク マネージャーでもGPUが見えていることが確認できるようになる。

ファイル共有を有効化するために[WinFsp](https://winfsp.dev/)をインストールする（[参考](https://donbulinux.hatenablog.jp/entry/2024/07/12/150851)）。これはWindowsでFUSE的な機能を提供する仕組み。Win+Rで「プログラムの実行」を開き、`cmd /c curl -L https://github.com/winfsp/winfsp/releases/download/v2.0/winfsp-2.0.23075.msi -o "%USERPROFILE%\Desktop\winfsp-2.0.23075.msi"`でブラウザを開かずにダウンロードして、エクスプローラーを開かずに起動できる。最新のダウンロードパスは逐次確認すること。インストール後にインストーラーはShift+Delで消しておく（なにか失敗してOneDriveにバックアップされると嫌）。タスクマネージャーの「サービス」から「VirtioFsSvc」を探し、右クリック > サービス管理ツールを開く。「VirtIO-FS Service」のプロパティを開き、スタートアップの種類を「自動」に変更して適用。再起動してZ:ドライブが自動で見えていたら成功。現れるまで少し時間がかかるかも。シャットダウンしてスナップショットを作成。

これでVMの用意は完了した。おすすめ→電源プランをパフォーマンス優先に変更、スリープ無効化、OneDriveアンインストール、開発者モードの有効化、BitLocker解除

## OEM版WindowsをLinuxに置き換えたあとにそのライセンスをKVM等の上で使うことに問題はあるのか

もとWindowsがインストールされていたPC上で、1インスタンスのみ運用する場合に限り、問題ない。

<ul>
<li>

マイクロソフトソフトウェアライセンス条項（Useterms_OEM_Windows_11_Japanese.pdf、最終更新：2024年4月） https://www.microsoft.com/useterms/

> 2\. インストールと使用権
>
> b. デバイス
>
> 本契約において「デバイス」とは、本ソフトウェアを実行することができる内蔵ストレージデバイスを備えたローカルハードウェアシステム (物理または仮想) を意味します。
>
> d. 複数のユーザーが使用するシナリオ
>
> (iv) 仮想化環境での使用
>
> このライセンスにより、お客様は、デバイスが物理であると仮想であるとにかかわらず、1台のデバイスで使用するために本ソフトウェアの1つのインスタンスのみをインストールすることができます。

</li>
<li>

https://learn.microsoft.com/ja-jp/answers/questions/2527687/hyper-v-oem-windows?forum=windows-windows_other-windows_install （2012年）

> Microsoft へ問い合わせた結果、
>
> 「同じ PC 上で、かつホスト OS がアップグレード版でなければ、プリインストールされていた
>
> OEM 版の Windows を仮想環境上で動作させることはライセンス条規に違反しない」
>
> との回答を得ることができました。

</li>
<li>

http://blog.syo-ko.com/?eid=2057#gsc.tab=0 （2014年）

> MSとしての答えは、
>
> > OEM提供されている場合、ライセンスの権限が入れようとしているパソコンメーカーになるため
> >
> > 載せたいと思っているパソコンメーカーに問い合わせしてください。
>
> という回答であった。
>
> （中略）
>
> ということで、今度はメーカーに問い合わせてみた。
>
> > メーカーとしては、仮想環境を挟んでも、**出荷されたパソコン上で動いていれば**、
> >
> > そのライセンスを仮想環境で利用することは問題ありません。
  
</li>
</ul>



## GitHub上のPythonパッケージをインストールする

ルートがPythonプロジェクトになっているGitHubリポジトリは`git+https://github.com/～`とすればよいのだけど、例えば[MarkItDown](https://github.com/microsoft/markitdown)はモノレポになっていて、コアとCLIアプリは[packages/markitdown](https://github.com/microsoft/markitdown/tree/main/packages/markitdown)にある。このようなリポジトリに対してはURLフラグメント`subdirectory`を指定するとよい。

- [VCS Support - pip documentation v25.2](https://pip.pypa.io/en/stable/topics/vcs-support/#url-fragments)

`uv tool`や`pipx`と組み合わせるとさらに便利。

```
PS > uv tool install git+https://github.com/microsoft/markitdown#subdirectory=packages/markitdown
```

よく読んだらMarkItDownはPyPIにもアップロードされていた。ぼんやりしていたみたい。

## Ardourのインストール時警告（frequency scaling）に対応する

Ardour 8.12をReady-to-Runインストーラーで素Ubuntu 24.04にインストールすると、下記の警告が出ていた。

```
$ sudo ./Ardour-8.12.0-x86_64.run 
Verifying archive integrity...  100%   MD5 checksums are OK. All good.
Uncompressing Ardour  100%  

Welcome to the Ardour installer

...

!!! WARNING !!! - Your system seems to use frequency scaling.
This can have a serious impact on audio latency.
For best results turn it off, e.g. by choosing the 'performance' governor.

...
```

たしかにpowersaveだ。まあいつもArdourなどパフォーマンスが重要なアプリケーションを使うわけではないのだけど

```
$ cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
powersave
powersave
powersave
powersave
powersave
powersave
powersave
powersave
powersave
powersave
powersave
powersave
powersave
powersave
powersave
powersave
```

<details>
<summary>追加パッケージ<code>cpufrequtils</code>でも確認できる</summary>

```
$ sudo apt install cpufrequtils
$ cpufreq-info -o
          minimum CPU frequency  -  maximum CPU frequency  -  governor
CPU  0       800000 kHz ( 16 %)  -    5000000 kHz (100 %)  -  powersave
CPU  1       800000 kHz ( 16 %)  -    5000000 kHz (100 %)  -  powersave
CPU  2       800000 kHz ( 16 %)  -    5000000 kHz (100 %)  -  powersave
CPU  3       800000 kHz ( 16 %)  -    5000000 kHz (100 %)  -  powersave
CPU  4       800000 kHz ( 16 %)  -    5000000 kHz (100 %)  -  powersave
CPU  5       800000 kHz ( 16 %)  -    5000000 kHz (100 %)  -  powersave
CPU  6       800000 kHz ( 16 %)  -    5000000 kHz (100 %)  -  powersave
CPU  7       800000 kHz ( 16 %)  -    5000000 kHz (100 %)  -  powersave
CPU  8       800000 kHz ( 16 %)  -    5000000 kHz (100 %)  -  powersave
CPU  9       800000 kHz ( 16 %)  -    5000000 kHz (100 %)  -  powersave
CPU 10       800000 kHz ( 16 %)  -    5000000 kHz (100 %)  -  powersave
CPU 11       800000 kHz ( 16 %)  -    5000000 kHz (100 %)  -  powersave
CPU 12       800000 kHz ( 16 %)  -    5000000 kHz (100 %)  -  powersave
CPU 13       800000 kHz ( 16 %)  -    5000000 kHz (100 %)  -  powersave
CPU 14       800000 kHz ( 16 %)  -    5000000 kHz (100 %)  -  powersave
CPU 15       800000 kHz ( 16 %)  -    5000000 kHz (100 %)  -  powersave
```

</details>

- https://discourse.ardour.org/t/cpu-governor-warning-your-system-seems-to-use-frequency-scaling/107872
- https://qiita.com/k0kubun/items/fa1d5fbf62a8bd9d34ef

今回起動時に限り即時変更なら

```
$ sudo bash -c 'for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do echo performance > "$cpu"; done'
```

再起動後も有効化するには

```
$ sudo apt install cpufrequtils
$ echo 'GOVERNOR="performance"' | sudo tee /etc/default/cpufrequtils

# $ sudo systemctl disable ondemand
# 上記の記事ではこの手順があったが、Ubuntu 24.04ではondemandサービスは使用されていない
# > Unit ondemand.service could not be found.

$ systemctl reboot
```

消費電力も増えるらしいけど、どんなものだろうか……

## ポエム

私は、信条の実践として基本的にOSSを使用して活動します。私たち自身がどの製品を利用するかについて受け身であってはならず、主体的に選択し責任を負うべきだと私は考えます。OSSの利点を透明性のみによって説明しようとすると、「すべてのソースコードを読めるものか」と考える人もいます。OSSを中心に据えることは、必ずしも利用するすべてのソフトウェアを理解し、ゼロから創造することを意味しません。自分の力量の範囲で理解し、改善や貢献に関与する営為そのものにこそ価値があります。

## WindowsでCodex CLIのMCPにPlaywrightを追加する

[Claude Codeでも壊れる](https://qiita.com/u1f992/items/29160e7a9238652fd337)し、やっぱりWindowsを使わないのが正解。

- https://github.com/openai/codex/blob/main/docs/config.md#mcp_servers
- https://github.com/openai/codex/issues/2508#issuecomment-3257031806

<figure>
<figcaption>%USERPROFILE%\.codex\config.toml</figcaption>

```toml
[mcp_servers.playwright]
command = "C:\\Program Files\\nodejs\\npx.cmd"
args = ["-y", "@playwright/mcp@latest"]
# see https://github.com/openai/codex/issues/2508#issuecomment-3257031806
env = { "SYSTEMROOT" = "C:\\Windows" }
```

</figure>

## ふつうのPCにSPIを生やす

Linux 6.11以降では[CH341](https://www.wch-ic.com/products/CH341.html)のUSB-SPIドライバがメインラインに入っています。CH341は以下のような形で安価に入手できます。ROMライターとしてよく知られているようですが、本来は汎用USBシリアル変換チップです。私が今回入手したのは「LC-Technology」と紹介されているタイプの基板です（青色のレジスト、3つのジャンパー、ピンヘッダが立っている）。とはいえこの手の中華デバイスにはオリジナルもなにもあったものではないので、目視による推測です。

- https://www.onetransistor.eu/2017/08/ch341a-mini-programmer-schematic.html

```
$ modinfo spi-ch341
filename:       /lib/modules/6.14.0-32-generic/kernel/drivers/spi/spi-ch341.ko.zst
license:        GPL v2
description:    QiHeng Electronics ch341 USB2SPI
author:         Johannes Thumshirn <jth@kernel.org>
srcversion:     E74FE6A9627C21DFF854C65
alias:          usb:v1A86p5512d*dc*dsc*dp*ic*isc*ip*in*
depends:        
intree:         Y
name:           spi_ch341
retpoline:      Y
vermagic:       6.14.0-32-generic SMP preempt mod_unload modversions 
sig_id:         PKCS#7
signer:         Build time autogenerated kernel key
sig_key:        5F:EE:1C:D6:B4:4A:1B:A4:E2:40:64:B5:F8:EE:E8:60:D9:43:0A:32
sig_hashalgo:   sha512
signature:      84:AB:CD:5C:3B:72:43:5F:A6:BC:E8:BB:1D:D0:A0:B4:40:11:E5:B2:
                ...
```

デバイスを接続すると自動でモジュールがロードされます。

```
$ lsmod | grep spi_ch341
（出力なし）
$ ls -l /sys/class/spi_master
合計 0
lrwxrwxrwx 1 root root 0 10月  4 12:45 spi0 -> ../../devices/pci0000:00/0000:00:1f.5/spi_master/spi0
```

```
$ lsmod | grep spi_ch341
spi_ch341              16384  0
$ ls -l /sys/class/spi_master
合計 0
lrwxrwxrwx 1 root root 0 10月  4 12:45 spi0 -> ../../devices/pci0000:00/0000:00:1f.5/spi_master/spi0
lrwxrwxrwx 1 root root 0 10月  4 15:53 spi1 -> ../../devices/pci0000:00/0000:00:14.0/usb1/1-9/1-9.4/spi_master/spi1
```

ここでは`spi1`として認識されました。`/dev/spidev*`にバインドしてやります。

```
$ sudo modprobe spidev
$ BUS=spi1
$ echo $BUS.0  | sudo tee /sys/bus/spi/drivers/spidev/bind
$ ls -l /dev/spidev*
crw------- 1 root root 153, 0 10月  4 16:52 /dev/spidev1.0
```

<details>
<summary>`driver_override`を使う場合</summary>

[サードパーティのI<sup>2</sup>C](https://github.com/gschorcht/i2c-ch341-usb)と併用する場合に`driver_override`を使うとよい？

```
$ echo spidev | sudo tee /sys/bus/spi/devices/$BUS.0/driver_override
$ sudo modprobe spidev
```

`driver_override`は用が済んだら空文字でクリアする。

```
$ echo "" | sudo tee /sys/bus/spi/devices/$BUS.0/driver_override
```

</details>
<details>
<summary>切断からの再接続</summary>

```
$ lsmod | grep spidev
spidev                 28672  0
$ echo spidev | sudo tee /sys/bus/spi/devices/spi1.0/driver_override
$ echo spi1.0 | sudo tee /sys/bus/spi/drivers_probe
$ echo "" | sudo tee /sys/bus/spi/devices/spi1.0/driver_override
$ ls -l /dev/spidev*
crw-rw---- 1 root spi 153, 0 10月  4 17:38 /dev/spidev1.0
```

</details>

一般ユーザーが`/dev/spidev*`に触れられるようにudevルールを作成します。

```
$ echo 'KERNEL=="spidev*", GROUP="spi", MODE="0660"' | sudo tee /etc/udev/rules.d/99-spidev.rules
$ sudo groupadd -f spi
$ sudo usermod -aG spi "$USER"
$ newgrp spi
$ sudo udevadm control --reload-rules
$ sudo udevadm trigger
$ ls -l /dev/spidev*
crw-rw---- 1 root spi 153, 0 10月  4 17:21 /dev/spidev1.0
```

```
$ sudo apt-get install -y python3-dev build-essential
$ uv run --with spidev python
Python 3.12.3 (main, Aug 14 2025, 17:47:21) [GCC 13.3.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import spidev
>>> spi = spidev.SpiDev()
>>> spi.open_path("/dev/spidev1.0")
>>> spi.xfer2([0b00001000, 0x00, 0x00,0x00])
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
TimeoutError: [Errno 110] Connection timed out
```

<details>
<summary>dmesgの該当箇所</summary>

```
[38012.768218] usb 1-9.4: new full-speed USB device number 39 using xhci_hcd
[38012.904008] usb 1-9.4: New USB device found, idVendor=1a86, idProduct=5512, bcdDevice= 3.04
[38012.904011] usb 1-9.4: New USB device strings: Mfr=0, Product=2, SerialNumber=0
[38012.904012] usb 1-9.4: Product: USB UART-LPT
[38117.227614] spidev spi1.0: SPI transfer failed: -110
[38117.227728] spi_master spi1: failed to transfer one message from queue
[38117.227730] spi_master spi1: noqueue transfer failed
```

</details>
<details>
<summary>usbmonログ</summary>

```
$ sudo modprobe usbmon
$ DEVPATH=/sys/bus/usb/devices/1-9.4
$ BUS=$(cat $DEVPATH/busnum)
$ DEV=$(cat $DEVPATH/devnum)
$ printf "BUS=%s DEV=%s (node=/dev/bus/usb/%03d/%03d)\n" "$BUS" "$DEV" "$BUS" "$DEV"
BUS=1 DEV=49 (node=/dev/bus/usb/001/049)
$ sudo stdbuf -oL cat /sys/kernel/debug/usb/usbmon/1t | grep 49:
ffff89f494e4b8c0 3966319029 S Bo:049:02 -115 3 = abb720
ffff89f494e4b8c0 3966319098 C Bo:049:02 0 3 >
ffff89f494e4b8c0 3966319131 S Bo:049:02 -115 5 = a8080000 00
ffff89f494e4b8c0 3966319204 C Bo:049:02 0 5 >
ffff89f494e4b8c0 3966319251 S Bi:049:02 -115 4 <
ffff89f38127d740 3966319279 C Bi:049:02 0 4 = 08000000
ffff89f494e4b8c0 3967351189 C Bi:049:02 -2 0
ffff89f494e4b8c0 3967351242 S Bo:049:02 -115 4 = abb67f20
ffff89f494e4b8c0 3967351303 C Bo:049:02 0 4 >
^C
```

</details>

原因がわからない。一旦ユーザーランド実装に切り替えてみる。

- https://github.com/dimich-dmb/spi-ch341-usb

既存モジュールが読み込まれないようにする

```
sudo modprobe -r spi_ch341
echo "blacklist spi_ch341" | sudo tee /etc/modprobe.d/blacklist-spi_ch341.conf
sudo depmod -a
```

デバイスを差し直し、読み込まれなくなったことを確認する

```
$ lsmod | grep spi_ch341
（出力なし）
```

```
cd ~/Documents
git clone https://github.com/dimich-dmb/spi-ch341-usb.git
cd spi-ch341-usb
$ sudo apt-get install linux-headers-$(uname -r) dkms
$ make
$ sudo make install
```

```
$ sudo modprobe spi-ch341-usb
```

差し直して確認

```
$ sudo dmesg | tail -n 10
[49639.440878] spi-ch341-usb 1-9.4:1.0: ch341_cfg_probe: output cs0 SPI slave with cs=0
[49639.440881] spi-ch341-usb 1-9.4:1.0: ch341_cfg_probe: output cs1 SPI slave with cs=1
[49639.440882] spi-ch341-usb 1-9.4:1.0: ch341_cfg_probe: output cs2 SPI slave with cs=2
[49639.440883] spi-ch341-usb 1-9.4:1.0: ch341_cfg_probe: input  gpio4 gpio=0 irq=0 (hwirq)
[49639.440884] spi-ch341-usb 1-9.4:1.0: ch341_cfg_probe: input  gpio5 gpio=1 irq=1 
[49639.441053] spi-ch341-usb 1-9.4:1.0: ch341_spi_probe: SPI master connected to SPI bus 1
[49639.441182] spi-ch341-usb 1-9.4:1.0: ch341_spi_probe: SPI device /dev/spidev1.0 created
[49639.441206] spi-ch341-usb 1-9.4:1.0: ch341_spi_probe: SPI device /dev/spidev1.1 created
[49639.441237] spi-ch341-usb 1-9.4:1.0: ch341_spi_probe: SPI device /dev/spidev1.2 created
[49639.441428] spi-ch341-usb 1-9.4:1.0: ch341_usb_probe: connected
$ ls /dev/spidev*
ls: '/dev/spidev*' にアクセスできません: そのようなファイルやディレクトリはありません
```

成功しているようなメッセージだが実際には`/dev/spidev*`が作成されていない。こちらにはあるから、カーネルとしては認識しているのだろう。

```
$ ls -l /sys/class/spi_master/spi1/
合計 0
lrwxrwxrwx 1 root root    0 10月  5 02:34 device -> ../../../1-9.4:1.0
drwxr-xr-x 2 root root    0 10月  5 02:34 power
drwxr-xr-x 4 root root    0 10月  5 02:32 spi1.0
drwxr-xr-x 4 root root    0 10月  5 02:32 spi1.1
drwxr-xr-x 4 root root    0 10月  5 02:32 spi1.2
drwxr-xr-x 2 root root    0 10月  5 02:34 statistics
lrwxrwxrwx 1 root root    0 10月  5 02:32 subsystem -> ../../../../../../../../../class/spi_master
-rw-r--r-- 1 root root 4096 10月  5 02:32 uevent
```

`/sys/class/spidev`を監視して`/dev/spidev*`を作るルールのはず。

```
$ ls /sys/class/spidev
（出力なし）
```

じゃあspidevモジュールがロードされていない？

```
$ lsmod | grep spidev
spidev                 28672  0
```

されている。手動で作ればよいのだろうか？

```
$ DEV=spi1.0
$ echo spidev | sudo tee /sys/bus/spi/devices/$DEV/driver_override >/dev/null
$ echo $DEV | sudo tee /sys/bus/spi/drivers/spidev/bind >/dev/null
$ echo "" | sudo tee /sys/bus/spi/devices/$DEV/driver_override >/dev/null
$ ls -l /dev/spidev*
crw-rw---- 1 root spi 153, 0 10月  5 02:42 /dev/spidev1.0
```

Pythonでテスト。

```
$ uv run --with spidev python
Python 3.12.3 (main, Aug 14 2025, 17:47:21) [GCC 13.3.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import spidev
>>> spi = spidev.SpiDev()
>>> spi.open_path("/dev/spidev1.0")
>>> spi.xfer2([0b00001000, 0x00, 0x00,0x00])
[8, 0, 0, 0]
```

通った。じゃあメインラインのドライバが悪かったのか……？

```
$ cat mcp42u83-shunt.py 
import time
import spidev

spi = spidev.SpiDev()
spi.open(1, 0)

while True:
    for value in range(0x000, 0x400):
        spi.writebytes([0b00001000, (value >> 8) & 0x03, value & 0xff])
        time.sleep(0.001)
    for value in range(0x3FF, -1, -1):
        spi.writebytes([0b00001000, (value >> 8) & 0x03, value & 0xff])
        time.sleep(0.001)
$ uv run --with spidev mcp42u83-shunt.py 
```


## 可変抵抗によるLED光量調整

![](circuit.png)

可変抵抗のワイパー位置が2=1のとき、LEDに充分な電流が流れる。ワイパー位置が2=3のとき、LED側にはほとんど電流が流れなくなる。

LED電流（ほぼ光量）は次のように表せる。

$$
I_{LED} = \frac{V_{CC} - V_f}{R_{LED} + R_{pot}}
$$

$V_{CC} = 3.3V$、$R_{LED} = 120Ω$、一般的な赤色LEDを仮定して順方向電圧$V_{f} = 2.0V$。

$$
I_{LED} = \frac{1.3}{120 + R_{pot}}
$$

```python
import numpy as np
import matplotlib.pyplot as plt

Vcc = 3.3
R_led = 120
Vf_led = 2.0
R_pot = np.linspace(0, 5000, 200)
I_led = (Vcc - Vf_led) / (R_led + R_pot)

plt.figure(figsize=(6,4))
plt.plot(R_pot, I_led * 1000)
plt.title("LED Current vs Potentiometer Resistance")
plt.xlabel("Potentiometer Resistance (Ω)")
plt.ylabel("LED Current (mA)")
plt.grid(True)
plt.tight_layout()
plt.show()
```

![](i_led.png)

可変抵抗が10ビットデジタルポテンショメータ（MCP42U83）であると仮定し、光量を線形に補正することを考える。入力値$d$について以下の関係を得たい。

$$
I_{LED}(d) = I_{min} + \frac{d}{1023} (I_{max} - I_{min})
$$

$I_{LED}$についての式を$R_{pot}$について変形する。

$$
R_{pot} = \frac{V_{CC} - V_f}{I_{LED}} - R_{LED}
$$

さらに$I_{LED}(d)$を代入することで、$R_{pot}$について$d$の関数を得られる。

$$
R_{pot}(d) = \frac{V_{CC} - V_f}{I_{min} + \frac{d}{1023} (I_{max} - I_{min})} - R_{LED}
$$

ここで、

$$
I_{max} = \frac{3.3 - 2.0}{120} = 10.83\,\mathrm{mA}
$$

$$
I_{min} = \frac{3.3 - 2.0}{120 + 5000} = 0.25\,\mathrm{mA}
$$

したがって、

$$
R_{pot}(d) = \frac{1.3}{0.00025 + \frac{d}{1023} (0.01083 - 0.00025)} - 120
$$

```python
import numpy as np
import matplotlib.pyplot as plt

Vcc = 3.3
Vf = 2.0
R_led = 120.0
Rpot_max = 5000.0
I_max = (Vcc - Vf) / R_led
I_min = (Vcc - Vf) / (R_led + Rpot_max)

d = np.arange(0, 1024)

I_target = I_min + (d/1023.0) * (I_max - I_min)
R_pot = (Vcc - Vf) / I_target - R_led
I_circuit = (Vcc - Vf) / (R_led + R_pot)

plt.figure(figsize=(6,4))
plt.plot(d, I_circuit * 1e3, label="Corrected I_LED(d)")
plt.plot(d, I_target * 1e3, linestyle="--", label="Target (linear)")
plt.title("LED Current vs 10-bit Setting with Correction")
plt.xlabel("Digital Potentiometer Setting d (0–1023)")
plt.ylabel("LED Current (mA)")
plt.grid(True)
plt.legend()
plt.tight_layout()
plt.show()
```

![](d-i_led.png)
![](output.gif)

ただし回路に注意。

```
A,W,Bのどの範囲をレオスタットとして使うかによって挙動が異なることがわかりました。W-B間を使う「WをLED、BをGNDに落としてAをオープン（もとの回路図）」「BをLED、WをGNDに落としてAをオープン」の場合は概ね線形に変化します。しかしA-W間を使う「WをLED、AをGNDに落としてBをオープン」「AをLED、WをGNDに落としてBをオープン」の形では全範囲でほぼ全灯になり、極限付近で一瞬だけちらつきます。

ChatGPT:
ご報告の挙動は、MCP42U83（デジタル・ポテンショメータ）を**レオスタット（2端子）**として使う際の“どの2端子を使うか”と“電流の流れ方向（どちら側を開放するか）”に強く依存するために起きています。ポイントだけ簡潔に整理します。

---

# なぜ W–B だと概ね線形で、A–W だとほぼ全灯になるのか

## 1) デジタル・ポテンショメータ内部の実像

* 端子 **A–B** の間に均等分割された抵抗ラダー（合計 (R_{AB})）があり、**W** はそのタップにスイッチで接続されます。
* “理想的”には
  [
  R_{WB}(n) \approx R_w + R_{AB}\cdot \frac{n}{1024},\qquad
  R_{WA}(n) \approx R_w + R_{AB}\cdot \Bigl(1-\frac{n}{1024}\Bigr)
  ]
  （(n): 0–1023、(R_w): ワイパ内部抵抗）
  のように**W–B**も**W–A**も単調に変化します。

しかし実機では、**未使用端子を開放した側に向かって電流を流そうとすると、ほとんどのコード範囲で“短絡に近い経路（低インピーダンス）”が選ばれてしまう**場合があります。結果として LED 直列抵抗は 120 Ωだけが支配的になり、**ほぼ全域で全灯**に近づき、端のごく狭い範囲でだけ明るさが動きます。

### 具体例（今回の4パターン）

* **W–B を使用**

  * 「W を LED 側、B を GND、A 開放」
  * 「B を LED 側、W を GND、A 開放」
    → **電流が“使用している端子側（B 側）”に抜ける**ため、コードに応じて**抵抗ラダーを素直に経由**し、実効抵抗が広い範囲で変化。**概ね線形**に見えます。

* **A–W を使用**

  * 「W を LED 側、A を GND、B 開放」
  * 「A を LED 側、W を GND、B 開放」
    → 電流が**開放している側（B 側）方向へは流れず**、ワイパ近傍のスイッチ／配線の**低インピーダンス経路が支配的**になりやすい。多くのコードで**実効抵抗が小さいまま**になり、**全域でほぼ全灯**、端でわずかに変化（ちらつき）だけが見える、という挙動になります。

要するに、**“開放している側に向かって”電流が流れる構成を避け、必ず使用する固定端子（A または B）側へ電流が抜けるように**組む必要があります。実務上は**レオスタットは W–B（または W–A）を使い、もう一方の固定端子は“源（ソース）側”にしない**、という配線規律が有効です。

---

# 実装上の指針

1. **W–B レオスタットを基本にする**

   * 使わない端子（A）は**入力側（LED/電源側）にしない**。A は未接続でよいが、**電流の通り道は W–B 間**に限定する。

2. **ファーム側の線形化は W–B を前提にする**

   * 理想化モデルでは
     [
     R_{WB}(n) \approx R_w + R_{AB}\cdot \frac{n}{1024}
     ]
     なので、所望の電流 (I(d)=I_{\min} + \tfrac{d}{1023}(I_{\max}-I_{\min})) に対し
     [
     R_{WB}(d)=\frac{V_{CC}-V_f}{I(d)}-R_{\text{series}},\qquad
     n(d)\approx \frac{R_{WB}(d)-R_w}{R_{AB}}\cdot 1024
     ]
     （(R_{\text{series}}): 直列保護抵抗、ここでは 120 Ω）でコードを決めるのが基本です。
     実機では (R_w) が数十Ωオーダ、端部非線形・コード依存オン抵抗があるため、**数点の実測でフィット**するとより素直に揃います。

3. **電流定格と熱に留意**

   * デジポの**許容電流は小さい**ため、LED 直列抵抗として使う場合は電流を安全範囲に抑えること。必要に応じて**トランジスタ／FET を電圧制御**し、デジポは“電圧設定器”として使う方が安全で線形にできます。

---

# まとめ

* **W–B（使用端子側へ電流が抜ける）構成**では、おおむね線形に変化。
* **A–W（開放側に向かって電流が“行き場を失う”）構成**では、内部の低インピーダンス経路が支配的となり、**全域でほぼ全灯**になりやすい。
* レオスタット利用時は、**使わない固定端子側に電流を向けない**配線とするのが要点です。

この前提で補正関数（コード→電流の線形化）を適用すれば、実機でも素直な変化が得られます。
```

## FFmpegでmp4からgifに変換

パレット作成→Gif作成

```
$ ffmpeg -i input.mp4 -vf "fps=15,scale=640:-1:flags=lanczos,palettegen" -y palette.png
$ ffmpeg -i input.mp4 -i palette.png -lavfi "fps=15,scale=640:-1:flags=lanczos [x]; [x][1:v] paletteuse" -y output.gif
```

1行でできるらしい。

```
$ ffmpeg -i input.mp4 -filter_complex "[0:v]fps=15,scale=640:-1:flags=lanczos,split[a][b];[a]palettegen[p];[b][p]paletteuse" -y output-oneline.gif
$ sha256sum *.gif
f12d30d20c4bf9483f17e08f16fada73e232b54b34f3d5898c956d42567f7564  output-oneline.gif
f12d30d20c4bf9483f17e08f16fada73e232b54b34f3d5898c956d42567f7564  output.gif
```

## Ubuntu 24.04作業ログ

```
$ sudo apt update
$ sudo apt upgrade
```

GUIのフリーズ判定までの時間を伸ばす。10秒くらいは待ってやらんこともない。

```
$ gsettings get org.gnome.mutter check-alive-timeout
uint32 5000
$ gsettings set org.gnome.mutter check-alive-timeout 10000
$ gsettings get org.gnome.mutter check-alive-timeout
uint32 10000
```

［設定］＞［Ubuntu Desktop］＞［Dockを自動的に隠す］

```
$ LANG=C xdg-user-dirs-update --force
$ rmdir ダウンロード
$ rmdir テンプレート$ cat /usr/share/applications/Ardour-Ardour_8.11.0.desktop 
[Desktop Entry]
Encoding=UTF-8
Version=1.0
Type=Application
Terminal=false
Exec=pw-jack /opt/Ardour-8.11.0/bin/ardour8
Name=Ardour-8.11.0
Icon=Ardour-Ardour_8.11.0
Comment=Digital Audio Workstation
Categories=AudioVideo;AudioEditing;Audio;Recorder;

$ rmdir デスクトップ
$ rmdir ドキュメント
$ rmdir ビデオ
$ rmdir ピクチャ
$ rmdir ミュージック
$ rmdir 公開
$ systemctl reboot
```

［次回から表示しない］＞［古い名前のままにする］

デスクトップアイコンが消えてミスったかと思ったけど、再起動したら復活した

```
$ sudo apt install gnome-tweaks
```

アイコンをYaru-magentaにするのが気に入っている。これ以前は[Jannomag/Yaru-Colors](https://github.com/Jannomag/Yaru-Colors)から導入していたように記憶しているが、Tweaksに統合されたのかな。

カレンダーや変換予測ポップアップは［レガシーなアプリケーション］で変更できるようだ。

ちなみにデフォルトの壁紙は`/usr/share/backgrounds`にある

```
$ find / -type f -name warty-final-ubuntu.png 2>/dev/null
/usr/share/backgrounds/warty-final-ubuntu.png
```

### Chrome

サイトから`google-chrome-stable_current_amd64.deb`をダウンロード

```
$ sudo dpkg -i google-chrome-stable_current_amd64.deb 
$ sudo apt --fix-broken install
```

起動してピンどめ。Firefoxを外す$ sudo apt --fix-broken install

✅［Google Chromeを既定のブラウザにする］
✅［使用統計データと障害レポートをGoogleに自動送信します］
Chromeにログイン
同期をオンにする

トラックパッドいらん

［設定］＞［マウスとタッチパッド］＞［タッチパッド］タブ＞［Touchpad］無効化

これ毎回忘れる

```
$ echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
```

### RDPやってみたい

~~VPNを構築する~~ VPNサーバーはGLM-MN3350に移した。

ファイアウォールの設定

```
$ sudo ufw enable
$ sudo ufw allow in on wg0 to any port 3389
```

SSHも開ける

```
$ sudo apt install openssh-server
$ sudo systemctl status ssh
$ sudo systemctl enable --now ssh  # disabledなら
$ sudo ufw allow in on wg0 proto tcp to any port 22
```

あとはGLM-MN3350のページに移設済み。

Ubuntuの「リモートログイン」機能でやりたかった

- https://gihyo.jp/admin/serial/01/ubuntu-recipe/0819

Windowsのリモートデスクトップ接続アプリで表示すると黒い画面のまま動かなかったので断念。24.10で機能追加しているようなので、次のLTSでは使えるといいな。次回挑戦する時用のメモ

- https://qiita.com/masuminnu/items/986bc8ce769d8675cec4
  - rdp設定ファイルの`use redirection server name:i:0`を`use redirection server name:i:1`に変更する→効果なかった

リモートログインを無効化して、xrdpに切り替えた。

- https://www.diy-gedankenexperiment.jp/entry/2024/06/16/130755

```
$ sudo cp /etc/xrdp/startwm.sh /etc/xrdp/startwm.sh.orig
$ sudo vim /etc/xrdp/startwm.sh
$ cat /etc/xrdp/startwm.sh
#!/bin/sh
# xrdp X session start script (c) 2015, 2017, 2021 mirabilos
# published under The MirOS Licence

# Rely on /etc/pam.d/xrdp-sesman using pam_env to load both
# /etc/environment and /etc/default/locale to initialise the
# locale and the user environment properly.

if test -r /etc/profile; then
	. /etc/profile
fi

if test -r ~/.profile; then
	. ~/.profile
fi

# see /etc/share/xsessions/ubuntu.desktop
export GNOME_SHELL_SESSION_MODE=ubuntu
export XDG_CURRENT_DESKTOP=ubuntu:GNOME

test -x /etc/X11/Xsession && exec /etc/X11/Xsession
exec /bin/sh /etc/X11/Xsession
```

`/etc/gdm3/custom.conf`のWayland無効化は必要ないようだ。

終了時にちゃんとログアウトする。しないと実機側で「Session Already Running」と表示されて締め出されてしまう。この場合は`Ctrl+Alt+F3`でttyを切り替え、ログインして`sudo systemctl stop xrdp`と`sudo pkill -KILL -u $(whoami)`。

### Docker

- https://docs.docker.com/engine/install/ubuntu/
- https://docs.docker.com/engine/install/linux-postinstall/ 

Docker Desktopは商用有料だが、Docker Engine自体はFLOSS。LinuxならDocker Desktopを使う理由はほぼない。Docker EngineのみをインストールしてCLIから使えばよい。

Windowsの場合は選択肢が2通りあり、WSL内で使うだけならWSLディストロ上にDocker Engineをインストールすればよい。Windows側から（not WSL）Dockerを使うためにはDocker Desktopが必須。この場合Dockerは専用のディストロを伴ってインストールされ、WSL Integrationによって他のディストロからも使用できるようになる。

macOSの場合はDocker Desktopの利用がほぼ必須。Docker DesktopがDocker Engineを導入するための軽量Linux VMの面倒をみる。

あとは上記の手順の通り鍵のダウンロードとパッケージのインストール。`sudo`なしで実行できるようにユーザーを`docker`グループに追加。

### GitHub CLI

https://github.com/cli/cli/blob/b642da26d0331f6e44af302a6a07eb458df38cd3/docs/install_linux.md#debian-ubuntu-linux-raspberry-pi-os-apt

```
$ gh auth login
```

gitもインストールされるっぽい（デフォルトで入っている？）

### NVM & Node.js

https://github.com/nvm-sh/nvm/tree/759f70f1967c56e0ce9b8f51a6c0b33efdea869b?tab=readme-ov-file#install--update-script

Ubuntuにはcurlは入ってなかった

```
$ source ~/.bashrc
$ nvm install 22
```

### VS Code

`code_1.97.2-1739406807_amd64.deb`をダウンロード

```
$ sudo dpkg -i code_1.97.2-1739406807_amd64.deb 
$ sudo apt --fix-broken install
```

### Inkscape

PPAある

https://inkscape.org/release/inkscape-1.4/gnulinux/ubuntu/ppa/dl/

```
sudo add-apt-repository ppa:inkscape.dev/stable
sudo apt update
sudo apt install inkscape
```

### GIMP

https://www.gimp.org/downloads/

`If available, the official package from your Unix-like distribution is the recommended method of installing GIMP!`

とのことなので

```
sudo apt install gimp
```

Make入ってなかった

```
sudo apt install make
```

pythonのvenvモジュールも入ってない

```
sudo apt install python3.12-venv
```

### Ardour

`Ardour-8.11.0-x86_64.run`をダウンロード

```
chmod +x Ardour-8.11.0-x86_64.run
./Ardour-8.11.0-x86_64.run
```

デスクトップエントリの権限が間違っている。

```
$ ls -l
合計 4
-rwxrwxrwx 1 mukai mukai 241  4月  2  2025 Ardour_8.12.0.desktop
```

![](image.png)

```
$ chmod 755 ~/Desktop/Ardour_8.12.0.desktop
```

![](image-1.png)

```
$ gio set Ardour_8.12.0.desktop metadata::trusted true
```

### Vital

https://account.vital.audio/

version 1.0.8では`undefined symbol: g_task_set_static_name`エラーが発生する（動的リンクのライブラリのバージョン不整合？）

```
VST3 module-path '/usr/lib/vst3/Vital.vst3/Contents/x86_64-linux/Vital.so'
[Info]: Scanning: /usr/lib/vst3/Vital.vst3
[ERROR]: Could not load VST3 plugin '/usr/lib/vst3/Vital.vst3/Contents/x86_64-linux/Vital.so': /lib/x86_64-linux-gnu/libsecret-1.so.0: undefined symbol: g_task_set_static_name
Cannot load VST3 module: '/usr/lib/vst3/Vital.vst3/Contents/x86_64-linux/Vital.so'
Scan Failed.
```

All downloadsからEarly access版をダウンロードする。1.5.5で確認

```
sudo dpkg -i VitalInstaller.deb
sudo apt --fix-broken install
```

読み込みに失敗している場合は［ウィンドウ］＞［プラグインマネージャ］から確認できる

### Wine

おおむね書いてある通り

https://gitlab.winehq.org/wine/wine/-/wikis/Debian-Ubuntu

```
sudo dpkg --add-architecture i386

sudo mkdir -pm755 /etc/apt/keyrings
wget -O - https://dl.winehq.org/wine-builds/winehq.key | sudo gpg --dearmor -o /etc/apt/keyrings/winehq-archive.key -

sudo wget -NP /etc/apt/sources.list.d/ https://dl.winehq.org/wine-builds/ubuntu/dists/noble/winehq-noble.sources
```

現時点ではyabridgeのために9.21にとどめなくてはいけない
https://github.com/robbert-vdh/yabridge/issues/382

```
$ apt list -a winehq-staging
一覧表示... 完了
winehq-staging/noble 10.1~noble-1 amd64
winehq-staging/noble 10.0.0~noble-1 amd64
winehq-staging/noble 10.0~rc6~noble-1 amd64
winehq-staging/noble 10.0~rc5~noble-1 amd64
winehq-staging/noble 10.0~rc4~noble-1 amd64
winehq-staging/noble 10.0~rc3~noble-1 amd64
winehq-staging/noble 10.0~rc2~noble-1 amd64
winehq-staging/noble 10.0~rc1~noble-1 amd64
winehq-staging/noble 9.22~noble-1 amd64
winehq-staging/noble 9.21~noble-1 amd64
...

$ sudo apt install --install-recommends winehq-staging=9.21~noble-1 wine-staging=9.21~noble-1 wine-staging-amd64=9.21~noble-1 wine-staging-i386=9.21~noble-1
sudo apt-mark hold winehq-staging
```

### yabridge

```
$ tar -C ~/.local/share -xavf yabridge-5.1.1.tar.gz
$ echo 'export PATH="$PATH:$HOME/.local/share/yabridge"' >> ~/.bashrc
```

### WINEPREFIXの管理

`wine-mono`パッケージのインストールを促す［Wine Monoインストーラー］ウィンドウが出現したら［インストール］を選択。「代わりにディストリビューションのパッケージを利用することをおすすめします。」ともあるが、Ubuntuにはないはず。

- https://gitlab.winehq.org/wine/wine/-/wikis/Wine-Mono
- https://packages.ubuntu.com/search?suite=noble&section=all&arch=any&keywords=wine-mono&searchon=names

```
$ mkdir ~/.wineprefixes
$ WINEPREFIX=~/.wineprefixes/Xfer_OTT_137 winecfg
$ WINEPREFIX=~/.wineprefixes/Xfer_OTT_137 wine Install_Xfer_OTT_137.exe 
$ yabridgectl add "$HOME/.wineprefixes/Xfer_OTT_137/drive_c/Program Files/Common Files/VST3"
$ yabridgectl sync
```

### Winetricks

https://github.com/Winetricks/winetricks

`Note: packaged Debian / Ubuntu winetricks versions are typically outdated, so a manual installation is recommended.`らしい

```
$ tar xvf winetricks-20250102.tar.gz
$ cd winetricks-20250102/
$ sudo make install
```

### KiKad

https://www.kicad.org/download/linux/

PPAでよいと思う。

### Flathub

https://flathub.org/setup/Ubuntu

```
sudo apt install flatpak
flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
```

### PipeWireとJack

Ubuntu 24.04では、PipeWireは導入済み

```
mukai@mukai-ThinkPad-X1-Carbon-7th:~$ apt list --installed | grep wire

WARNING: apt does not have a stable CLI interface. Use with caution in scripts.

gstreamer1.0-pipewire/now 1.0.5-1ubuntu2 amd64 [インストール済み、1.0.5-1ubuntu3 にアップグレード可]
libpipewire-0.3-0t64/now 1.0.5-1ubuntu2 amd64 [インストール済み、1.0.5-1ubuntu3 にアップグレード可]
libpipewire-0.3-common/now 1.0.5-1ubuntu2 all [インストール済み、1.0.5-1ubuntu3 にアップグレード可]
libpipewire-0.3-modules/now 1.0.5-1ubuntu2 amd64 [インストール済み、1.0.5-1ubuntu3 にアップグレード可]
libwireplumber-0.4-0/noble,now 0.4.17-1ubuntu4 amd64 [インストール済み、自動]
pipewire-alsa/now 1.0.5-1ubuntu2 amd64 [インストール済み、1.0.5-1ubuntu3 にアップグレード可]
pipewire-audio/now 1.0.5-1ubuntu2 all [インストール済み、1.0.5-1ubuntu3 にアップグレード可]
pipewire-bin/now 1.0.5-1ubuntu2 amd64 [インストール済み、1.0.5-1ubuntu3 にアップグレード可]
pipewire-pulse/now 1.0.5-1ubuntu2 amd64 [インストール済み、1.0.5-1ubuntu3 にアップグレード可]
pipewire/now 1.0.5-1ubuntu2 amd64 [インストール済み、1.0.5-1ubuntu3 にアップグレード可]
wireless-regdb/noble-updates,noble-updates,now 2024.07.04-0ubuntu1~24.04.1 all [インストール済み、自動]
wireless-tools/noble,now 30~pre9-16.1ubuntu2 amd64 [インストール済み、自動]
wireplumber/noble,now 0.4.17-1ubuntu4 amd64 [インストール済み、自動]
```

https://note.kurodigi.com/void-pipewire/

`pw-jack`はない

```
$ pw-jack
コマンド 'pw-jack' が見つかりません。次の方法でインストールできます:
sudo apt install pipewire-jack
$ sudo apt install pipewire-jack
$ pw-jack -p 512 /opt/Ardour-8.11.0/bin/ardour8
```

https://discourse.ardour.org/t/ardour-8-2-8-4-audio-setup-pipewire-jack/109952

ランチャーにも登録しちゃう

```
$ cat /usr/share/applications/Ardour-Ardour_8.11.0.desktop 
[Desktop Entry]
Encoding=UTF-8
Version=1.0
Type=Application
Terminal=false
Exec=pw-jack /opt/Ardour-8.11.0/bin/ardour8
Name=Ardour-8.11.0
Icon=Ardour-Ardour_8.11.0
Comment=Digital Audio Workstation
Categories=AudioVideo;AudioEditing;Audio;Recorder;
```

### Ardourのメモリ制限を解除

https://forum.manjaro.org/t/maximum-amount-of-locked-memory/34528

```
sudo groupadd audio
sudo usermod -aG audio $USER
echo '@audio - memlock unlimited' | sudo tee /etc/security/limits.d/audio.conf
```

### QEMU

- https://gist.github.com/Informatic/49bd034d43e054bd1d8d4fec38c305ec
- https://orebibou.com/ja/home/201905/20190527_001/

~~多分MSDMだけでいい~~ 全部含めたほうがよさそう。

```
mukai@mukai-ThinkPad-X1-Carbon-7th:~$ ls -la .win11
合計 28
drwxrwxr-x+  2 libvirt-qemu kvm   4096  3月 11 21:29 .
drwxr-x---+ 31 mukai        mukai 4096  3月 11 22:39 ..
-rw-r--r--   1 libvirt-qemu kvm     85  3月 11 21:29 msdm.bin
-rwxrwxr-x   1 libvirt-qemu kvm    323  3月 11 21:29 slic-dump
-rw-r--r--   1 libvirt-qemu kvm    374  3月 11 21:29 slic.bin
-rw-r--r--   1 libvirt-qemu kvm     66  3月 11 21:29 smbios_type_0.bin
-rw-r--r--   1 libvirt-qemu kvm    165  3月 11 21:29 smbios_type_1.bin
```

```
$ sudo cp /etc/apparmor.d/abstractions/libvirt-qemu /etc/apparmor.d/abstractions/libvirt-qemu.org
$ sudo nano /etc/apparmor.d/abstractions/libvirt-qemu
$ tail -n 5 /etc/apparmor.d/abstractions/libvirt-qemu
  # Support for this override will be removed in a future release
  ### DEPRECATED ###
  include if exists <local/abstractions/libvirt-qemu>

/home/mukai/.win11/** r,
$ sudo apparmor_parser -r /etc/apparmor.d/abstractions/libvirt-qemu
AppArmor parser error for /etc/apparmor.d/abstractions/libvirt-qemu in profile /etc/apparmor.d/abstractions/openssl at line 13: syntax error, unexpected TOK_MODE, expecting TOK_OPEN
```

なんかエラー出てるけど直接は関係なさそう。

virt-managerで「インストールの前に設定をカスタマイズする」を有効にしてXMLを編集する

## 環境変数の取り扱いの指針

空文字を真とするか迷うことが多い。シェルの挙動では空文字は偽。

```
$ sh -c 'if [ "$VAR" ]; then echo "true"; else echo "false"; fi'
false
$ VAR="" sh -c 'if [ "$VAR" ]; then echo "true"; else echo "false"; fi'
false
$ VAR="foo" sh -c 'if [ "$VAR" ]; then echo "true"; else echo "false"; fi'
true
```

つまりJavaScriptで同じ挙動にするなら単に`!envVar`でよい。おそらくこの理解は因果関係が逆転していて、実際にはJavaScriptがシェルの慣習に合わせたのだろう。

```js
import { inspect } from "node:util";

const envVar = process.env["VAR"];
//    ^? string | undefined

if (!envVar) {
  envVar;
  // ^? "" | undefined
  console.log(`"" or undefined: ${inspect(envVar)}`);
} else {
  envVar;
  // ^? string
  console.log(`string: ${inspect(envVar)}`);
}
```

```
$ node example.js
"" or undefined: undefined
$ VAR="" node example.js
"" or undefined: ''
$ VAR="foo" node example.js
string: 'foo'
```

## WSL＋Dockerディスク食いすぎ

ディスクがみるみるいっぱいになりついに何も保存できなくなったので確認すると、`%USERPROFILE%\AppData\Local\Docker\wsl\disk\docker_data.vhdx`が150GBを超えていた。

- https://stackoverflow.com/questions/70946140/docker-desktop-wsl-ext4-vhdx-too-large

根本的な原因はVHDXは自動縮小しないからということらしい。つまり対処法は「[WSLのディスクサイズを削減](../0192bc8a-4a12-77fc-964d-f225677966f8/README.md)」と同じ。ついでにWSLのディスクもつぶしておくとよさそう。

```
ECHO y | docker container prune
ECHO y | docker image prune
ECHO y | docker volume prune
ECHO y | docker builder prune
ECHO y | docker system prune

wsl --shutdown
(
ECHO select vdisk file="C:\Users\mukai\AppData\Local\Docker\wsl\disk\docker_data.vhdx"
ECHO attach vdisk readonly
ECHO compact vdisk
ECHO detach vdisk
ECHO exit
) | diskpart
```

`docker_data.vhdx`は150GB→1GBまで縮小された。さすがにどうにかしてほしい。私程度でもこうなるのなら、みんなもっと困らないのだろうか？

[回答](https://stackoverflow.com/a/72048670)にあるDocker Desktopの`Troubleshoot > Clean / Purge data > WSL 2 > Delete`を実行すると、さらに5GBほど空いた。

## GLM-MN3350

- https://www.gm-japan.co.jp/product/mn3350/

<dl>
<dt>CPU</dt><dd>Intel Celeron N3350 1.1-2.4GHz</dd>
<dt>RAM</dt><dd>4GB</dd>
<dt>ストレージ</dt><dd>64GB</dd>
<dt>備考</dt><dd>2021年にメルカリで購入</dd>
</dl>

Ubuntu Server 24.04.3をインストール。デフォルトから変更する点は、キーボード設定を「Layout: Japanese / Variant: Japanese」、「Search for third-party drivers」を有効化。他にはenp1s0がDHCP有効になっている点が後で重要だった。

インストール直後の再起動後、`networkctl status enp1s0`を実行し`192.168.0.3`を割り当てられたことを確認。サーバーをシャットダウン。ルーターに固定割り当て設定を追加。ルーターの設定を永続化し再起動。サーバーを再起動。するとなぜか`192.168.0.4`を割り当てられている。

Ubuntu Serverが既定で使用するsystemd-networkdのDHCPクライアントは、デフォルトでDUIDをClient IDに使用する（Ubuntu Desktopが使用するNetworkManagerの内蔵DHCPクライアントはMACを使用する？　未確認）。

/etc/netplan/99-set-dhcp-identifier-mac.yamlを以下の内容で作成する。なお同ディレクトリには50-cloud-init.yamlが存在するが、cloud-init自体は/etc/cloud/cloud-init.disabledによって無効化されている（ローカルマシンにインストールされていることを検知して自動で無効化する？　未確認）。ファイル名は任意だが既存の設定ファイルに順序で負けない名前にすること。

```
network:
  version: 2
  ethernets:
    enp1s0:
      dhcp4: true
      dhcp-identifier: mac
```

再起動後`networkctl status enp1s0`を実行し、`.3`を割り当てられたことを確認する。

このマシンをVPNサーバーとし、VPN経由でSSHアクセスを開放する。

```
$ sudo apt update
$ sudo apt --yes install wireguard
$ cd ~/wireguard
$ bash
$ umask 077
$ wg genkey | tee glm-mn3350_private.key | wg pubkey > glm-mn3350_public.key
$ wg genkey | tee client_private.key | wg pubkey > client_public.key
$ exit
```

<figure>
<figcaption>/etc/wireguard/wg0.conf</figcaption>

```
[Interface]
Address = 10.8.0.1/24
ListenPort = 51820
PrivateKey = (glm-mn3350_private.keyの中身)

[Peer]
PublicKey = (client_public.keyの中身)
AllowedIPs = 10.8.0.2/32
```

</figure>

メモ：Vimで、termの内容を選択してヤンクする。termウィンドウにカーソルがある状態で`Ctrl+W`、`Shift+N`。`i`で通常のターミナルに復帰。

WireGuardを有効化。

```
$ sudo systemctl enable --now wg-quick@wg0
```

Ubuntu Serverでは、既定ではファイアウォールが起動していない。

```
$ sudo ufw status
Status: inactive
$ sudo ufw enable
Firewall is active and enabled on system startup
```

```
$ sudo ufw allow 51820/udp
$ sudo ufw allow in on wg0 proto tcp to any port 22
```

ルーター側で「ポートマッピング設定」を行う。

SSHサーバーをインストールして有効化。

```
$ sudo apt install openssh-server
$ sudo systemctl status ssh
$ sudo systemctl enable --now ssh  # disabledなら
```

クライアント側でもwireguardを有効化する。

<figure>
<figcaption>wg0.conf</figcaption>

```
[Interface]
Address = 10.8.0.2/24
PrivateKey = (client_private.key の中身)

[Peer]
PublicKey = (glm-mn3350_public.key の中身)
Endpoint = (GLM-MN3350のグローバルIP):51820
AllowedIPs = 10.8.0.0/24
PersistentKeepalive = 25
```

</figure>

`PersistentKeepalive = 25`がないと、WoLで起動した後自動でVPNに接続されなかった。

あとでWoLをやるつもり。

```
$ sudo apt install --yes wakeonlan
$ cat wakeonlan-(client-name).sh 
#!/bin/sh
wakeonlan (client_mac)
```

VPNを介してクライアント間で通信（10.8.0.2に開けたSSHに10.8.0.3のスマホからアクセスしたい）には追加の設定が必要。

```
$ sudo ufw route allow in on wg0 out on wg0
$ sudo vim /etc/ufw/sysctl.conf
  # net.ipv4.ip_forward=1を有効化
$ sudo vim /etc/default/ufw
  # DEFAULT_FORWARD_POLICY="DROP"を"ACCEPT"に変更
$ sudo ufw reload
```

## CLIでUSBストレージの安全な取り外し

`/dev/sde`を取り外す例。デバイスは`lsblk`で確認できる。

```
$ sync  # 数秒待つ。ステータスLEDなどがあれば動作が終了したことを確認する
$ sudo umount /dev/sde*
$ echo 1 | sudo tee /sys/block/sde/device/delete  # 数秒待ち、物理的に取り外す
```

確認

```
$ dmesg | tail -n 10
...
usb 1-3.2: USB disconnect, device number XX
```

## 再起動後にUEFIに入る

```
$ sudo systemctl reboot --firmware-setup
```

- ルート権限必須
- レガシーBIOSに対しては動作しない（物理入力でがんばる）

## Z390-A PRO (MS-7B98)におけるWoL有効化

- https://support.ask-corp.jp/hc/ja/articles/360046270034-MSI%E8%A3%BD%E3%83%9E%E3%82%B6%E3%83%BC%E3%83%9C%E3%83%BC%E3%83%89%E3%81%A7%E3%81%AEWake-On-LAN-WOL-%E3%81%AE%E8%A8%AD%E5%AE%9A%E6%96%B9%E6%B3%95%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6

- `Settings\Advanced\Power Management Setup\ErP Ready`を`Disabled`に、
- `Settings\Advanced\Wake Up Event Setup\Resume By PCI-E Device`と`Resume By Intel Onbord LAN/CNVi`を`Enabled`に

OS側の設定も必要。

```
$ ip link show  # 有線LANのインターフェースを探す
$ sudo ethtool eno1 | grep Wake-on
	Supports Wake-on: pumbg
	Wake-on: d  # disabled
$ nmcli connection show | grep eno1
netplan-eno1    10838d80-caeb-349e-ba73-08ed16d4d666  ethernet   eno1 
$ sudo nmcli connection modify "netplan-eno1" 802-3-ethernet.wake-on-lan magic
$ sudo nmcli connection up "netplan-eno1"
$ sudo ethtool eno1 | grep Wake-on
	Supports Wake-on: pumbg
	Wake-on: g
```

## マシンのグローバルIPアドレスを定期的に特定のGistにアップロードする

<figure>
<figcaption>upload-public-ip.sh</figcaption>

```sh
#!/bin/sh -eu

# - `Settings > Developer settings > Personal access tokens > Fine-grained tokens > Generate new token`
#   - `Repository access > Public repositories`
#   - `Permissions > Account > Add permissions > Gist`
TOKEN="github_pat"
GIST_ID="gist_id"
HOSTNAME="$(/bin/hostname)"
SAFE_HOSTNAME="$(/bin/echo "${HOSTNAME}" | /bin/tr --complement --delete 'A-Za-z0-9._-')"
FILENAME="${SAFE_HOSTNAME}-public-ip.txt"
IP="$(/bin/curl --fail --silent --show-error https://checkip.amazonaws.com | /bin/tr --delete '\n')"
DESC="Public IP updated at $(/bin/date --utc +%Y-%m-%dT%H:%M:%SZ) on ${HOSTNAME}"

# https://docs.github.com/en/rest/gists/gists?apiVersion=2022-11-28#update-a-gist
/bin/curl --fail --silent --show-error \
  --request PATCH \
  --header "Accept: application/vnd.github+json" \
  --header "Authorization: Bearer ${TOKEN}" \
  --header "X-GitHub-Api-Version: 2022-11-28" \
  "https://api.github.com/gists/${GIST_ID}" \
  --data "{\"description\":\"${DESC}\",\"files\":{\"${FILENAME}\":{\"content\":\"${IP}\n\"}}}"
```

</figure>

```
$ crontab -e

# 末尾に追記：
# */30 * * * * /home/mukai/upload-public-ip.sh >> /home/mukai/upload-public-ip.log 2>&1
```

別解として[glotlabs/gdrive](https://github.com/glotlabs/gdrive)でGoogle Driveにアップロードする方法もあるが、セットアップ手順が少し面倒。

- [自宅のグローバルIPアドレスを外出先で知る #RDP - Qiita](https://qiita.com/itagagaki/items/7720d0632f9fd9c78673)

## SSH／RDPからでもカメラやマイクに触りたい

SSHで入っているマシンで`/dev/video0`に触ろうとしたら動かなかった。

```
$ ls -l /dev/video*
crw-rw----+ 1 root video 81, 0 10月 17 12:15 /dev/video0
crw-rw----+ 1 root video 81, 1 10月 17 12:15 /dev/video1
$ uv run --with opencv-python python -c "import cv2; ret, _ = cv2.VideoCapture(0).read(); ret"
[ WARN:0@0.008] global cap_v4l.cpp:914 open VIDEOIO(V4L2:/dev/video0): can't open camera by index
[ WARN:0@0.009] global obsensor_stream_channel_v4l2.cpp:82 xioctl ioctl: fd=-1, req=-2140645888
[ WARN:0@0.009] global obsensor_stream_channel_v4l2.cpp:138 queryUvcDeviceInfoList ioctl error return: 9
[ WARN:0@0.009] global obsensor_stream_channel_v4l2.cpp:82 xioctl ioctl: fd=-1, req=-2140645888
[ WARN:0@0.009] global obsensor_stream_channel_v4l2.cpp:138 queryUvcDeviceInfoList ioctl error return: 9
[ERROR:0@0.009] global obsensor_uvc_stream_channel.cpp:163 getStreamChannelGroup Camera index out of range
```

既定では、映像やオーディオデバイスはGUIセッションに紐付いている。誰かが不正にログインした場合に自宅の映像や音声を引き抜かれてしまったら大事故だから、妥当に思える。

リモートアクセスでも使用するためには次のように設定してマシン再起動する。

```
$ sudo cat /etc/udev/rules.d/99-remote-media-uaccess.rules
SUBSYSTEM=="video4linux", TAG+="uaccess", MODE="0666"
SUBSYSTEM=="sound", TAG+="uaccess", MODE="0666"
```

uaccessタグはsystemd-logindと連携して、現在アクティブなユーザーにアクセス権を付与する。

```
$ uv run --with opencv-python python -c "import cv2; ret, _ = cv2.VideoCapture(0).read(); ret"
True
```

## 退避ファイルの拡張子はorgよりorigがよい

- diff/patchが生成するのはorig
  - 同じディレクトリに残す場合、origは無視するがorgはうまく無視できないソフトウェアがある……らしい https://qiita.com/tohta/items/5b48c328413e5772175a
- orgはどちらかというとorganizationを思い起こす

orz←これは失意体前屈


## ThinkPad X1 Carbon Gen 12利用ログ

### UEFI設定

```
Config > Keyboard/Mouse > Trackpad > Off
  Fn and Ctrl Key swap > On
Security > Secure Boot > Off
Startup > Boot > Boot Priority Order　よしなに
```

### Ubuntuのインストール

```
Choose your language: (使用する言語を選択してください:) > 日本語
次
Ubuntuのアクセシビリティ
次
キーボードレイアウトを選択してください > 日本語
キーボードバリアントを選択: > 日本語
次
インターネットの接続方法を選択してください > 有線接続を使用
次
インストーラーのアップデートが適用できます > 今すぐアップデート > インストーラーを閉じる
DockからInstall RELEASEを起動
使用する言語を選択してください: > 日本語
次
Ubuntuのアクセシビリティ
次
キーボードレイアウトを選択してください > 日本語
キーボードバリアントを選択: > 日本語
次
インターネットの接続方法を選択してください > 有線接続を使用
次
Ubuntuをインストールしますか？ > 対話式インストール
次
開始時にどのアプリをインストールしますか？ > 既定の選択
次
推奨するプロプライエタリなソフトウェアをインストールしますか？
　+ グラフィックスとWi-Fi機器用のサードパーティ製ソフトウェアをインストールする
　+ 追加のメディアフォーマット用のサポートをダウンロードしてインストールする
次
どうやってUbuntuをインストールしますか？
ディスクを削除してUbuntuをインストールする
次
アカウントの設定
あなたの名前　Koutaro Mukai
コンピューターの名前　mukai-ThinkPad-X1-Carbon-Gen-12
ユーザー名を入力　mukai
+ ログイン時にパスワードを要求する
次
タイムゾーンを選択してください
現在地　Tokyo (Tokyo, Japan)
タイムゾーン　Asia/Tokyo
次
これまでの選択を確認してください
インストール

今すぐ再起動
Please remove the installation medium, then press ENTER:


Ubuntu 24.04.3 LTSへようこそ！
次へ
Ubuntu Proを有効化する > Skip for now
スキップ
Ubuntuの改善を支援する > はい、システムデータをUbuntuチームと共有します
次へ
さらにアプリケーションを追加する
完了
```

### 初期設定

```
設定 > ディスプレイ
+任意倍率のスケーリング
スケール　150%
適用
```

- ［設定］＞［マウスとタッチパッド］＞［タッチパッド］タブ＞［Touchpad］無効化
- ［設定］＞［Ubuntu Desktop］＞［Dockを自動的に隠す］
- ホームディレクトリの英語化

```
$ LANG=C xdg-user-dirs-update --force
$ rmdir ダウンロード
$ rmdir テンプレート
$ rmdir デスクトップ
$ rmdir ドキュメント
$ rmdir ビデオ
$ rmdir ピクチャ
$ rmdir ミュージック
$ rmdir 公開
$ systemctl reboot
［次回から表示しない］＞［古い名前のままにする］
$ systemctl reboot
```

ホームのデスクトップアイコンを画面右下端に移動。触ってしまったから自動で動かなかったのかも？

- フリーズ判定を少し長く

```
$ gsettings get org.gnome.mutter check-alive-timeout
uint32 5000
$ gsettings set org.gnome.mutter check-alive-timeout 10000
$ gsettings get org.gnome.mutter check-alive-timeout
uint32 10000
```

- Tweaks

```
$ sudo apt update
$ sudo apt --yes upgrade
$ sudo apt --yes install gnome-tweaks
```

- Mouse & Touchpad > 中クリックによる貼り付け　off
- 外観 > Styles > アイコン > Yaru-magenta
- レガシーなアプリケーション > Yaru-magenta

### Google Chrome

```
cd Downloads/
wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
$ sudo dpkg -i google-chrome-stable_current_amd64.deb 
$ sudo apt --fix-broken --yes install
```

- ［Google Chromeを既定のブラウザにする］
- ［使用統計データと障害レポートをGoogleに自動送信します］

```
Chromeにログイン
同期をオンにする
Chromeで表示される広告に対するプライバシー強化について
理解しました
```

- Chromeをピン留めしてFirefoxを外す

### デスクトップ壁紙

壁紙はPictures直下に置く。右クリック　背景として設定 > 設定

### VPN接続

```
$ sudo apt --yes install wireguard
$ sudo tee /etc/wireguard/wg0.conf >/dev/null <<EOF
[Interface]
Address = 10.8.0.4/24
PrivateKey = (mask)

[Peer]
PublicKey = qXCUF/jyT4hm7oVO9ftDTLz1MrpMAdh7CrUlqsHfICY=
Endpoint = 118.156.113.172:51820
AllowedIPs = 10.8.0.0/24
PersistentKeepalive = 25
EOF
$ sudo systemctl enable --now wg-quick@wg0
$ ssh mukai@10.8.0.1  # 疎通チェックOK
```

SSHサーバーを開始して、こちらにもログインできるように

```
$ sudo apt install --yes openssh-server
$ sudo systemctl enable --now ssh
$ sudo ufw allow from 10.8.0.0/24 to any port 22
$ sudo ufw enable
```

別の端末から`ssh mukai@10.8.0.4`。通らん　とりあえず再起動`systemctl reboot`

ルールの追加方法が間違っていた。wg0内で許可するならこちらのほうが明確

```
$ sudo ufw delete allow from 10.8.0.0/24 to any port 22
$ sudo ufw allow in on wg0 to any port 22
$ sudo ufw reload
```

別の端末から`ssh mukai@10.8.0.4`。OK

### 電源モード

設定 > 電源管理 > 電源モード　Performance

### スリープ時の挙動設定

フタ閉じたあともSSHアクセスを開けておきたい

```
$ gsettings get org.gnome.settings-daemon.plugins.power lid-close-ac-action
'suspend'
$ gsettings set org.gnome.settings-daemon.plugins.power lid-close-ac-action 'nothing'
$ sudo nano /etc/systemd/logind.conf
  # 以下2項目を設定
  # HandleLidSwitch=ignore
  # HandleLidSwitchDocked=ignore
```

開くようになった。

いつの間にか「ホーム」のデスクトップアイコンが1コマ左に動いている。右端に寄せ直す

### VS Code

```
https://code.visualstudio.com/
code_1.105.0-1759933565_amd64.debをダウンロード
$ sudo dpkg -i code_1.105.0-1759933565_amd64.deb
  # PPAが登録されるようだ
$ sudo apt --fix-broken --yes install
日本語言語パックを追加
MS-CEINTL.vscode-language-pack-ja
VS Codeを再起動
```

中クリックでペーストの挙動を切る

- ユーザー設定 > 設定 > editor.selectionClipboard: false https://github.com/microsoft/vscode/issues/14610

### VNC/RDPビュアー

- https://gitlab.com/Remmina/Remmina/-/wikis/home

Flatpakが先頭にあるのでこれがよさそうGNOME Softwareは使っていないから、GNOME Software Flatpak pluginはスキップ

- https://flathub.org/en/setup/Ubuntu

```
$ sudo apt install flatpak
$ flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo

"To complete setup, restart your system."とのことなので
$ systemctl reboot

$ flatpak install --user flathub org.remmina.Remmina
Looking for matches…
error: No remote refs found for ‘flathub’
```

？？？
flathubのremote自体も--userで管理しなくてはならないそうだ

```
$ flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
$ flatpak install --user flathub org.remmina.Remmina
$ flatpak run --user org.remmina.Remmina
```

Remminaのログイン時自動起動は不要。ハンバーガーメニュー＞アプレット＞ユーザーのログイン時に起動してトレイに格納する　無効化

### GitHub CLI

```
$ sudo apt install gh
$ gh auth login
- GitHub .com
- HTTPS
- Authenticate Git: Yes
unable to find git executable in PATH; please install git before retrying
```

はい…

```
$ sudo apt install git
$ git config --global user.email "mail"
$ git config --global user.name "Koutaro Mukai"

$ gh auth login
- Login with a web browser
```

### dotfiles導入

```
$ cd ~
$ git clone https://github.com/u1f992/dotfiles
$ cd dotfiles
$ ./link.sh
./link.sh: 6: curl: not found
./link.sh: 7: curl: not found
$ sudo apt install curl
$ ./link.sh
```

### Vim

いくつかのパッケージからインストールできるが、OSのクリップボードと連携してくれると助かる

```
$ sudo apt install vim-gtk3
$ vim --version | grep clipboard
+clipboard         +keymap            +printer           +vertsplit
+ex_extra          +mouse_netterm     +syntax            +xterm_clipboard
$ gvim --version | grep clipboard
+clipboard         +keymap            +printer           +vertsplit
+ex_extra          +mouse_netterm     +syntax            +xterm_clipboard
```

### VS Code拡張機能

- VS Code Remote Development拡張を追加 `ms-vscode-remote.vscode-remote-extensionpack`
- vscode-pdf拡張を追加 `tomoki1207.pdf`

### u1f992/blogの依存

```
sudo apt install make
sudo apt install python3-venv
```

### ハードウェアのカスタム

- 触覚タッチパッドをトラックパッドに換装
- FnキーとCtrlキーのキートップを入れ替え

パンタグラフ式キーボードの断面図は「又」のような形になる。この中心の逆三角形の隙間に工具を差し込み、「☓」から剥がすように斜め上方向にゆっくりと力を入れるとキートップだけを剥がせる。ThinkPad X1 Carbon Gen 12はキーストロークが短く、装着済みの状態でキートップを剥がすのは現実的ではない。キーボードをCカバー（パームレストとキーボードが一体になった状態）から剥がしておくとマシ。トラックパッド側は引っ掛ける形状で比較的外しやすく、ディスプレイ側は掴むようになっており外しづらい。

パンタグラフはツメで取り付けられている。トラックパッド側のツメがかかっている箇所の下に薄い工具を挟み込み慎重に持ち上げると外せる。

AliExpressとかで予備部品を確保したく、でも新しいから出回っておらず（セラーに聞いたらあるのかな？）難しめ

### Node.js

Node.jsの管理はfnmでいこう

- nvmと並んで https://nodejs.org/ja/download で紹介されているため
- nvmが.node-versionに対応しないため
- nvmは厳密にはクロスプラットフォームではなく、nvm-windowsは今後終了していくことが明言されているため https://github.com/coreybutler/nvm-windows/wiki/Runtime

https://github.com/Schniz/fnm

```
$ curl -fsSL https://fnm.vercel.app/install | bash
（ターミナルウィンドウを再起動）
$ fnm install 22
$ node -v
v22.20.0
$ npm -v
10.9.3
$ npm install --global npm@latest
$ npm -v
11.6.2

$ npm install -g @anthropic-ai/claude-code
```

### VS Codeの拡張機能追加

- `ms-python.python`
- `charliermarsh.ruff`
- `ms-python.mypy-type-checker`

### Python uv

https://docs.astral.sh/uv/getting-started/installation/

```
$ wget -qO- https://astral.sh/uv/install.sh | sh
$ source ~/.bashrc 
$ uv --version
uv 0.9.5
```

ネイティブ拡張のインストールにはどうせ使うか

```
sudo apt-get install build-essential
```

ファイルからパッケージを探すために

```
sudo apt-get install apt-file
```

pyaudioのために

```
sudo apt install --yes python3-dev 
```

### Docker

https://docs.docker.com/engine/install/ubuntu/

```
$ for pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; do sudo apt-get remove $pkg; done

$ sudo apt-get update
$ sudo apt-get install ca-certificates curl
$ sudo install -m 0755 -d /etc/apt/keyrings
$ sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
$ sudo chmod a+r /etc/apt/keyrings/docker.asc

$ echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update

$ sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

この段階ではdockerの実行にはsudoが必要で、次の手順に"If you initially ran Docker CLI commands using sudo before adding your user to the docker group,"という項目があり、設定ファイルの権限で不都合が発生する旨が説明されている。

ここではまだdockerを実行せずに、デーモンが起動しているかだけ確認しておくのがよさそう

```
$ sudo systemctl status docker
```

https://docs.docker.com/engine/install/linux-postinstall/

```
$ sudo groupadd docker
$ sudo usermod -aG docker $USER

$ grep docker /etc/group
docker:x:984:mukai

$ newgrp docker
$ docker run hello-world
```

再起動してDockerが自動起動することも確認しておく。

```
$ systemctl reboot
$ docker run hello-world
```

#### 雑チートシート

終了済みも含めてコンテナを表示

```
$ docker ps -a
CONTAINER ID   IMAGE         COMMAND    CREATED              STATUS                          PORTS     NAMES
e11498646114   hello-world   "/hello"   About a minute ago   Exited (0) About a minute ago             reverent_gates
d56ea7fc1cea   hello-world   "/hello"   5 minutes ago        Exited (0) 5 minutes ago                  trusting_wescoff
```

特定のコンテナを削除

```
$ docker rm e11498646114
```

または終了済みのコンテナをすべて削除

```
$ docker container prune
```

イメージを表示。ここで`-a/--all`は、タグのないイメージ（一般的には中間イメージ）を含めることを表している。これは`<none>`として一覧に現れる。

```
$ docker images -a
REPOSITORY    TAG       IMAGE ID       CREATED        SIZE
hello-world   latest    1b44b5a3e06a   2 months ago   10.1kB
```

特定のイメージを削除

```
$ docker rmi hello-world:latest
または docker rmi 1b44b5a3e06a
```

未使用のイメージをすべて削除

```
docker image prune -a
```

### ffmpeg

https://www.ffmpeg.org/download.html

Ubuntuのaptも公式の手順に含まれているから、これで良さそう

```
$ sudo apt update && sudo apt install --yes ffmpeg
```

### プリンター

C3935FのドライバはLinux版も提供されている

https://canon.jp/support/software/os/select?pr=5740&os=20

LIPSLX/ CARPS2とLIPS4があり、前者がデバイス固有、LIPS4が汎用ドライバらしい？

```
linux-lipslx-drv-v620-jp-01.tar.gzをダウンロード
$ tar xvf linux-lipslx-drv-v620-jp-01.tar.gz
$ cd linux-lipslx-drv-v620-jp/
$ sudo ./install.sh
```

Canon Printer Setup Utility 2 > 追加 > Canon iR-ADV C3935 LIPSLX

lpdが古いLine Printer Daemonプロトコルで、socketがただしい

IPアドレスはそのとおりに

### tmux

https://github.com/tmux/tmux/wiki/Installing

```
$ tmux
コマンド 'tmux' が見つかりません。次の方法でインストールできます:
sudo snap install tmux  # version 3.5a, or
sudo apt  install tmux  # version 3.4-1ubuntu0.1
他のバージョンについては 'snap info tmux' を確認してください。
```

aptだと若干遅れているけど、aptを勧められているな

### ターミナルからクリップボードへコピー

```
$ sudo apt install xsel

$ echo 'Hello, World!' | xsel --clipboard --input
```

## WireGuard内の端末からのすべてのWeb通信を、WireGuardサーバー経由にする

一般的なVPNの使い方といえばこちらか

既存設定（クライアント側）

```
$ sudo wg show
interface: wg0
  public key: ...
  private key: (hidden)
  listening port: ...

peer: ...
  endpoint: ...
  allowed ips: 10.8.0.0/24
  latest handshake: 1 minute, 50 seconds ago
  transfer: 408.61 KiB received, 864.52 KiB sent
  persistent keepalive: every 25 seconds
```

既存設定（WireGuardサーバー側）

```
$ sudo wg show
interface: wg0
  public key: ...
  private key: (hidden)
  listening port: ...

peer: ...
  endpoint: ...
  allowed ips: 10.8.0.4/32
  latest handshake: 16 seconds ago
  transfer: 46.84 MiB received, 1.26 MiB sent

...
```

クライアント側の新規設定

```
- AllowedIPs = 10.8.0.0/24
+ AllowedIPs = 0.0.0.0/0, ::/0
```

サーバー側の新規設定

- [IPフォワーディングの有効化](../0199d804-fa2f-7925-82e1-003224f2d920/README.md)
  - `/etc/sysctl.conf`と`/sys/ufw/sysctl.conf`がある。ufwのほうが後に起動して前者を上書きするはず。

サーバーからインターネットへ出るインターフェイスを調べる。ここでは`enp1s0`

```
$ ip route show default
default via 192.168.0.1 dev enp1s0 proto dhcp src 192.168.0.3 metric 100 
```

ファイル先頭にIPマスカレード設定を追加

```
$ sudo cat /etc/ufw/before.rules  | head -n 7
*nat
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING -s 10.8.0.0/24 -o enp1s0 -j MASQUERADE
COMMIT

#
# rules.before
```

設定が正しく反映されたことを確認

```
$ sudo ufw reload
$ sudo iptables -t nat -L POSTROUTING -n -v
Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination 
        
    0     0 MASQUERADE  0    --  *      enp1s0  10.8.0.0/24          0.0.0.0/0  
         
```

クライアント側のWireGuardも再起動

```
$ sudo systemctl restart wg-quick@wg0
```

最後にクライアント側から実行する`curl https://checkip.amazonaws.com`の示すグローバルIPアドレスがVPNサーバーのものになっていれば成功。

