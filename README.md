# 雑記帳

- [このリポジトリの使い方](articles/0192bc26-0274-7afd-884e-2b1c281803c2/README.md)
- [Windows Terminalでtmuxを起動するワークアラウンド](articles/0192bc2f-0917-7ea9-a216-050a39e24dc5/README.md)
- [Vimの正規表現の先読み・後読み](articles/0192bc81-e319-7600-95b6-4b1decd06e27/README.md)
- [Scribusを経由して印刷仕様のPDFを出力する](articles/0192bc82-be64-76fe-8d1a-cf40d8377fad/README.md)
- [mintty.exeでWSLを起動する](articles/0192bc83-270f-7de8-9497-3bbc28d5affa/README.md)
- [MSYS2にいつも入れてるもの](articles/0192bc83-5780-76f8-a69d-4cf519b25b4f/README.md)
- [JScriptをバッチファイルに埋め込む（Shebangもどき）](articles/0192bc83-a5de-7ad6-9632-21f469ff6e5a/README.md)
- [WSL2のNode.jsにPlaywrightでChrome入れたけど動かん](articles/0192bc85-588a-7e31-9e2f-6364e42152b1/README.md)
- [Invoke-WebRequestのリダイレクトをトレースしたい（wip）](articles/0192bc85-79d4-7bfd-99c3-45282a4fb244/README.md)
- [ワーキングディレクトリ内のファイル名がある正規表現にマッチするファイルから、ある正規表現にマッチする行を抽出する on WSL](articles/0192bc85-ccc7-778e-8615-fb5c0e424eba/README.md)
- [シンボリックリンクを含むGitリポジトリ](articles/0192bc86-b1bb-7a96-b096-ec7e994ce895/README.md)
- [PDF切り出しに使うTeXのテンプレート](articles/0192bc87-2614-7d9a-9d53-ab3ba166e71b/README.md)
- [カレントディレクトリ以下のPNG画像をJPGに変換する](articles/0192bc87-6e0d-7670-8897-90c2e79490ae/README.md)
- [PSoC 4ハードウェア設計上の注意事項](articles/0192bc87-e358-7964-8446-a721b0b89fcf/README.md)
- [貧弱なJavaScriptでUUIDを生成する](articles/0192bc88-03ef-7d7f-8c08-6c0d12074c54/README.md)
- [PDFの指定したページをトリミングして出力](articles/0192bc89-1b1d-7c66-b6ad-9cc47c17acc2/README.md)
- [WSLのディスクサイズを削減](articles/0192bc8a-4a12-77fc-964d-f225677966f8/README.md)
- [MSYS2環境を現在のターミナルで開く](articles/0192bc8c-6edd-7651-9e5c-5791658a2064/README.md)
- [MarkdownのテーブルをHTMLに置換](articles/0192bc8e-04de-7648-ade2-e0ccaf7d2033/README.md)
- [WindowsのセットアップをMSアカウントなしで行う](articles/0192bc8e-8d00-7033-9b50-61f3bbfe0647/README.md)
- [現在のPowerShellセッションにMSYS2のパスを追加](articles/0192bc8e-ff23-7bb9-97c5-075aeaacd9f0/README.md)
- [ChatGPTにプロジェクトのファイル全部食わせる](articles/0192bc8f-8faf-7263-b196-60026e00296e/README.md)
- [追跡中のすべてのC言語ファイルにフォーマッタをかける](articles/0192bc90-fd9a-7d6a-aa08-69ffbf1b77db/README.md)
- [WSL2にデスクトップを生やす](articles/0192bc91-5a09-729c-ad7d-fb412cdaadd6/README.md)
- [VirtualBoxの右上に出てくる通知センターを消す](articles/0192bc91-ba73-7ede-b781-43c03d683761/README.md)
- [VirtualBoxのディスクイメージの履歴をクリアする](articles/0192bc92-24e5-7906-983b-c4e2fbbfdf27/README.md)
- [MSYS2でddrescueのビルド](articles/0192bc92-6cbe-717a-a64b-e4558161e869/README.md)
- [tmux](articles/0192bc92-b5df-7541-a355-dc1ee54c4be2/README.md)
- [GNU Screen 4.9.1のビルド](articles/0192bc93-21f7-78d1-adcf-32e5b10a9268/README.md)
- [C言語の規格書](articles/0192bc93-fea7-738e-8373-9d5d64a9e45c/README.md)
- [MSYS2シェル内でvimを開くとき](articles/0192bc94-3f7c-7af9-a4f3-e913e49c66fd/README.md)
- [PythonスクリプトでGUIのファイル選択ウィンドウを出す](articles/0192bc94-7ec4-7485-857c-e7740ef2f251/README.md)
- [Ghostscriptの`inkcov`と`ink_cov`](articles/0192bc94-cecb-7136-946e-b166c175a9a5/README.md)
- [JapanColor2001Coated.icc](articles/0192bc95-5738-7898-91eb-52f419a9a534/README.md)
- [qpdf](articles/0192bc95-8b91-7727-8e89-ec30b9c57400/README.md)
- [PlatformIO+Arduino-Picoの更新](articles/0192bc95-c61c-744d-ac0f-76d28bc30d3b/README.md)
- [プライベートなnpmパッケージ](articles/0192bc96-0021-7e81-956f-0489d3d877f2/README.md)
- [メモリ上のELFバイナリを実行するPythonコード](articles/0192bc96-356e-7cde-83e0-2639cf783e3a/README.md)
- [Realtekの汎用ASIOドライバー](articles/0192bca2-e6a5-75ff-87e7-36446aafa536/README.md)
- [WindowsにおけるPythonのshebang（？）](articles/0192d0e9-8a12-77fa-884f-0f05abb1505b/README.md)
- [HTMLの前処理について雑感](articles/0192e054-20e7-7a85-86e8-0f42192227d6/README.md)
- [MSYS2のポータブル環境](articles/0192e10e-9d82-7ef4-8e4b-4c1f7359b3e7/README.md)
- [MSYS2 UCRT64でgdome2をビルドする](articles/0192e2dd-ff19-70dd-9a75-038df515996c/README.md)
- [CUERipperメモ](articles/019333d9-b6e8-770a-94c4-f57f586152ba/README.md)
- [PDFから「しおり」を抽出](articles/01933dc7-1b4a-7d58-9bb9-e473c4b877f7/README.md)
- [PDFをPNGに変換](articles/01935161-66d4-7c5b-9fac-472547dcb5e4/README.md)
- [白背景を詰める](articles/01935308-3b79-7444-8aeb-993a16fa72f4/README.md)
- [基本的にDocker内で使っているツール類](articles/01938f77-d329-755c-8dd0-24fc4492e621/README.md)
- [`*.ai` → `*.pdf`](articles/0193949c-0606-7614-8cee-5b821c9a6e56/README.md)
- [CSS `rgb()`の小数点数を特定要素に設定する](articles/0193dd27-ddcb-7d77-84e8-565fa818cafe/README.md)
- [コマンドプロンプトの起動時スクリプト](articles/019439e6-6b18-7dd9-add3-7582c1253921/README.md)
- [漢字かな交じり文の読みを調べる（Windows＋Excel）](articles/0194a7a3-dd04-7957-9a0f-8cda83172878/README.md)
- [SVGの`text`要素のアウトライン化と選択・検索を両立させる](articles/0194b5a6-20b9-7e06-ac1d-5412b4342236/README.md)
- [ディスクのフルバックアップイメージをマウントする](articles/0194c92a-d133-7f46-a3c6-191bbbc756f1/README.md)
- [AppImageをランチャーに追加する（Ubuntu 24.04）](articles/0194d66f-55fa-7755-93b3-7b488b50edaa/README.md)
- [RDPメモ](articles/0194ed9c-6542-7516-b04b-c25dccd11704/README.md)
- [`text-box`メモ](articles/01951267-68df-7629-8afc-4572753e5735/README.md)
- [トラックポイントキャップを買い換える](articles/01951e68-af72-78bc-8b57-faa9d8219340/README.md)
- [Native Accessのアップデートを阻止する](articles/01952945-f85d-7592-b79c-d6b37ce7fd3a/README.md)

---

## このリポジトリの使い方

いつか役に立つかもしれないけど、技術ブログなんて大層なものを運用するほどではない気がする。こういうシンプルなやつでいい。

### 新規記事を作成

- タイトルは`h2`
- 末尾に改行を付ける

```
$ make new
```

### `./README.md`を作成

```
$ make README.md
```

## Windows Terminalでtmuxを起動するワークアラウンド

Windows Terminal内で[`C:/msys64/msys2_shell.cmd -defterm -here -no-start -ucrt64`](https://www.msys2.org/docs/terminals/)等のコマンドで起動したMSYS2シェルではtmuxを起動できない。scriptコマンドを経由することで問題を回避できる。

```console
$ tmux
open terminal failed: not a terminal

$ script --quiet --command tmux /dev/null

$ cat << EOS > /usr/bin/tmux-wt
#!/bin/bash
script --quiet --command tmux /dev/null
EOS
```

https://github.com/microsoft/terminal/issues/5132#issuecomment-1009022843

<!-- あやしい
なお`script.exe`をフルパスで指定すれば、PowerShellからでも起動できる。

```console
> C:\msys64\usr\bin\script.exe -q -c tmux /dev/null
```
-->

## Vimの正規表現の先読み・後読み

（後読み）「後ろにダブルクオートが続くダブルクオート」`/"(?=")/`と等価なVimの正規表現は`\v""@=`

（先読み）「直前に`/^M[0-9]-/`がある`[0-9]+`」`/(?<=^M[0-9]-)[0-9]+/`と等価なVimの正規表現は`\v(^M[0-9]-)@<=[0-9]+`

## Scribusを経由して印刷仕様のPDFを出力する

https://www.klaasnotfound.com/2016/06/05/creating-cmyk-prepress-pdfs-with-inkscape-and-scribus/

まあScribusのPDF出力バックエンドもGhostscriptだとは思うんだけども

## mintty.exeでWSLを起動する

`C:\msys64\usr\bin\mintty.exe C:\Windows\System32\wsl.exe --cd "~"`へのショートカットを作成する。Git Bashでもいけるかも。

```
> $wshShell=New-Object -ComObject "WScript.Shell";$wslPath="C:\Windows\System32\wsl.exe";$minttyPath="C:\msys64\usr\bin\mintty.exe";$lnk=$wshShell.CreateShortcut("$($PWD.Path)\wsl.exe.lnk");$lnk.TargetPath=$minttyPath;$lnk.Arguments="$wslPath --cd ""~""";$lnk.WorkingDirectory=$PWD.Path;$lnk.IconLocation="$wslPath, 0";$lnk.Save();
```

```javascript
var wshShell = new ActiveXObject("WScript.Shell");
var curDir = wshShell.CurrentDirectory;
var wslPath = "C:\\Windows\\System32\\wsl.exe";

var lnk = wshShell.CreateShortcut(curDir + "\\wsl.exe.lnk");
lnk.TargetPath = "C:\\msys64\\usr\\bin\\mintty.exe";
lnk.Arguments = wslPath + " --cd \"~\"";
lnk.WorkingDirectory = curDir;
lnk.IconLocation = wslPath + ", 0"
lnk.Save();
```

なんでこんなことをするかというと、MSYS2よりはWSLのほうが"ほぼLinux"として扱いやすいが、Windows Terminalはsixelに対応してないので面白くなかったりキーボードショートカットがおせっかいだったりして好きじゃないから。

フォント設定などもろもろ`.minttyrc`はMSYS2の`$HOME`に置いておく。

バッチファイルのほうがいいかも。この場合`.minttyrc`はWindows側の`%USERPROFILE%`に置いておく。

```
C:\msys64\usr\bin\mintty.exe --title wsl --icon C:\Windows\System32\wsl.exe,0 C:\Windows\System32\wsl.exe --cd "~"
```

応用のPowerShell。HOMEを設定しておかないと（Windows側の）Vimなど一部が正しく設定を読まない。

```
SET HOME=%USERPROFILE%
C:\msys64\usr\bin\mintty.exe --icon "C:\Program Files\PowerShell\7\pwsh.exe,0" "C:\Program Files\PowerShell\7\pwsh.exe" -WorkingDirectory %USERPROFILE%
```

## MSYS2にいつも入れてるもの

CMakeとMakeとGCCあればだいたいどうにかなるでしょ。

- [`mingw-w64-ucrt-x86_64-toolchain`](https://packages.msys2.org/groups/mingw-w64-ucrt-x86_64-toolchain)
- [`mingw-w64-ucrt-x86_64-cmake`](https://packages.msys2.org/package/mingw-w64-ucrt-x86_64-cmake)

## JScriptをバッチファイルに埋め込む（Shebangもどき）

詠み人知らず。

- https://miya2000.hatenadiary.org/entry/20090823/p0
- https://qiita.com/snipsnipsnip/items/50e4ca88e3ce3f8cffda

前提として、バッチファイルに構文エラーがあっても実行されない場合には問題にならない。

### JScript

```js
@if(0)==(0) ECHO OFF
CScript //Nologo //E:JScript "%~f0" %*
EXIT /B %ERRORLEVEL%
@end

WScript.StdOut.WriteLine("foo");
```

あるいは1行で

```js
@if(0)==(0) ECHO OFF && CScript //Nologo //E:JScript "%~f0" %* && EXIT /B %ERRORLEVEL% @end

WScript.StdOut.WriteLine("foo");
```

- バッチファイル側
  - `if`文にエコーを封じる@がついたもの
  - `(0)==(0)`が解釈され、trueなので`echo off`以降が実行される
  - 拡張子が`.bat`なのでエンジン指定は必須
  - `exit`で実行が止まるので、以降に構文エラー(=JScript)があっても問題にならない
- JScript側
  - `@if()`文……JScriptの[特殊文法](https://blog.delphinus.dev/2010/09/conditional-compilation-in-jscript.html)
  - `0`が解釈され、falseなので`@if(0)`～`@end`は無視される

### Chakra

```js
<!-- : ^
/*
@cscript /nologo /e:{1b7cd997-e5ff-4932-a7a6-2a9e636da385} "%~f0" %*
@exit /b %errorlevel%
*/

"use strict"
WScript.StdOut.WriteLine(WScript.Arguments(0));
try{WScript.Quit(99);}catch(e){}
```

- バッチファイル側
  - 1行目は `:` によってラベル定義なので問題なし
  - `^` によって制御文字CRLFを打ち消して、次の行の `/*` も1行目と同時に解釈される
  - `exit` まで実行。上述の通り
- Chakra
  - `<!--` をコメントとして扱うので、1行目はコメント
    - [HTML-likeコメント](https://jsprimer.net/basic/comments/)
  - 2~4行目は通常のコメント

## WSL2のNode.jsにPlaywrightでChrome入れたけど動かん

Vivliostyleのプレビューで必要だった。

Chromeを手で起動して、足りないと言われたものを`apt search`で探してかたっぱしから入れた。まあ起動はするけどたくさんエラーが出てるし、WSL2側にChromiumをインストールしたら解決する気がする。

```shell-session
$ /home/mukai/.cache/ms-playwright/chromium-1091/chrome-linux/chrome

$ sudo apt install -y x11-apps
$ sudo apt install -y libnss3
$ sudo apt install -y libatk1.0-0
$ sudo apt install -y libatk-bridge2.0-0
$ sudo apt install -y libxkbcommon0
$ sudo apt install -y libxcomposite1
$ sudo apt install -y libxdamage1
$ sudo apt install -y libxrandr2
$ sudo apt install -y libgbm1
$ sudo apt install -y libasound2
```

## Invoke-WebRequestのリダイレクトをトレースしたい（wip）

元はといえば（JScriptでも使える）`XMLHttpRequest`がリダイレクトを無効にしたりトレースしたりする機能がないのが悪い。

https://scrapbox.io/nwtgck/fetch()%E3%81%A7%E3%82%82XMLHttpRequest%E3%81%A7%E3%82%82%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E3%81%A7%E3%83%AA%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88%E3%82%92%E8%BF%BD%E8%B7%A1%E3%81%97%E3%81%A6XHR%E3%81%A0%E3%81%A8%E3%83%AA%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88%E3%81%95%E3%81%9B%E3%81%AA%E3%81%84%E6%96%B9%E6%B3%95%E3%81%AF%E3%81%AA%E3%81%84

```ps1
try { $res = Invoke-WebRequest -Method Head -Uri $uri -MaximumRedirection 0 } catch { $res = $_.Exception.Response }
```

`-MaximumRedirection 0`とすればリダイレクトしたときに`catch`に流れて、例外から`Response`を得られる。成功すればもちろんふつうに取得できる。これをdo-whileループにしたらいけるだろうと思う。

## ワーキングディレクトリ内のファイル名がある正規表現にマッチするファイルから、ある正規表現にマッチする行を抽出する on WSL

`clip.exe`はsjisなので文字コード変換が必要

https://zenn.dev/kumavale/scraps/2271c61cbd19ef

```
find . -regex './[0-9]-[0-9].txt' | xargs -I{} grep '^■■' {} | iconv -t sjis | clip.exe
```

## シンボリックリンクを含むGitリポジトリ

例：https://github.com/U-1F992/nthaka

`example/lib/nthaka`がリポジトリのルート（`../..`）を指している。

Windowsではこんな感じで作る。

```
> cd example
> sudo cmd /c mklink /D .\lib\nthaka ..\..
```

クローンする時も管理者権限が必要。

```
> sudo git clone -c core.symlink=true https://github.com/U-1F992/nthaka.git
```

## PDF切り出しに使うTeXのテンプレート

まれによく使う。

```tex
\documentclass{standalone}
\usepackage{graphicx}
\begin{document}

% GIMPにインポートして各座標を調べておく。300dpiはあったほうがいい。単位はbp。
% PDFの座標は左下が0,0であることに要注意。
\includegraphics[page=1, viewport=左下x 左下y 右上x 右上y, clip]{input.pdf}

\end{document}
```

## カレントディレクトリ以下のPNG画像をJPGに変換する

ファイル名を切り取るやつ、ほんと覚えられない……

```
for file in $(find . -name "*.png" -type f); do convert "$file" "${file%.png}.jpg"; rm "$file"; done
```

PNGの圧縮を調節したかったので結局こっちを使った。8並列optipng

```
find . -name "*.png" -type f -print0 | xargs -0 -P8 -n1 optipng -o7
```

## PSoC 4ハードウェア設計上の注意事項

https://community.infineon.com/t5/%E3%83%8A%E3%83%AC%E3%83%83%E3%82%B8%E3%83%99%E3%83%BC%E3%82%B9%E3%82%A2%E3%83%BC%E3%83%86%E3%82%A3%E3%82%AF%E3%83%AB-KBA/AN88619-PSoC-4%E3%83%8F%E3%83%BC%E3%83%89%E3%82%A6%E3%82%A7%E3%82%A2%E8%A8%AD%E8%A8%88%E4%B8%8A%E3%81%AE%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A0%85-Community-Translated-JA/ta-p/250231

## 貧弱なJavaScriptでUUIDを生成する

そもそも筋がいい方法ではないが、雑なUUID風文字列よりはいいだろう。

```js
/** From: https://stackoverflow.com/a/8809472 */
function generateUUID() { // Public Domain/MIT
    var d = new Date().getTime();//Timestamp
    var d2 = ((typeof performance !== 'undefined') && performance.now && (performance.now()*1000)) || 0;//Time in microseconds since page-load or 0 if unsupported
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16;//random number between 0 and 16
        if(d > 0){//Use timestamp until depleted
            r = (d + r)%16 | 0;
            d = Math.floor(d/16);
        } else {//Use microseconds since page-load if supported
            r = (d2 + r)%16 | 0;
            d2 = Math.floor(d2/16);
        }
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
}
```

## PDFの指定したページをトリミングして出力

座標指定は左下原点のbp

#### pdfcroppages.py

```py
import argparse
import os
import pathlib
import subprocess
import tempfile


def parse_pages(raw: str):
    pages: list[int] = []
    parts = raw.split(",")
    for part in parts:
        if "-" in part:
            start, end = map(int, part.split("-"))
            pages.extend(range(start, end + 1))
        else:
            pages.append(int(part))
    return pages


def generate_cropping_tex(
    page: int, viewport: tuple[float, float, float, float], posix_rel_path: str
):
    return f"""\\documentclass{{standalone}}
\\usepackage{{graphicx}}
\\begin{{document}}
\\includegraphics[page={page}, viewport={" ".join([str(coord) for coord in viewport])}, clip]{{{posix_rel_path}}}
\\end{{document}}
"""


def run_pdflatex(input: pathlib.Path):
    _ = subprocess.run(
        ["pdflatex", "-output-directory", str(input.parent), str(input)],
        check=True,
        capture_output=True,
    )
    assert input.with_suffix(".aux").exists()
    assert input.with_suffix(".log").exists()
    assert input.with_suffix(".pdf").exists()


def run_pdfunite(input: list[pathlib.Path], output: pathlib.Path):
    _ = subprocess.run(
        [
            "pdfunite",
            *[str(_) for _ in input],
            str(output),
        ],
        check=True,
        capture_output=True,
    )
    assert output.exists()


def main():
    parser = argparse.ArgumentParser(
        description="Crop a PDF file using a specified box"
    )
    parser.add_argument("input", type=str, help="Path to the input PDF file")
    parser.add_argument("pages", type=str, help="Comma-separated list of pages to crop")
    parser.add_argument("lx", type=float, help="X-coord of the bottom-left corner")
    parser.add_argument("ly", type=float, help="Y-coord of the bottom-left corner")
    parser.add_argument("rx", type=float, help="X-coord of the top-right corner")
    parser.add_argument("ry", type=float, help="Y-coord of the top-right corner")
    parser.add_argument("output", type=str, help="Path to the output PDF file")
    args = parser.parse_args()

    INPUT = pathlib.Path(args.input).resolve()
    OUTPUT = pathlib.Path(args.output).resolve()
    PAGES = parse_pages(args.pages)

    pdfs: list[pathlib.Path] = []

    for page in PAGES:
        temp = tempfile.NamedTemporaryFile(delete=False, suffix=".tex")
        try:
            temp_path = pathlib.Path(temp.name).resolve()
            input_posix_rel_path = INPUT.relative_to(
                temp_path.parent, walk_up=True
            ).as_posix()

            with open(temp.name, "w", encoding="utf-8") as f:
                f.write(
                    generate_cropping_tex(
                        page,
                        (args.lx, args.ly, args.rx, args.ry),
                        input_posix_rel_path,
                    )
                )

            run_pdflatex(temp_path)
            pdfs.append(temp_path.with_suffix(".pdf"))

            for suffix in [".aux", ".log"]:
                os.remove(str(temp_path.with_suffix(suffix)))

        finally:
            temp.close()  # Automatically removed

    try:
        # FIXME: pdfunite crashes with absolute input paths.
        cwd = pathlib.Path.cwd()
        run_pdfunite([pdf.relative_to(cwd, walk_up=True) for pdf in pdfs], OUTPUT)

    finally:
        for pdf in pdfs:
            os.remove(str(pdf))


if __name__ == "__main__":
    main()
```

## WSLのディスクサイズを削減

よく中身を見て使うこと！

https://qiita.com/siruku6/items/c91a40d460095013540d

`Optimize-VHD`はHyper-Vを有効にしないと（＝Pro版でないと）使用できないようだ。

```
ECHO y | docker container prune
ECHO y | docker image prune
ECHO y | docker volume prune
ECHO y | docker builder prune
ECHO y | docker system prune

wsl --shutdown
(
ECHO select vdisk file="C:\Users\mukai\AppData\Local\Packages\CanonicalGroupLimited.Ubuntu_79rhkp1fndgsc\LocalState\ext4.vhdx"
ECHO attach vdisk readonly
ECHO compact vdisk
ECHO detach vdisk
ECHO exit
) | diskpart

PAUSE
```

## MSYS2環境を現在のターミナルで開く

毎回忘れて[ここ](https://www.msys2.org/docs/terminals/)見ているなあ。`-full-path`でPATHの引継ぎの有無を変更できる。

```
C:/msys64/msys2_shell.cmd -defterm -here -no-start -ucrt64 -full-path
```

## MarkdownのテーブルをHTMLに置換

WIP

行選択：`^\| +([^ ]+) +\| +([^ ]+) +\| +([^ ]+) +\|$`

## WindowsのセットアップをMSアカウントなしで行う

https://news.yahoo.co.jp/articles/f7150bdb2419ad79e8bfa1f9593074b667fa1e3c?page=2

ローカルフォルダ名をアカウント名（メールアドレスの一部らしい？）にするのを本当にやめてくれ

1. <kbd>Shift</kbd>+<kbd>F10</kbd>でコマンドプロンプトを起動
2. `oobe\BypassNRO.cmd`を実行し、再起動を待機する
3. インターネット接続なしで進める
4. 「名前を入力します」で指定する名前がホームフォルダ名になる。

### ネットワークの設定を削除（誤って繋いでしまった時のリカバリ）

```
> netsh wlan show profile
> netsh wlan delete profile name="AP_NAME"
> shutdown -r
```

インターネットに接続しないまま、回復ドライブも作成しておく（購入時のスナップショットとして）。32GB以上の～と記載されていたが32GBで作成できた。

`%USERPROFILE%\OneDrive`にデスクトップやドキュメントを配置されるのもやめてほしい。オフラインのまま、OneDriveの同期設定を解除しアンインストールしておく。

1. （不要？）タスクバーのアイコン＞「ヘルプと設定」＞「設定」＞「アカウント」＞「このPCのリンク解除」
2. タスクバーのアイコン＞「ヘルプと設定」＞「OneDriveを閉じる」＞「OneDriveを終了する」
3. 「プログラムの追加と削除」からOneDriveをアンインストール

```
TASKKILL /F /IM OneDrive.exe /T

REM このコマンドとアンインストールは違うらしい。
REM 「プログラムの追加と削除」からアンインストールしたら下記のレジストリ操作をしなくてもエクスプローラーから消えた

REM 32bit
REM %SystemRoot%\System32\OneDriveSetup.exe /uninstall

REM 64bit
%SystemRoot%\SysWOW64\OneDriveSetup.exe /uninstall

RMDIR /Q /S "%USERPROFILE%\OneDrive"
RMDIR /Q /S "%LOCALAPPDATA%\Microsoft\OneDrive"
RMDIR /Q /S "%ProgramData%\Microsoft OneDrive"
RMDIR /Q /S "C:\OneDriveTemp"

REM 以下はレジストリを触るので調べながらやったほうがよい

reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\OneDrive" /v PreventNetworkTrafficPreUserSignIn /t REG_DWORD /d 1 /f

REM エクスプローラーのエントリ
REM HKEY_LOCAL_MACHINE/SOFTWARE/Microsoft/Windows/CurrentVersion/Explorer/MyComputer/NameSpace で紐づけられている
reg delete "HKEY_CLASSES_ROOT\CLSID\{018D5C66-4533-4307-9B53-224DE2ED1FE6}" /f
reg delete "HKEY_CLASSES_ROOT\Wow6432Node\CLSID\{018D5C66-4533-4307-9B53-224DE2ED1FE6}" /f
```

再起動後、ここで初めてインターネットに接続する。まずはWindows Update。

OfficeをインストールするにはMicrosoftアカウントによるサインインが必須になる。これもかなりいやな仕様だが……
仕方なくここでMicrosoftアカウントに切り替える

「設定」＞「アカウント」＞「ユーザーの情報」＞「アカウントの設定」＞「Microsoftアカウントでのサインインに切り替える」

OfficeをインストールしたらOneDriveが復活した、いらんねんそれは。同じ手順で削除していく

## 現在のPowerShellセッションにMSYS2のパスを追加

```
$env:Path += ";C:\msys64\ucrt64\bin"
```

## ChatGPTにプロジェクトのファイル全部食わせる

```
$ python -c "import subprocess;[print(chr(96)*3+filename+chr(10)+open(filename,encoding='utf-8').read()+chr(10)+chr(96)*3+chr(10)) for filename in subprocess.run(['git','ls-files'],capture_output=True,text=True,check=True).stdout.strip().split(chr(10))]"
```

`chr(96)`は`` ` ``、`chr(10)`は`\n`。エスケープのことを考えるのが面倒くさいため。

```python
import subprocess

[
    print(
        chr(96) * 3
        + filename
        + chr(10)
        + open(filename, encoding='utf-8').read()
        + chr(10)
        + chr(96) * 3
        + chr(10)
    )
    for filename in subprocess.run(
        ["git", "ls-files"], capture_output=True, text=True, check=True
    )
    .stdout.strip()
    .split(chr(10))
]
```

シェルワンライナーでもできるな

```
$ for file in $(git ls-files); do echo "#### $file"; echo ""; echo "\`\`\`"; cat "$file"; echo ""; echo "\`\`\`"; echo ""; done
```

## 追跡中のすべてのC言語ファイルにフォーマッタをかける

- `git ls-files`はフィルタできる
- `clang-format`のスタイル定義は`--style=file:~`で指定
- `-i`でインライン置換

```
$ git ls-files "*.c" "*.h" | xargs -I{} clang-format --style=file:.clang-format -i {}
```

## WSL2にデスクトップを生やす

https://github.com/microsoft/WSL/discussions/9350#discussioncomment-7492570

```
sudo apt-mark hold acpid acpi-support
sudo apt update && sudo apt -y install xrdp
sudo cp /etc/xrdp/xrdp.ini /etc/xrdp/xrdp.ini.bak
sudo sed -i 's/3389/3390/g' /etc/xrdp/xrdp.ini
sudo sed -i 's/max_bpp=32/#max_bpp=32\nmax_bpp=128/g' /etc/xrdp/xrdp.ini
sudo sed -i 's/xserverbpp=24/#xserverbpp=24\nxserverbpp=128/g' /etc/xrdp/xrdp.ini
touch ~/.xsessionrc
```

```
export GNOME_SHELL_SESSION_MODE=ubuntu
export XDG_CURRENT_DESKTOP=ubuntu:GNOME
export XDG_DATA_DIRS=/usr/share/ubuntu:/usr/local/share:/usr/share:/var/lib/snapd/desktop
export WAYLAND_DISPLAY=
export XDG_CONFIG_DIRS=/etc/xdg/xdg-ubuntu:/etc/xdg
```

```
sudo apt install -y ubuntu-desktop-minimal # or ubuntu-desktop
sudo systemctl restart xrdp
```

## VirtualBoxの右上に出てくる通知センターを消す

https://www.reddit.com/r/virtualbox/comments/y5lr8x/virtualbox_70_disable_notification_center/

すでに設定をいじっていたらそれを消して、`SuppressMessages`を追加する

```.VirtualBox/VirtualBox.xml.patch
13d12
<       <ExtraDataItem name="GUI/NotificationCenter/Alignment" value="Bottom"/>
16a16
>       <ExtraDataItem name="GUI/SuppressMessages" value="confirmGoingFullscreen,remindAboutMouseIntegration,remindAboutAutoCapture"/>

```

`<ExtraDataItem name="GUI/NotificationCenter/Order" value=""/>`もあるらしい

## VirtualBoxのVRAMを256MBまで増やす

GUIでは128MBまでしか設定できない。

https://askubuntu.com/questions/587083/virtualbox-how-to-increase-video-memory

```
> VBoxManage modifyvm "Name of VM" --vram 256
```

ただし、3Dアクセラレーションを利用する場合はホストのVRAMがパススルーされるので、VRAMを増やしてもおいしくないらしい。

## VirtualBoxのディスクイメージの履歴をクリアする

削除したISOがいつまでも表示されてうっとおしい。

https://forums.virtualbox.org/viewtopic.php?t=78320

```
> .\vboxmanage.exe setextradata global "GUI/RecentListCD"
```

`vboxmanage`等のコマンドの使い方わからん。

## MSYS2でddrescueのビルド

https://www.gnu.org/software/ddrescue/

現時点ではv1.28まで出ている。http://ftpmirror.gnu.org/ddrescue/

- `lzip`
- `base-devel`
- `gcc`

`mingw-*`ではない。あくまでMSYS2上で動かすものなので。

```
$ wget http://ftpmirror.gnu.org/ddrescue/ddrescue-1.28.tar.lz
$ tar xvf ddrescue-1.28.tar.lz
$ cd ddrescue-1.28
$ ./configure
$ make
$ make install
$ ddrescue --version
```

## tmux

ぼちぼち使い方を覚えようの会

- 左右に分割 <kbd>Ctrl</kbd>+<kbd>b</kbd>, <kbd>%</kbd> `tmux split-window -h`
- 上下に分割 <kbd>Ctrl</kbd>+<kbd>b</kbd>, <kbd>"</kbd> `tmux split-window -v`

## GNU Screen 4.9.1のビルド

https://qiita.com/jp_yen/items/443f29945a154555745c

#### screen.c.patch

```diff
1116a1117
> #ifndef __MSYS__
1118a1120
> #endif
1152a1155
> #ifndef __MSYS__
1154a1158
> #endif
```

## C言語の規格書

https://stackoverflow.com/questions/17014835/where-can-one-find-the-c89-c90-standards-in-pdf-format

## MSYS2シェル内でvimを開くとき

MSYS2にもVimを入れているけど、こっちのVimはLSPと相性が悪い（LSPの中にはMSYS2形式のパスを食わないものがいる・MSYS2にもNodeが必要・など）

Windows用VimをMSYS2から起動することはできるが、HOME環境変数を参照するため、Vimを直接起動したときとは違うvimrcを参照してしまう。この挙動はしゃらくさくて、MSYS2で開くと`~/.vimrc`Windowsでは`%USERPROFILE%\_vimrc`を開いてくる

ので、HOMEを無効にしつつWindows用vimを開きたい。

```
$ env -u HOME /c/Program\ Files/Vim/vim91/vim.exe

$ alias vim="env -u HOME /c/Program\ Files/Vim/vim91/vim.exe"
```

## PythonスクリプトでGUIのファイル選択ウィンドウを出す

基本はコマンドライン引数や設定ファイル越しに渡すべきであんまり筋のよいやり方ではないと思うけど、アプリケーションに組み込まれたスクリプトエンジンなどでどうしても必要な時がある。

https://docs.python.org/3/library/dialog.html#module-tkinter.filedialog

## Ghostscriptの`inkcov`と`ink_cov`

https://ghostscript.readthedocs.io/en/latest/Devices.html#ink-coverage-output

「全体をC50で塗りつぶしたとき、`inkcov`は100%、`ink_cov`は50%を返す」

```
gs -dSAFER -dNOPAUSE -dBATCH -o- -sDEVICE=inkcov Y.pdf
gs -dSAFER -dNOPAUSE -dBATCH -o- -sDEVICE=ink_cov Y.pdf
```

## JapanColor2001Coated.icc

https://www.adobe.com/support/downloads/iccprofiles/iccprofiles_win.html

https://wiki.scribus.net/canvas/Getting_and_installing_ICC_profiles の`Getting and installing additional ICC profiles`に書いてあった

## qpdf

~~~
qpdf --decrypt input.pdf output.pdf
~~~

https://github.com/qpdf/qpdf

## PlatformIO+Arduino-Picoの更新

https://arduino-pico.readthedocs.io/en/latest/platformio.html#deprecation-warnings

```
> pio pkg update --global --platform https://github.com/maxgerhardt/platform-raspberrypi.git
```

## プライベートなnpmパッケージ

https://blog.pinkumohikan.com/entry/set-unlicensed-to-license-field-when-private-product

```
"license": "UNLICENSED",
"private": "true"
```

## メモリ上のELFバイナリを実行するPythonコード

```python
import ctypes


_libc = ctypes.CDLL("libc.so.6", use_errno=True)

_libc.memfd_create.argtypes = [ctypes.c_char_p, ctypes.c_uint]
_libc.memfd_create.restype = ctypes.c_int


def memfd_create(name: str, flags: int):
    """
    `int memfd_create(const char *name, unsigned int flags);`
    """
    fd = _libc.memfd_create(name.encode("utf-8"), flags)
    if fd == -1:
        err = ctypes.get_errno()
        raise OSError(err, os.strerror(err))
    return fd


_libc.fexecve.argtypes = [
    ctypes.c_int,
    ctypes.POINTER(ctypes.c_char_p),
    ctypes.POINTER(ctypes.c_char_p),
]
_libc.fexecve.restype = ctypes.c_int


def fexecve(fd: int, argv: typing.Collection[str], envp: typing.Collection[str]):
    """
    `int fexecve(int fd, char *const argv[], char *const envp[]);`
    """
    argc = (ctypes.c_char_p * (len(argv) + 1))(
        *[arg.encode("utf-8") for arg in argv] + [None]
    )
    envc = (ctypes.c_char_p * (len(envp) + 1))(
        *[env.encode("utf-8") for env in envp] + [None]
    )

    if _libc.fexecve(fd, argc, envc) == -1:
        err = ctypes.get_errno()
        raise OSError(err, os.strerror(err))


def execute(elf_data: bytes):
    fd = memfd_create("elf_memfd", 0)
    os.write(fd, elf_data)
    try:
        fexecve(fd, ["/proc/self/exe"], os.environ)
    except OSError as e:
        print(f"fexecve failed: {e}")
```

## Realtekの汎用ASIOドライバー

あってしかるべきとは思っていたけど、調べてみたらやっぱりあるらしい。ASIO4ALLよりはマシか？

- https://www.baumannmusic.com/2021/the-official-asio-driver-for-realtek-hd-audio-dell-hp-lenovo-asus/

ここからダウンロードする。DellだがThinkPadにもインストールできた。ほんまかいな。

- https://www.dell.com/support/home/ja-jp/drivers/driversdetails?driverid=7776f

```
$ sha256sum Realtek-High-Definition-Audio-Driver_7776F_WIN_6.0.1.7737_A04_02.EXE
c5051533b798a2ff4da58e746b651243e08f2bf1a1a5bdbca50c2e3b4432c9d9 *Realtek-High-Definition-Audio-Driver_7776F_WIN_6.0.1.7737_A04_02.EXE
```

「INSTALL」ではなく「EXTRACT」を選択。フォルダを作成して収めるような親切なことはしてくれないので、ぶちまけたくなければ新規フォルダを作成して選択すること。

`{展開先}\RealtekHDAudio\ASIO\Install.exe`を実行して、指示に従いインストールする。

## WindowsにおけるPythonのshebang（？）

- https://qiita.com/snipsnipsnip/items/50e4ca88e3ce3f8cffda

ちなみに`py`ランチャーは`#!/usr/bin/python`をいい感じにしてくれるらしい。

- https://docs.python.org/ja/3/using/windows.html#shebang-lines

ここで話題にするのは、バッチファイルにPythonを埋め込みたいという話。

```
@py -x "%~f0" "%*" & exit /b %errorlevel%

import time

print("Hello")
time.sleep(10000)
```

`py(thon) -x`オプションがキモ。1行目を無視してくれる。

```
> py --help | Select-String -CaseSensitive "^-x"

-x     : skip first line of source, allowing use of non-Unix forms of #!cmd
```

引数のクォーテーション周りの挙動が怪しい気もする？とりあえず全部つけておけば問題ないだろうと思っている。

## HTMLの前処理について雑感

### 正規表現ベースの処理

かんたんにルールを差し込める。sedなら一定の移植性もある。VivliostyleならNode.jsでも十分合理的。

Markdown程度の、どのようなHTMLが出力されるか予測できる範囲なら安定性もさほど問題ないはず。

DOMにのっとっておらず、容易にvalidでなくなりうる。

正直なところ抵抗がある。

### DOMベースの処理

「正しい」方法。実装はプログラミングそのもの。

Webブラウザ以外にDOMを十全に操作する方法がない

- Node.js+JSDOM？
  - 追加の依存が　と思ったけど実はVivliostyle CLIはフォークしたJSDOMに依存しているので意外とアリかもしれない
- Node.js+Playwright？
  - 文書にscriptを埋め込むことになり、すべてのスクリプトがVivliostyleからでも正常に実行できるとは限らないので、Vivliostyleで直接組版できなくなる
- Node.jsからシングルバイナリに？
  - なしではないと思うがよく知らない
- Python？
  - 書くのはいいけど特にWindowsでの移植性が著しく低い、セットアップが手間。
  - ほぼ確実にBeautifulSoupに依存するのでvenvの世話も必要
  - とはいえPythonくらい入れとかんかいとは思う。pyランチャーもあり悪くはない
- Pythonからシングルバイナリに？
  - 実際には署名周りでほぼ無理
- C言語で書く？
  - しんどすぎ

## MSYS2のポータブル環境

`shell.cmd`を参照。

## MSYS2 UCRT64でgdome2をビルドする

[gdome2](http://gdome2.cs.unibo.it/)

- http://gdome2.cs.unibo.it/
- https://www.gnu.org/software/gettext/manual/html_node/config_002eguess.html
- https://packages.debian.org/bookworm/libgdome2-0

```
PS > mkdir gdome2
PS > cd .\gdome2\
PS > Invoke-WebRequest -Uri https://github.com/msys2/msys2-installer/releases/download/2024-07-27/msys2-base-x86_64-20240727.sfx.exe -OutFile msys2-base-x86_64-20240727.sfx.exe
PS > .\msys2-base-x86_64-20240727.sfx.exe -y "-o$PWD\"
PS > .\msys64\msys2_shell.cmd -defterm -here -no-start -ucrt64
```

#### build-gdome2.sh

インストール直後に実行した場合`pacman --sync --refresh --sysupgrade --noconfirm`でシステム更新が行われてシェルごと強制終了されるので、再度シェルを起動して実行する。

```bash
#!/bin/bash -eu

pacman --sync --refresh --sysupgrade --noconfirm

pacman --sync --noconfirm \
    base-devel \
    mingw-w64-ucrt-x86_64-autotools \
    mingw-w64-ucrt-x86_64-glib2 \
    mingw-w64-ucrt-x86_64-libxml2 \
    mingw-w64-ucrt-x86_64-toolchain

curl --location --remote-name http://gdome2.cs.unibo.it/tarball/gdome2-0.8.1.tar.gz
tar xvf gdome2-0.8.1.tar.gz gdome2-0.8.1/
cd gdome2-0.8.1/

curl \
    --location --output config.sub 'https://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.sub;hb=HEAD' \
    --location --output config.guess 'https://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.guess;hb=HEAD'
 
curl \
    --location --remote-name https://sources.debian.org/data/main/g/gdome2/0.8.1%2Bdebian-9/debian/patches/01glibconfig.patch \
    --location --remote-name https://sources.debian.org/data/main/g/gdome2/0.8.1%2Bdebian-9/debian/patches/02fix_manpage.patch \
    --location --remote-name https://sources.debian.org/data/main/g/gdome2/0.8.1%2Bdebian-9/debian/patches/03no_glib_1.patch \
    --location --remote-name https://sources.debian.org/data/main/g/gdome2/0.8.1%2Bdebian-9/debian/patches/04bufptr_ftbfs.patch \
    --location --remote-name https://sources.debian.org/data/main/g/gdome2/0.8.1%2Bdebian-9/debian/patches/05gcc10_ftbfs.patch \
    --location --remote-name https://sources.debian.org/data/main/g/gdome2/0.8.1%2Bdebian-9/debian/patches/06libxml2.patch \
    --location --remote-name https://sources.debian.org/data/main/g/gdome2/0.8.1%2Bdebian-9/debian/patches/07test-bench-fputs.patch
for patch in *.patch
do
    patch --strip=1 --binary < "$patch"
done

CFLAGS=-Wno-implicit-int ./configure
CFLAGS=-Wno-implicit-int mingw32-make --jobs=$(nproc)
CFLAGS=-Wno-implicit-int mingw32-make install
```

## CUERipperメモ

http://cue.tools/wiki/Main_Page

2.2.6

- lossless
- image
- flac
- libFLAC
  - Verify: True
  - MD5: True
- C2ErrorMode: Mode296
  - Autoでは`Exception: Error reading CD: IoctlFailed`が発生（PIONEER BD-RW BDR-UD03 1.14）
  - AutoはMode294->Mode296の順番で試行するが、一部ディスクドライブではMode294に対応していないようだ https://hydrogenaud.io/index.php/topic,122176.0.html
- 667（おまかせ）
- Mode: 8
- Paranoid

## PDFから「しおり」を抽出

```
$ pdftk book.pdf dump_data | grep -E 'BookmarkTitle' | python3 -c "import sys, html; [print(html.unescape(line.strip())) for line in sys.stdin]" | grep -E '第[0-9]+章'
```

日本語だとエンコードされてしまうから、Pythonを挟むのが肝

## PDFをPNGに変換

- 背景透過なら`-sDEVICE=pngalpha`
- 全ページなら`-dFirstPage`/`-dLastPage`を削除

```
$ gs \
    -dBATCH \
    -dNOPAUSE \
    -dSAFER \
    -sDEVICE=png16m \
    -r300 \
    -dFirstPage=128 \
    -dLastPage=128 \
    -sOutputFile=page_%03d.png \
    input.pdf
```

## 白背景を詰める

trimのアルゴリズムの都合、全体が背景色以外で囲われている場合、その枠が削除されてしまう。

https://qiita.com/yoya/items/62879e6e03d5a70eed09

```
$ magick input.png -bordercolor white -border 1x1 -trim +repage output.png
```

## 基本的にDocker内で使っているツール類

GUIが必要な時は`--env "DISPLAY=${DISPLAY:-:0.0} --volume /mnt/wslg/.X11-unix/:/tmp/.X11-unix`（WSL）

- https://qiita.com/U-1F992/items/c75ffa7373a49d216862

### Ghostscript

```
$ docker run \
    --entrypoint /usr/bin/gs \
    --interactive \
    --mount type=bind,source=$(pwd),target=/workdir \
    --rm \
    --tty \
    --user $(id -u):$(id -g) \
    --workdir /workdir \
    registry.gitlab.com/islandoftex/images/texlive:TL2023-historic
```

### ImageMagick

```
$ docker run \
    --entrypoint /usr/local/bin/magick \
    --interactive \
    --mount type=bind,source=$(pwd),target=/workdir \
    --rm \
    --tty \
    --user $(id -u):$(id -g) \
    --workdir /workdir \
    dpokidov/imagemagick:7.1.1-39
```

## `*.ai` → `*.pdf`

アウトライン化されていたら多分大丈夫

```
$ gs \
    -dBATCH \
    -dNOPAUSE \
    -dSAFER \
    -sDEVICE=pdfwrite \
    -dCompatibilityLevel=1.4 \
    -dPDFSETTINGS=/prepress \
    -sOutputFile=output.pdf \
    input.ai
```

## CSS `rgb()`の小数点数を特定要素に設定する

Chromiumにおいて、[`rgb()`](https://developer.mozilla.org/ja/docs/Web/CSS/color_value/rgb)関数は小数点数も受け付けるし、PDF出力にもちゃんと反映されるけど、特定要素のスタイルとして設定する場合には<code>elem.setAttribute("style", &#96;${elem.getAttribute("style")}; background-color: rgb(0 0.1 0.2);&#96;)</code>としなければ丸められてしまう。

[村上さん](https://github.com/vivliostyle/vivliostyle.js/issues/1432#issuecomment-2552691859)によれば、丸める挙動は好ましくはないけどバグとは言えないらしい。

> The precision with which sRGB component values are retained, and thus the number of significant figures in the serialized value, is not defined in this specification, but must at least be sufficient to round-trip eight bit values. Values must be rounded towards +∞, not truncated. ――https://drafts.csswg.org/css-color-4/#css-serialization-of-srgb

```
> python main.py
elem_style_setProperty
 0 0 0 rg
---
elem_style_backgroundColor
 0 0 0 rg
---
elem_style[backgroundColor]
 0 0 0 rg
---
elem_getAttribute_setAttribute
 0 0.000400 0.000800 rg
---
```

<details>
<summary>main.py</summary>

```py
import os
import pathlib
import subprocess

from playwright.sync_api import sync_playwright


def generate_pdf(html_content: str, script: str, output: pathlib.Path):
    with (
        sync_playwright() as playwright,
        playwright.chromium.launch(headless=False) as browser,
        browser.new_context() as context,
        context.new_page() as page,
    ):
        page.set_content(html_content)
        page.evaluate(script)
        # input("press enter")
        page.pdf(path=output, print_background=True)


def extract_rgb_fill_from_pdf(pdf_path: pathlib.Path) -> str:
    return "\n".join(
        [
            line
            for line in subprocess.run(
                [
                    "gswin64c",
                    "-dPDFDEBUG",
                    "-dBATCH",
                    "-dNOPAUSE",
                    "-sDEVICE=nullpage",
                    str(pdf_path),
                ],
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                text=True,
            ).stderr.splitlines()
            if " rg" in line
        ]
    )


def main():
    cwd = pathlib.Path.cwd()

    html_content = """
<html>
  <body>
    <div
      id="elem"
      style="display: inline-block; width: 100px; height: 100px"
    ></div>
  </body>
</html>
"""

    for title, script in (
        (
            "elem_style_setProperty",
            'document.getElementById("elem").style.setProperty("background-color", "rgb(0 0.1 0.2)");',
        ),
        (
            "elem_style_backgroundColor",
            'document.getElementById("elem").style.backgroundColor = "rgb(0 0.1 0.2)";',
        ),
        (
            "elem_style[backgroundColor]",
            'document.getElementById("elem").style["backgroundColor"] = "rgb(0 0.1 0.2)";',
        ),
        (
            "elem_getAttribute_setAttribute",
            'const elem = document.getElementById("elem"); elem.setAttribute("style", `${elem.getAttribute("style")}; background-color: rgb(0 0.1 0.2);`);',
        ),
    ):
        print(title)
        output_pdf = cwd.joinpath(f"{title}.pdf")
        try:
            generate_pdf(
                html_content,
                script,
                output_pdf,
            )
            print(extract_rgb_fill_from_pdf(output_pdf))
        finally:
            if output_pdf.exists():
                os.remove(output_pdf)
        print("---")


if __name__ == "__main__":
    main()
```

</details>

## コマンドプロンプトの起動時スクリプト

- https://github.com/Schniz/fnm?tab=readme-ov-file#windows-command-prompt-aka-batch-aka-wincmd
- https://superuser.com/questions/144347/is-there-windows-equivalent-to-the-bashrc-file-in-linux/144348#144348
- https://ss64.com/nt/cmd.html

```
> reg add "HKEY_CURRENT_USER\Software\Microsoft\Command Processor" /v AutoRun /t REG_SZ /d "%USERPROFILE%\autorun.cmd" /f
```

なお初期値は設定なし


## 漢字かな交じり文の読みを調べる（Windows＋Excel）

- https://learn.microsoft.com/en-us/office/vba/api/excel.application.getphonetic

```ts
import fs from "node:fs";

const winax = await (async () => {
  try {
    return (await import("winax")).default;
  } catch {
    return null;
  }
})();

function withCache(fn: (input: string) => string, cacheFile: string) {
  return (input: string) => {
    const cache = (() => {
      try {
        const parsed = JSON.parse(
          fs.readFileSync(cacheFile, {
            encoding: "utf-8",
          }),
        );
        return parsed && typeof parsed === "object" ? parsed : {};
      } catch {
        return {};
      }
    })() as Record<string, any>;
    if (input in cache) {
      return cache[input];
    }
    cache[input] = fn(input);
    fs.writeFileSync(cacheFile, JSON.stringify(cache), {
      encoding: "utf-8",
    });
    return cache[input];
  };
}

function excelGetPhonetic(input: string) {
  if (winax === null) {
    return input;
  }
  try {
    const excel = new winax.Object("Excel.Application");
    try {
      return excel.GetPhonetic(input) as string;
    } catch {
      return input;
    } finally {
      excel.Quit();
      winax.release(excel);
    }
  } catch {
    return input;
  }
}

console.log(withCache(excelGetPhonetic, "cache.json")("寿限無"));
```

## SVGの`text`要素のアウトライン化と選択・検索を両立させる

OSはWindows、WebブラウザはGoogle Chrome 132.0.6834.160、SVG編集の説明はInkscape 1.4 (86a8ad7, 2024-10-11)を前提としています。

SVGをWebブラウザで開くとき、特に禁止しない限り`text`要素のテキストは選択および検索が可能です。

<figure><figcaption><code>text</code>要素を含むSVG</figcaption><img src="text.svg"></figure>

<figure><figcaption>Webブラウザでテキストを選択</figcaption><img src="text-select.png"></figure>

SVGをWebブラウザで表示すると、特に制限を設けない限り、text要素のテキストは選択や検索が可能です。

しかし、指定されたフォントが利用できない場合、正しく表示されないことがあります。特殊なフォントを使用する部分やデザイン性を重視する箇所では、アウトライン化することで意図したデザインを維持できます。

1. ［レイヤー＞レイヤーとオブジェクト］
2. 出現したパネルで対象のテキストオブジェクトを選択
3. ［パス＞オブジェクトをパスへ］

<figure><figcaption><code>text</code>要素をパスに変換したSVG</figcaption><img src="path.svg"></figure>

ただし、単純にアウトライン化するとテキストは選択できなくなります。

素朴な発想として、アウトライン化したパスに不可視のテキストを重ねることで、見える内容は固定しつつテキストを選択可能にできるはずです。パスと元になった`text`要素はグループにまとめておくのがよいでしょう。

1. ［オブジェクト＞グループ化］
2. 「レイヤーとオブジェクト」パネルで、グループ内に移動したテキストオブジェクトを選択
3. ［（右クリック）＞複製］
4. 上にあるほうを選択して［パス＞オブジェクトをパスへ］（上にあるものが勝つ）

`text`要素を不可視にする方法はいくつか考えられますが、それぞれに制限があります。

まず、`display:none`（「レイヤーとオブジェクト」パネルで目のアイコンをクリック）では、`text`要素を削除してアウトライン化した場合と同様にテキストの選択が無効になります。

<figure>
<figcaption><code>display:none</code></figcaption>
<img src="outline-display-none.svg">
</figure>

続いて、`display`は既定値のまま`opacity: 0`（「レイヤーとオブジェクト」パネルで不透明度を0に設定）にする場合は、選択は可能ですが選択範囲が表示されなくなります。

<figure>
<figcaption><code>opacity: 0</code></figcaption>
<img src="outline-opacity-0.svg">
</figure>

試しに50%程度に設定すると、選択範囲のハイライトの不透明度もオブジェクトの不透明度に従うことが分かります。

<figure>
<figcaption><code>opacity: 50</code></figcaption>
<img src="outline-opacity-50.svg">
</figure>

<figure>
<figcaption>冒頭の画像より明らかに薄い</figcaption>
<img src="outline-opacity-50-select.png">
</figure>

`fill-opacity: 0`であれば、`text`要素を不可視にしつつ選択範囲のハイライトを維持できました。InkscapeのUIからはこの設定ができないため、［編集＞XMLエディタ］を開き、`text`要素の`style`に`fill-opacity: 0`を手動で加えてください。

<figure>
<figcaption><code>fill-opacity: 0</code></figcaption>
<img src="outline-fill-opacity-0.svg">
</figure>

DevToolsで`path`要素を削除すれば、確かに`text`要素は透明になっていることが分かります。

<figure>
<figcaption>透明な文字も検索にはヒットする</figcaption>
<img src="outline-fill-opacity-0-search.png">
</figure>

## ディスクのフルバックアップイメージをマウントする

```
$ mkdir -p /path/to/mount
$ kpartx -av /path/to/hdd.img
$ mount -o ro /dev/mapper/loop0pX /path/to/mount
```

### アンマウント手順

```
$ umount /path/to/mount
$ kpartx -d /path/to/hdd.img
$ rm -rf /path/to/mount
```

## AppImageをランチャーに追加する（Ubuntu 24.04）

```
$ mv foobar.AppImage ~/.local/bin/foobar
$ cd ~/.local/bin/foobar
$ chmod +x foobar
$ foobar --appimage-extract
$ cp squashfs-root/foobar.desktop ~/.local/share/applications/
$ chmod +x ~/.local/share/applications/foobar.desktop
$ cp squashfs-root/foobar.png ~/.local/share/applications/
$ rm -rf squashfs-root
```

- もとのAppImageより`squashfs-root`を残したほうがいい？
- `*.desktop`には実行権限が必要
- `*.desktop`が正しい`Exec`/`Icon`を指しているか確認する。
  - `Exec`はパスが通っていればコマンド名でいい
  - `Icon`は絶対パスで指定


## RDPメモ

- https://github.com/stascorp/rdpwrap
- https://github.com/sebaxakerhtc/rdpwrap.ini
- https://qiita.com/nak435/items/800dbda782f4fe9c7df1

```
PS > Set-Location Download
PS > Invoke-WebRequest -Uri https://github.com/stascorp/rdpwrap/releases/download/v1.6.2/RDPWrap-v1.6.2.zip -OutFile RDPWrap-v1.6.2.zip
PS > Expand-Archive -Path RDPWrap-v1.6.2.zip -DestinationPath ..\RDPWrap-v1.6.2
PS > Remove-Item .\RDPWrap-v1.6.2.zip
PS > Set-Location ..\RDPWrap-v1.6.2
PS > New-Item -Type Directory rdpwrap.ini.backup
PS > Invoke-WebRequest -Uri https://raw.githubusercontent.com/sebaxakerhtc/rdpwrap.ini/7c699d5bc5adde603e4d12b68b24a2d234b68eb5/rdpwrap.ini -OutFile rdpwrap.ini.backup/rdpwrap.ini.7c699d5bc5adde603e4d12b68b24a2d234b68eb5
PS > sudo .\install.bat
...
OK

[+] Successfully installed.
______________________________________________________________

You can check RDP functionality with RDPCheck program.
Also you can configure advanced settings with RDPConf program.

続行するには何かキーを押してください . . .
PS > sudo .\update.bat
RDP Wrapper Library v1.6.2
Installer v2.5
Copyright (C) Stas'M Corp. 2017

[*] Checking for updates...
[*] Current update date: 2018.10.10
[*] Latest update date:  2018.10.10
[*] Everything is up to date.

続行するには何かキーを押してください . . .
PS > sudo net stop termservice
Remote Desktop Services サービスを停止中です.
Remote Desktop Services サービスは正常に停止されました。

PS > Copy-Item 'C:\Program Files\RDP Wrapper\rdpwrap.ini' .\rdpwrap.ini.backup\
PS > sudo pwsh -Command "Copy-Item .\rdpwrap.ini.backup\rdpwrap.ini.7c699d5bc5adde603e4d12b68b24a2d234b68eb5 'C:\Program Files\RDP Wrapper\rdpwrap.ini'"
PS > sudo net start termservice
Remote Desktop Services サービスを開始します.
Remote Desktop Services サービスは正常に開始されました。

PS > .\RDPConf.exe
```

`Listener state: Listening`を確認

```
PS > (Invoke-WebRequest -Uri 'https://api64.ipify.org').Content
```

## `text-box`メモ

```json
  "scripts": {
    "install:browser":"node -e \"process.env.PLAYWRIGHT_BROWSERS_PATH='.playwright';const {spawnSync}=require('child_process');const opts={shell:true,stdio:'inherit'};spawnSync('npx',['playwright','install-deps'],opts);spawnSync('npx',['playwright','install'],opts)\"",
    "vivliostyle":"node -e \"const {spawnSync}=require('child_process');const opts={shell:true,stdio:'inherit'};const fs=require('fs');const path=require('path');spawnSync('npx',['vivliostyle',...process.argv.slice(1),'--executable-browser',(function find(dir){return fs.readdirSync(dir,{withFileTypes:true}).flatMap(entry=>{const fullPath=path.join(dir,entry.name);return entry.isDirectory()?find(fullPath):path.basename(entry.name, path.extname(entry.name)).toLowerCase()==='chrome'&&(process.platform==='win32'?process.env.PATHEXT.split(path.delimiter).map(ext=>ext.toUpperCase()).includes(path.extname(fullPath).toUpperCase()):(fs.statSync(fullPath).mode&0o111)!==0)?[fullPath]:[];});})('.playwright')[0]],opts)\""
  },
```

`package-lock.json`をいじって`npm ci`でも良いかも。

<table>
<tr><td></td><td></td><th colspan="3">直前</th></tr>
<tr><td></td><td></td><th><code>p</code></th><th><code>p</code>以外</th><th>なし</th></tr>
<tr><th rowspan="3">直後</th><th><code>p</code></th><td><code>none</code></td><td><code>trim-start</code></td><td><code>trim-start</code></td></tr>
<tr><th><code>p</code>以外</th><td><code>trim-end</code></td><td><code>trim-both</code></td><td><code>trim-both</code></td></tr>
<tr><th>なし</th><td><code>trim-end</code></td><td><code>trim-both</code></td><td><code>trim-both</code></td></tr>
</table>

こんな感じか……？

```css
p {
    margin: 0;
    text-align: justify;
    text-indent: 1em;
    text-spacing: auto;
    widows: 1;
    orphans: 1;
}

p:first-child:has(+ p), /* コンテナの先頭かつ直後がpである */
:not(p) + p:has(+ p) {  /* 直前にp以外を持ち、かつ直後がpである */
    color: red;
    text-box: trim-start cap alphabetic;
}

p + p:has(+ :not(p)), /* 直前がpであり、かつ直後がp以外である */
p + p:last-child {    /* 直前がpであり、かつコンテナの最後の要素である */
    color: green;
    text-box: trim-end cap alphabetic;
}

:not(p) + p:has(+ :not(p)),/* 前後がpではない */
:not(p) + p:last-child {   /* 直前がpではなく、かつコンテナの最後である */
    color: aqua;
    text-box: trim-both cap alphabetic;
}
```

## トラックポイントキャップを買い換える

https://www.lenovo.com/jp/ja/dc/accessories-and-software/keyboards-and-mice/trackpoint-caps/

3種類ある

- Low Profile
- ロープロファイル
- スーパーロープロファイル

1つ目と2つ目の違いは？

どれに該当するかは以下で検索

https://support.lenovo.com/jp/ja/accessorieslookup

| 品番 | プロファイル |
| --- | --- |
| 20KG | スーパーロープロファイル |
| 20QE | ロープロファイル |
| 21KC | ロープロファイル |

参照：https://support.lenovo.com/jp/ja/solutions/um006391-accessories-and-options-compatibility-matrix-ocm

## Native Accessのアップデートを阻止する

Native Access 3.7.0ならWineで起動できそうだ。

- https://appdb.winehq.org/objectManager.php?sClass=application&iId=19265

<details>

<!-- timestamp: 20231125121751 -->

- おおむね書いてある通りの操作で実行できた（Ubuntu 24.04 / wine-9.21 (Staging)）。手間取って以下の試行錯誤をしたが、順番通りに行えばおそらく不要だった。
  - `~/.local/share/applications/Native\ Access.desktop`の末尾に`MimeType=x-scheme-handler/native-access`を追記した
  - `update-desktop-database ~/.local/share/applications/`を実行した
  - `xdg-mime query default x-scheme-handler/native-access`で正しく登録されているかわかる
- 執筆時点の最新版である3.17.0は、3.7.0のコメントにある通りwinetricksでvcrun2022をインストールすれば起動した。
  - 別途ダウンロード方式のライブラリを追加する際に「Could not add library」と表示され追加できないため断念した。
- Kontakt 8 Playerはインストールできないようだ。デバッグログを見たら何かわかるか？
  - この症状 https://www.reddit.com/r/winehq/comments/1hyev6y/im_trying_to_install_native_instruments_kontakt_8/
- 7も厳しいかも。Native Accessでlocate済みのライブラリを読み込まない（yabridge 5.1.1）。よそでは動作しているらしいので要検証

</details>

ということで勝手にバージョンが上がってほしくない。当て勘で関連ファイルを漁ってみたところ、この`updaterCacheDirName`ディレクトリが臭う。

```
$ cat ~/.wineprefixes/Native-Access_2_3.7.0/drive_c/Program\ Files/Native\ Instruments/Native\ Access/resources/app-update.yml 
provider: generic
channel: latest
url: https://na-update.native-instruments.com
updaterCacheDirName: nativeaccess2-updater
```

旧バージョンを起動しているとウィンドウ右上にアップデートを促すメッセージが出現する。

![アップデートを促すメッセージ](image-000.png)

この状態で、`updaterCacheDirName`を探してみる。

```
$ find ~/.wineprefixes/Native-Access_2_3.7.0/drive_c/ -name nativeaccess2-updater
/home/mukai/.wineprefixes/Native-Access_2_3.7.0/drive_c/users/mukai/AppData/Local/nativeaccess2-updater

$ tree ~/.wineprefixes/Native-Access_2_3.7.0/drive_c/users/mukai/AppData/Local/nativeaccess2-updater
/home/mukai/.wineprefixes/Native-Access_2_3.7.0/drive_c/users/mukai/AppData/Local/nativeaccess2-updater
└── pending
    ├── Native-Access.exe
    └── update-info.json

2 directories, 2 files
```

消してみる。

```
$ rm -rf ~/.wineprefixes/Native-Access_2_3.7.0/drive_c/users/mukai/AppData/Local/nativeaccess2-updater
```

Native Accessを［x］で終了して再度起動すると、目論見通りアップデートされずに保たれているようだ。

![バージョンは3.7.0](image-001.png)

書き込み・削除禁止にしておけばよいはず。

```
$ mkdir -p ~/.wineprefixes/Native-Access_2_3.7.0/drive_c/users/mukai/AppData/Local/nativeaccess2-updater
$ sudo chattr +i ~/.wineprefixes/Native-Access_2_3.7.0/drive_c/users/mukai/AppData/Local/nativeaccess2-updater
```

さすがにディレクトリを変えたりするほど器用ではないらしい。
