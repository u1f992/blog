## ふつうのPCにSPIを生やす

Linux 6.11以降では[CH341](https://www.wch-ic.com/products/CH341.html)のUSB-SPIドライバがメインラインに入っています。CH341は以下のような形で安価に入手できます。ROMライターとしてよく知られているようですが、本来は汎用USBシリアル変換チップです。私が今回入手したのは「LC-Technology」と紹介されているタイプの基板です（青色のレジスト、3つのジャンパー、ピンヘッダが立っている）。とはいえこの手の中華デバイスにはオリジナルもなにもあったものではないので、目視による推測です。

- https://www.onetransistor.eu/2017/08/ch341a-mini-programmer-schematic.html

```
$ modinfo spi-ch341
filename:       /lib/modules/6.14.0-32-generic/kernel/drivers/spi/spi-ch341.ko.zst
license:        GPL v2
description:    QiHeng Electronics ch341 USB2SPI
author:         Johannes Thumshirn <jth@kernel.org>
srcversion:     E74FE6A9627C21DFF854C65
alias:          usb:v1A86p5512d*dc*dsc*dp*ic*isc*ip*in*
depends:        
intree:         Y
name:           spi_ch341
retpoline:      Y
vermagic:       6.14.0-32-generic SMP preempt mod_unload modversions 
sig_id:         PKCS#7
signer:         Build time autogenerated kernel key
sig_key:        5F:EE:1C:D6:B4:4A:1B:A4:E2:40:64:B5:F8:EE:E8:60:D9:43:0A:32
sig_hashalgo:   sha512
signature:      84:AB:CD:5C:3B:72:43:5F:A6:BC:E8:BB:1D:D0:A0:B4:40:11:E5:B2:
                ...
```

デバイスを接続すると自動でモジュールがロードされます。

```
$ lsmod | grep spi_ch341
（出力なし）
$ ls -l /sys/class/spi_master
合計 0
lrwxrwxrwx 1 root root 0 10月  4 12:45 spi0 -> ../../devices/pci0000:00/0000:00:1f.5/spi_master/spi0
```

```
$ lsmod | grep spi_ch341
spi_ch341              16384  0
$ ls -l /sys/class/spi_master
合計 0
lrwxrwxrwx 1 root root 0 10月  4 12:45 spi0 -> ../../devices/pci0000:00/0000:00:1f.5/spi_master/spi0
lrwxrwxrwx 1 root root 0 10月  4 15:53 spi1 -> ../../devices/pci0000:00/0000:00:14.0/usb1/1-9/1-9.4/spi_master/spi1
```

ここでは`spi1`として認識されました。`/dev/spidev*`にバインドしてやります。

```
$ sudo modprobe spidev
$ BUS=spi1
$ echo $BUS.0  | sudo tee /sys/bus/spi/drivers/spidev/bind
$ ls -l /dev/spidev*
crw------- 1 root root 153, 0 10月  4 16:52 /dev/spidev1.0
```

<details>
<summary>`driver_override`を使う場合</summary>

[サードパーティのI<sup>2</sup>C](https://github.com/gschorcht/i2c-ch341-usb)と併用する場合に`driver_override`を使うとよい？

```
$ echo spidev | sudo tee /sys/bus/spi/devices/$BUS.0/driver_override
$ sudo modprobe spidev
```

`driver_override`は用が済んだら空文字でクリアする。

```
$ echo "" | sudo tee /sys/bus/spi/devices/$BUS.0/driver_override
```

</details>
<details>
<summary>切断からの再接続</summary>

```
$ lsmod | grep spidev
spidev                 28672  0
$ echo spidev | sudo tee /sys/bus/spi/devices/spi1.0/driver_override
$ echo spi1.0 | sudo tee /sys/bus/spi/drivers_probe
$ echo "" | sudo tee /sys/bus/spi/devices/spi1.0/driver_override
$ ls -l /dev/spidev*
crw-rw---- 1 root spi 153, 0 10月  4 17:38 /dev/spidev1.0
```

</details>

一般ユーザーが`/dev/spidev*`に触れられるようにudevルールを作成します。

```
$ echo 'KERNEL=="spidev*", GROUP="spi", MODE="0660"' | sudo tee /etc/udev/rules.d/99-spidev.rules
$ sudo groupadd -f spi
$ sudo usermod -aG spi "$USER"
$ newgrp spi
$ sudo udevadm control --reload-rules
$ sudo udevadm trigger
$ ls -l /dev/spidev*
crw-rw---- 1 root spi 153, 0 10月  4 17:21 /dev/spidev1.0
```

```
$ sudo apt-get install -y python3-dev build-essential
$ uv run --with spidev python
Python 3.12.3 (main, Aug 14 2025, 17:47:21) [GCC 13.3.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import spidev
>>> spi = spidev.SpiDev()
>>> spi.open_path("/dev/spidev1.0")
>>> spi.xfer2([0b00001000, 0x00, 0x00,0x00])
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
TimeoutError: [Errno 110] Connection timed out
```

<details>
<summary>dmesgの該当箇所</summary>

```
[38012.768218] usb 1-9.4: new full-speed USB device number 39 using xhci_hcd
[38012.904008] usb 1-9.4: New USB device found, idVendor=1a86, idProduct=5512, bcdDevice= 3.04
[38012.904011] usb 1-9.4: New USB device strings: Mfr=0, Product=2, SerialNumber=0
[38012.904012] usb 1-9.4: Product: USB UART-LPT
[38117.227614] spidev spi1.0: SPI transfer failed: -110
[38117.227728] spi_master spi1: failed to transfer one message from queue
[38117.227730] spi_master spi1: noqueue transfer failed
```

</details>
<details>
<summary>usbmonログ</summary>

```
$ sudo modprobe usbmon
$ DEVPATH=/sys/bus/usb/devices/1-9.4
$ BUS=$(cat $DEVPATH/busnum)
$ DEV=$(cat $DEVPATH/devnum)
$ printf "BUS=%s DEV=%s (node=/dev/bus/usb/%03d/%03d)\n" "$BUS" "$DEV" "$BUS" "$DEV"
BUS=1 DEV=49 (node=/dev/bus/usb/001/049)
$ sudo stdbuf -oL cat /sys/kernel/debug/usb/usbmon/1t | grep 49:
ffff89f494e4b8c0 3966319029 S Bo:049:02 -115 3 = abb720
ffff89f494e4b8c0 3966319098 C Bo:049:02 0 3 >
ffff89f494e4b8c0 3966319131 S Bo:049:02 -115 5 = a8080000 00
ffff89f494e4b8c0 3966319204 C Bo:049:02 0 5 >
ffff89f494e4b8c0 3966319251 S Bi:049:02 -115 4 <
ffff89f38127d740 3966319279 C Bi:049:02 0 4 = 08000000
ffff89f494e4b8c0 3967351189 C Bi:049:02 -2 0
ffff89f494e4b8c0 3967351242 S Bo:049:02 -115 4 = abb67f20
ffff89f494e4b8c0 3967351303 C Bo:049:02 0 4 >
^C
```

</details>

原因がわからない。一旦ユーザーランド実装に切り替えてみる。

- https://github.com/dimich-dmb/spi-ch341-usb

既存モジュールが読み込まれないようにする

```
sudo modprobe -r spi_ch341
echo "blacklist spi_ch341" | sudo tee /etc/modprobe.d/blacklist-spi_ch341.conf
sudo depmod -a
```

デバイスを差し直し、読み込まれなくなったことを確認する

```
$ lsmod | grep spi_ch341
（出力なし）
```

```
cd ~/Documents
git clone https://github.com/dimich-dmb/spi-ch341-usb.git
cd spi-ch341-usb
$ sudo apt-get install linux-headers-$(uname -r) dkms
$ make
$ sudo make install
```

```
$ sudo modprobe spi-ch341-usb
```

差し直して確認

```
$ sudo dmesg | tail -n 10
[49639.440878] spi-ch341-usb 1-9.4:1.0: ch341_cfg_probe: output cs0 SPI slave with cs=0
[49639.440881] spi-ch341-usb 1-9.4:1.0: ch341_cfg_probe: output cs1 SPI slave with cs=1
[49639.440882] spi-ch341-usb 1-9.4:1.0: ch341_cfg_probe: output cs2 SPI slave with cs=2
[49639.440883] spi-ch341-usb 1-9.4:1.0: ch341_cfg_probe: input  gpio4 gpio=0 irq=0 (hwirq)
[49639.440884] spi-ch341-usb 1-9.4:1.0: ch341_cfg_probe: input  gpio5 gpio=1 irq=1 
[49639.441053] spi-ch341-usb 1-9.4:1.0: ch341_spi_probe: SPI master connected to SPI bus 1
[49639.441182] spi-ch341-usb 1-9.4:1.0: ch341_spi_probe: SPI device /dev/spidev1.0 created
[49639.441206] spi-ch341-usb 1-9.4:1.0: ch341_spi_probe: SPI device /dev/spidev1.1 created
[49639.441237] spi-ch341-usb 1-9.4:1.0: ch341_spi_probe: SPI device /dev/spidev1.2 created
[49639.441428] spi-ch341-usb 1-9.4:1.0: ch341_usb_probe: connected
$ ls /dev/spidev*
ls: '/dev/spidev*' にアクセスできません: そのようなファイルやディレクトリはありません
```

成功しているようなメッセージだが実際には`/dev/spidev*`が作成されていない。こちらにはあるから、カーネルとしては認識しているのだろう。

```
$ ls -l /sys/class/spi_master/spi1/
合計 0
lrwxrwxrwx 1 root root    0 10月  5 02:34 device -> ../../../1-9.4:1.0
drwxr-xr-x 2 root root    0 10月  5 02:34 power
drwxr-xr-x 4 root root    0 10月  5 02:32 spi1.0
drwxr-xr-x 4 root root    0 10月  5 02:32 spi1.1
drwxr-xr-x 4 root root    0 10月  5 02:32 spi1.2
drwxr-xr-x 2 root root    0 10月  5 02:34 statistics
lrwxrwxrwx 1 root root    0 10月  5 02:32 subsystem -> ../../../../../../../../../class/spi_master
-rw-r--r-- 1 root root 4096 10月  5 02:32 uevent
```

`/sys/class/spidev`を監視して`/dev/spidev*`を作るルールのはず。

```
$ ls /sys/class/spidev
（出力なし）
```

じゃあspidevモジュールがロードされていない？

```
$ lsmod | grep spidev
spidev                 28672  0
```

されている。手動で作ればよいのだろうか？

```
$ DEV=spi1.0
$ echo spidev | sudo tee /sys/bus/spi/devices/$DEV/driver_override >/dev/null
$ echo $DEV | sudo tee /sys/bus/spi/drivers/spidev/bind >/dev/null
$ echo "" | sudo tee /sys/bus/spi/devices/$DEV/driver_override >/dev/null
$ ls -l /dev/spidev*
crw-rw---- 1 root spi 153, 0 10月  5 02:42 /dev/spidev1.0
```

Pythonでテスト。

```
$ uv run --with spidev python
Python 3.12.3 (main, Aug 14 2025, 17:47:21) [GCC 13.3.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import spidev
>>> spi = spidev.SpiDev()
>>> spi.open_path("/dev/spidev1.0")
>>> spi.xfer2([0b00001000, 0x00, 0x00,0x00])
[8, 0, 0, 0]
```

通った。じゃあメインラインのドライバが悪かったのか……？

```
$ cat mcp42u83-shunt.py 
import time
import spidev

spi = spidev.SpiDev()
spi.open(1, 0)

while True:
    for value in range(0x000, 0x400):
        spi.writebytes([0b00001000, (value >> 8) & 0x03, value & 0xff])
        time.sleep(0.001)
    for value in range(0x3FF, -1, -1):
        spi.writebytes([0b00001000, (value >> 8) & 0x03, value & 0xff])
        time.sleep(0.001)
$ uv run --with spidev mcp42u83-shunt.py 
```

